---
output:
  html_document: default
  word_document: default
  pdf_document: default
---

ï..

ï..
#switch to the editor
icAH analysis - data received October 2020

To start, put this file and the 3 csv files received from Glasgow in the same folder inside windows. 

remove list to start afresh in R - only run this chunk if you want to clear your previous project from rstudio. You can add '#' at the start of any line of code to stop it running
```{r}

#rm(list=ls())
#memory.limit(size= 100000)


```

Please note that not all of these packages are required for this work so far, they are just everything I use
install packages
```{r}
if(!require(sitar)){install.packages("vctrs")}
#library(vctrs)
if(!require(sitar)){install.packages("rsample")}
library(rsample)
if(!require(sitar)){install.packages("sitar")}
library(sitar)

#evtools::install_github("dustinfife/flexplot")
if(!require(rlang)){install.packages("rlang")}
library(rlang)
if(!require(piecewiseSEM)){install.packages("piecewiseSEM")}
library(piecewiseSEM)
if(!require(scales)){install.packages("scales")}
library(scales)
if(!require(nlme)){install.packages("nlme")}
library(nlme)

if(!require(readxl)){install.packages("readxl")}
library(readxl)
if(!require(dplyr)){install.packages("dplyr")}
library(dplyr)
#if(!require(magrittr)){install.packages("magrittr")}
#library(magrittr)
if(!require(mixtools)){install.packages("mixtools")}
library(mixtools)
if(!require(emmeans)){install.packages("emmeans")}
library(emmeans)
if(!require(readr)){install.packages("readr")}
library(readr)
if(!require(tidyverse)){install.packages("tidyverse")}
library(tidyverse)
if(!require(data.table)){install.packages("data.table")}
library(data.table)
if(!require(lubridate)){install.packages("lubridate")}
library(lubridate)
if(!require(ggplot2)){install.packages("ggplot2")}
library(ggplot2)
#if(!require(magrittr)){install.packages("magrittr")}
#library(magrittr)
if(!require(ggpubr)){install.packages("ggpubr")}
library(ggpubr)
if(!require(rstatix)){install.packages("rstatix")}
library(rstatix)
#if(!require(multcomp)){install.packages("multcomp")}
#library(multcomp)
if(!require(multcompView)){install.packages("multcompView")}
library(multcompView)
if(!require(knitr)){install.packages("knitr")}
library(knitr)
#if(!require(devtools)){install.packages("devtools")}
#library(devtools)
if(!require(DT)){install.packages("DT")}
library(DT)
#if(!require(pairwiseCI)){install.packages("pairwiseCI")}
#library(pairwiseCI)
if(!require(extrafont)){install.packages("extrafont")}
library(extrafont)
if(!require(easycsv)){install.packages("easycsv")}
library(easycsv)
if(!require(PairedData)){install.packages("PairedData")}
library(PairedData)
if(!require(compare)){install.packages("compare")}
library(compare)
#if(!require(ggpattern)){install.packages("ggpattern")}
if(!require(pastecs)){install.packages("pastecs")}
library(pastecs)
#if(!require(coin)){install.packages("coin")}
#library(coin)
if(!require(pwr)){install.packages("pwr")}
library(pwr)
if(!require(XLConnect)){install.packages("XLConnect")}
if(!require(gdata)){install.packages("gdata")}
library(gdata)
if(!require(skimr)){install.packages("skimr")}
library(skimr)
#if(!require(ggstatsplot)){install.packages("ggstatsplot")}
#library(ggstatsplot)
if(!require(summarytools)){install.packages("summarytools")}
library(summarytools)
if(!require(GGally)){install.packages("GGally")}
library(GGally)
if(!require(BSDA)){install.packages("BSDA")}
library(BSDA)
if(!requireNamespace("BiocManager", quietly = TRUE))
if(!require(BiocManager)){install.packages("BiocManager")}
#library(limma)
if(!require(ggforce)){install.packages("ggforce")}
library(ggforce)
if(!require(svglite)){install.packages("svglite")}
library(svglite)
if(!require(extrafont)){install.packages("extrafont")}
library(extrafont)
if(!require(devtools)) install.packages("devtools")
if(!require(factoextra)){install.packages("factoextra")}
library(factoextra)
#if(!require(VIM)){install.packages("VIM")}
#library(VIM)
if(!require(naniar)){install.packages("naniar")}
library(naniar)
if(!require(missMDA)){install.packages("missMDA")}
library(missMDA)
if(!require(Amelia)){install.packages("Amelia")}
library(Amelia)
if(!require(mice)){install.packages("mice")}
library(mice)
if(!require(missForest)){install.packages("missForest")}
library(missForest)
if(!require(FactoMineR)){install.packages("FactoMineR")}
library(FactoMineR)
if(!require(psych)){install.packages("psych")}
library(psych)
if(!require(Hmisc)){install.packages("Hmisc")}
library(Hmisc)
#if(!require(phantomjs)){webshot::install_phantomjs()}
#devtools::install_github("davidgohel/flextable")
if(!require(kableExtra)){install.packages("kableExtra")}
library(kableExtra)
if(!require(gt)){install.packages("gt")}
library(gt)
if(!require(glue)){install.packages("glue")}
library(glue)
if(!require(lme4)){install.packages("lme4")}
library(lme4)
if(!require(lmerTest)){install.packages("lmerTest")}
library(lmerTest)# to get p-value estimations that are not part of the standard lme4 packages
if(!require(effects)){install.packages("effects")}
library(effects)
#if(!require(sjstats)){install.packages("sjstats")}
#library(sjstats)
#install.packages("mcp")
#if(!require(mcp)){install.packages("mcp")}
#library(mcp)
if(!require(EnvStats)){install.packages("EnvStats")}
library(EnvStats)

# install.packages("devtools")
if(!require(outliersTests)){devtools::install_github("linas-p/outliersTests")}
library(outliersTests)
if(!require(redres)){devtools::install_github("goodekat/redres")}
library(redres)
#install.packages("multilevelTools")
if(!require(multilevelTools)){install.packages("multilevelTools")}
library(multilevelTools)
#install.packages("JWileymisc")
if(!require(JWileymisc)){install.packages("JWileymisc")}
library(JWileymisc)

if(!require(RColorBrewer)){install.packages("RColorBrewer")}
library(RColorBrewer)
if(!require(simpleboot)){install.packages("simpleboot")}
library(simpleboot)

if(!require(neuralnet)){install.packages("neuralnet")}
library(neuralnet)
#remove.packages("vctrs")
#update.packages("vctrs")
#detach("package:vctrs") 

if(!require(plotROC)){install.packages("plotROC")}
library(plotROC)
```


```{r}
theme <-  theme(panel.background = element_rect(fill="white",colour="azure2"), 
                legend.position = "bottom",
        panel.grid.major = element_line(colour="azure2") ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_text(size=10, hjust=0.5),
        plot.subtitle = element_text(size=9, hjust=0.5),
      #  axis.title.x=element_blank(),
        axis.text=element_text(size=6),
        axis.title=element_text(size=8,
        face="bold"))

themewithlegend <-  theme(panel.background = element_rect(fill="white",colour="azure2"), 
                          legend.position = "bottom",
        panel.grid.major = element_line(colour="azure2") ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_text(size=10, hjust=0.5),
        plot.subtitle = element_text(size=9, hjust=0.5),
        axis.text=element_text(size=6),
        axis.title=element_text(size=8,
        face="bold"))

themenolegend <-  theme(panel.background = element_rect(fill="white",colour="azure2"), 
                        legend.position = "none",
        panel.grid.major.x = element_line(colour="azure2") ,
        panel.grid.major.y = element_line(colour="azure2") ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_text(size=10, hjust=0.5),
        plot.subtitle = element_text(size=9, hjust=0.5),
        axis.text=element_text(size=6),
        axis.title=element_text(size=8,
        face="bold"))


theme8cm <-  theme(panel.background = element_rect(fill="white",colour="azure2"), 
                        legend.position = "none",
        panel.grid.major.x = element_blank() ,
        panel.grid.major.y = element_line(colour="azure2")  ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_text(size=8, hjust=0.5),
        plot.subtitle = element_text(size=8, hjust=0.5),
        axis.text=element_text(size=6),
        axis.title=element_text(size=6, face="bold"))

themehist <-  theme(panel.background = element_rect(fill="white",colour="azure2"), legend.position = "none",
        panel.grid.major = element_line(colour="azure2") ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_text(size=14, hjust=0.5),
        plot.subtitle = element_text(size=9, hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,
        face="bold"))

themepowerpoint <-  theme(panel.background = element_rect(fill="white",colour="azure2"), legend.position = "none",
        panel.grid.major = element_line(colour="azure2") ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_blank(),
        plot.subtitle = element_text(size=9, hjust=0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14, face="bold"))

thememultiplot <-  theme(panel.background = element_rect(fill="white",colour="azure2"), legend.position = "none",
        panel.grid.major = element_line(colour="azure2") ,
        axis.line.x.bottom = element_line(colour="black") ,
        axis.line.y.left = element_line(colour="black") ,
        plot.title = element_blank(),
        plot.subtitle = element_text(size=9, hjust=0.5),
        axis.text=element_text(size=20),
        axis.title=element_text(size=22, face="bold"))
```

read the original data in. NEVER change the original data in any other software-  ensure all adjustments are kept within r so that they are auditable
The 'na.strings' tells r what to consider a blank cell. Note that in the overall study participants sheets, blank cells are blank. In the other sheets the blank cells are filled with 'NULL'. This needs to be converted to 'NA' in r, and is done within read.csv in this chunk

```{r}
participants <- read.csv("./datatoload/originalstudyparticipants211220.csv", header=T, na.strings="")
medication <- read.csv("./datatoload/originalmedications211220.csv", header=T, na.strings="NULL")
labs <- read.csv("./datatoload/originallabs211220.csv", header=T, na.strings="NULL")
write.csv((as.data.frame(colnames(participants))), "colnamesparticipants.csv", row.names=F)
write.csv((as.data.frame(colnames(labs))), "colnameslabs.csv", row.names=F)
write.csv((as.data.frame(colnames(medication))), "colnamesmedication.csv", row.names=F)
```

*************************************

Removing duplications from participants

***********************************

straight away, I want to check this data for duplicate rows. Same patient, same assessment date, so let's paste together those two columns, and then I can pull them apart again later

```{r}
participants$idpastevisitdate <- paste(participants$Register.ID...Record, participants$Date...CAH.Longitudinal.Data)
duplicates <- freq(participants$idpastevisitdate)
duplicatesframe <- as.data.frame(duplicates)
write.csv(duplicatesframe, "duplicatesframe.csv")
```

I want to get rid of the row with 'total' in this data frame as I'm not interested in the totals
```{r}
duplicatesframe <- rownames_to_column(duplicatesframe, var="idvisitdate")
```

now I need to split the idvisitdate back apart. This code is awkward, but works well
```{r}
duplicatesframe$id<- sapply(strsplit(duplicatesframe$idvisitdate," "), `[`, 1)
duplicatesframe$visitdate<- sapply(strsplit(duplicatesframe$idvisitdate," "), `[`, 2)

```
I dont think those columns are actually needed.
Let's get rid of the total column which is useless for this purpose, then just find the duplicatevisits
```{r}
duplicatesframeminustotal <- duplicatesframe %>% filter(idvisitdate!="Total")
duplicatevisits <- duplicatesframeminustotal %>% filter(Freq>1)
```

now to get a duplicate visits vector that I can take to filter from the participants frame
```{r}
idvisitstoremove <- duplicatevisits$idvisitdate
```

Now I have those I can take them out of the participants frame with a subset
```{r}
participantsnoduplicates <- subset(participants, !idpastevisitdate %in% idvisitstoremove)
#freqcheck <- as.data.frame(freq(participantsnoduplicates$idpastevisitdate))
#freqcheck
```

**********************************

adding the large previous extraction to use dates of birth

**********************************

the dates of birth are a problem, so Jillian has sent me a previous extraction originally named 'CAH Meds 20200311 for Martin.xlsx' to get old ages from it. I've saved this as a csv file for purposes of reading in

```{r}
previousplatformfordob <- read.csv("./datatoload/originalpreviousextractionfordob.csv")
write.csv(colnames(previousplatformfordob), "colnamesprevious.csv")
head(previousplatformfordob$Date.of.Birth)

head(previousplatformfordob$age, n=30)
head(previousplatformfordob$leader, n=30)
head(previousplatformfordob$local_id, n=30)
head(previousplatformfordob$cah_id, n=30)
head(previousplatformfordob$dsd_cah_visit_id, n=30)

oldagestojoin <- previousplatformfordob[,c("ï..register_id", "date", "age", "cah_id", "dsd_cah_visit_id")]
colnames(oldagestojoin) <- paste0(colnames(oldagestojoin), "old")

nrow(oldagestojoin)
uniqueoldagestojoin <- unique(oldagestojoin)
nrow(uniqueoldagestojoin)
names(uniqueoldagestojoin)[names(uniqueoldagestojoin)=="dateold"] <- "dateofvisitold"
```

we will use this to join below when we have the assessment id's that come from the labs frame

*************************************

Removing duplications from labs

***********************************

I want to do the same with labs. Same patient, same assessment date, same lab result so let's paste together those two columns, and then I can pull them apart again later

```{r}
labs$idpastevisitdatepastelabstype <- paste(labs$ï..record_id, labs$assessment_id, labs$assessment_date, labs$labs_type)
duplicatelabs <- freq(labs$idpastevisitdatepastelabstype)
duplicatelabsframe <- as.data.frame(duplicatelabs)
write.csv(duplicatelabsframe, "duplicatelabsframe.csv")
```

I want to get rid of the row with 'total' in this data frame as I'm not interested in the totals
```{r}
duplicatelabsframe <- rownames_to_column(duplicatelabsframe, var="idvisitdate")
```

now I need to split the idvisitdate back apart. This code is awkward, but works well
```{r}
duplicatelabsframe$id<- sapply(strsplit(duplicatelabsframe$idvisitdate," "), `[`, 1)
duplicatelabsframe$assessmentid<- sapply(strsplit(duplicatelabsframe$idvisitdate," "), `[`, 2)

```
I dont think those columns are actually needed.
Let's get rid of the total column which is useless for this purpose, then just find the duplicatevisits
```{r}
duplicatelabsframeminustotal <- duplicatelabsframe %>% filter(idvisitdate!="Total")
duplicatelabvisits <- duplicatelabsframeminustotal %>% filter(Freq>1)
```

now to get a duplicate visits vector that I can take to filter from the participants frame
```{r}
idlabvisitstoremove <- duplicatevisits$idvisitdate
```

Now I have those I can take them out of the participants frame with a subset
```{r}
labsnoduplicates <- subset(labs, !idpastevisitdatepastelabstype %in% idlabvisitstoremove)
#freqcheck <- as.data.frame(freq(participantsnoduplicates$idpastevisitdate))
#freqcheck
```
which is the same as labs, we don't have any duplicates in this case
now we remove the pasted column so that it doesn't cause problems when spreading later
```{r}
labs$idpastevisitdatepastelabstype <- NULL
```




******************************************

sorting out fludrocortisone total dose with an old extraction

*******************************************

This can be found in the file 2021-05-11OLDicahanalysis that incorporated data from an old extraction 'for martin' that jillian sent me whilst the sql query was getting sorted. We will remove them later, but I'm keeping them in for the time being just to establish whether there is any problem with the extraction or not

this came through later on 28/4/21 from a previous extraction whilst waiting for Jillian to sort ou SQL queries.

```{r}
fludrocortisoneframe <- read.csv("./datatoload/2021-04-29originalfludrocortisonedoses.csv", header=T, na.strings="")
```

we have duplicates in this frame also that jillian worried me about


```{r}
fludrocortisoneframe$idpastevisitdate <- paste(fludrocortisoneframe$ï..register_id, fludrocortisoneframe$date)
#head(fludrocortisoneframe$idpastevisitdate)
```
I need to sort out the date in this frame so it's the same as my other frames for when we join
```{r}
fludrocortisoneframe$visitdate <- as.POSIXct(fludrocortisoneframe$date , format="%Y-%m-%d")
#fludrocortisoneframe$visitdate
fludrocortisoneframe$idpastevisitdate <- paste(fludrocortisoneframe$ï..register_id, fludrocortisoneframe$date)
#fludrocortisoneframe$idpastevisitdate
fludrocortisoneframe$idpastevisitdate <- gsub("-", "/" , fludrocortisoneframe$idpastevisitdate)
#head(fludrocortisoneframe$idpastevisitdate)
#head(icahalldata$idpastevisitdate)
```

we only want the fludrocortisone from this, so let's take that out
```{r}
fludrocortisonetojoin <- fludrocortisoneframe[,c("idpastevisitdate", "fludrocortisone_dose", "fludrocortisone_frequency", "fludrocortisone_note")]
```

now we can sort out the duplicates in that frame. We unique it, but then need to check that we don't have any duplicated visits after we unique it

```{r}
uniquefludrocortisonetojoin <- unique(fludrocortisonetojoin)
freqtocheck <- as.data.frame(freq(uniquefludrocortisonetojoin$idpastevisitdate))
```

.this flags up the following idpastevisit dates as not unique, so let's inspect them

1102 2015/12/07	

1443 2016/01/11	

1582 2015/04/20	

2204 2015/12/16	

2210 2010/11/22	

276 2016/01/12

```{r}
inspectnotunique <- uniquefludrocortisonetojoin %>% filter(idpastevisitdate ==
                                                             "1102 2015/12/07" |
                                                           idpastevisitdate ==
                                                             "1443 2016/01/11" |
                                                           idpastevisitdate ==
                                                             "1582 2015/04/20" |
                                                           idpastevisitdate ==
                                                             "2204 2015/12/16" |
                                                           idpastevisitdate ==
                                                             "2210 2010/11/22" |
                                                           idpastevisitdate ==
                                                             "276 2016/01/12" 
                                                             )
```

This shows there is ambiguity in these visits so the data needs removing for some of them

1102 2015/12/07	
this is definitely 200, just ambiguity as to whether it is OD or BD, so those columns can be NA but the total dose can stay

1443 2016/01/11	
one says reduced and one says introduced - need to remove altogether

1582 2015/04/20	
this is just some extra note in the note column so the version with the note column NA can be removed

2204 2015/12/16	
ambiguity over BD and OD but total dose is useable

2210 2010/11/22	
both these visits are ambiguous about whether it is 50 or 75 so both to be removed

276 2016/01/12
just extra information in the note column so this row can be preferenced

correct those visits in the fludrocortisone to join frame
```{r}
colnames(fludrocortisonetojoin)
fludrocortisonetojoin$fludrocortisone_frequency <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="1102 2015/12/07" , NA , fludrocortisonetojoin$fludrocortisone_frequency)	
fludrocortisonetojoin$fludrocortisone_note <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="1102 2015/12/07" , NA , fludrocortisonetojoin$fludrocortisone_note)	

fludrocortisonetojoin$fludrocortisone_dose <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="1443 2016/01/11" , NA , fludrocortisonetojoin$fludrocortisone_dose)
fludrocortisonetojoin$fludrocortisone_frequency <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="1443 2016/01/11" , NA , fludrocortisonetojoin$fludrocortisone_frequency)
fludrocortisonetojoin$fludrocortisone_note <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="1443 2016/01/11" , NA , fludrocortisonetojoin$fludrocortisone_note)

fludrocortisonetojoin <- subset(fludrocortisonetojoin, 
                                fludrocortisonetojoin$idpastevisitdate!="1582 2015/04/20" & !is.na(fludrocortisonetojoin$fludrocortisone_note))

fludrocortisonetojoin$fludrocortisone_note <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="1582 2015/04/20" , NA , fludrocortisonetojoin$fludrocortisone_note)

fludrocortisonetojoin$fludrocortisone_frequency <-  ifelse(fludrocortisonetojoin$idpastevisitdate =="2204 2015/12/16" , NA , fludrocortisonetojoin$fludrocortisone_frequency)

fludrocortisonetojoin <- subset(fludrocortisonetojoin, 
                                fludrocortisonetojoin$idpastevisitdate!="2210 2010/11/22")

fludrocortisonetojoin <- subset(fludrocortisonetojoin, 
                                fludrocortisonetojoin$idpastevisitdate!="276 2016/01/12" & !is.na(fludrocortisonetojoin$fludrocortisone_note))
```

now we have manually corrected all of those rows, a unique version should actually be unique:

```{r}
uniquefludrocortisonetojoin <- unique(fludrocortisonetojoin)
freqtocheck <- as.data.frame(freq(uniquefludrocortisonetojoin$idpastevisitdate))
```

now our uniquefludrocortisonetojoin has only one row of data for all idpastevisitdate s

we can therefore join uniquefludrocortisonetojoin into the main frame below where we join in all of the labs data to the participants data


***************************

Incoprorating fludrocortisone extraction

****************************

we can now load original data files 
2021-05-11Fludrocortisoneextraction.csv

```{r}
fludrocortisoneextraction <- read.csv("./datatoload/2021-05-11Fludrocortisoneextraction.csv", header=T, na.strings="")
nrow(fludrocortisoneextraction)
```

we have more rows in this fludrocortisone extraction, so need to see what's happening using frequencies
do we have more than 1 row per visit?
```{r}
frequencyoffludrocortisonevisits <- as.data.frame(freq(fludrocortisoneextraction$assessment_id))
colnames(frequencyoffludrocortisonevisits)
morethanonefludrocortisonevisit <- frequencyoffludrocortisonevisits %>% filter(Freq>1)
morethanonefludrocortisonevisit
```

so the assessment IDs are unique

what sort of frequency of how often they give it are we dealing with:
```{r}
freq(fludrocortisoneextraction$fludrocortisone_frequency)
```

majority are once or twice daily. We need to decide what to do with 'NULL'

we can match NULL from the same patient on some occasions

to look at this data, we want the data of everyone with NULL, but we want all of their visits

```{r}
nullfludrocortisonepatientsdata <- fludrocortisoneextraction %>% filter(fludrocortisone_frequency == "NULL")
nullfludrocortisonepatients <- nullfludrocortisonepatientsdata$ï..record_id
```
now we take out all the visits of those patients

```{r}
nullfludrocortisonepatientsallvisitsdata <- fludrocortisoneextraction %>% filter(ï..record_id %in% nullfludrocortisonepatients )
```

now we can't trust those that only have one visit in that set, as that one visit will be NULL, and we don't know the frequency of administration

```{r}
frequenciesofvisitsfornullpatients <- as.data.frame(freq(nullfludrocortisonepatientsallvisitsdata$ï..record_id))
thosewithonevisit <- frequenciesofvisitsfornullpatients %>% filter(Freq==1)
patientswithonlynull <- rownames(thosewithonevisit)
patientswithonlynull
```

2792 and 5867 therefore definitely need to be removed as we don't know what dose they have

now we want to know patients that changed frequency, as if they have a null and multiple different frequencies, they need appropriate inspection

so group by the patient, then unique the column of frequency

```{r}
oncedaily <- nullfludrocortisonepatientsallvisitsdata %>% filter(fludrocortisone_frequency=="once_daily")
twicedaily <- nullfludrocortisonepatientsallvisitsdata %>% filter(fludrocortisone_frequency=="twice_daily")
threetimesdaily <- nullfludrocortisonepatientsallvisitsdata  %>% filter(fludrocortisone_frequency=="three_times_a_day")
```

```{r}
nullandoncedailypatients <- unique(oncedaily$ï..record_id)
nullandtwicedailypatients <- unique(twicedaily$ï..record_id)
nullandthreetimesdailypatients <- unique(threetimesdaily$ï..record_id)
```

now let's get all the data for patients that are in any permutation of two of those
```{r}
twopossiblefrequencies <- fludrocortisoneextraction %>% filter(
  ï..record_id %in% nullandoncedailypatients & ï..record_id %in% nullandtwicedailypatients |
    ï..record_id %in% nullandtwicedailypatients &  ï..record_id %in% nullandthreetimesdailypatients |
    ï..record_id %in% nullandoncedailypatients &  ï..record_id %in% nullandthreetimesdailypatients)
  
  
  
```


When I look down this list, another concern jumps out at me. It looks like people may be entering total daily dose, then the frequency in which it is given. This may cause some analysis that shows twice daily dose as a massive total dose, when actually it's being multiplied by 2 unnecessarily. Need some way of visualising that. 

We can't trust the visit that states frequency as 'NULL' with two possible frequencies, so filter those out and mark those visits as unusable

```{r}
nullcantberescured <- twopossiblefrequencies %>% filter(fludrocortisone_frequency=="NULL")
nullcantberescured$assessment_id
```
251 , 786 , 5558 , 5559 , 5560 need to be removed as we don't know the frequency

for the other null frequencies, we just want to copy the frequency the patient was receiving

so we take our original frame. We remove the visits that cant be trusted. Then we fill in with ifelse statements



```{r}
fludrocortisoneextractiontouse <- subset(fludrocortisoneextraction, !(assessment_id %in% nullcantberescured$assessment_id) )
fludrocortisoneextractiontouse <- subset(fludrocortisoneextractiontouse, !(ï..record_id %in% patientswithonlynull) )
```

now we run similar code as how we diagnosed it, only we know that we only have one possible frequency for each patient now

```{r}
nulldata <- fludrocortisoneextractiontouse %>% filter(fludrocortisone_frequency == "NULL")
nullpatients <- nulldata$ï..record_id
```
now we take out all the visits of those patients

```{r}
nullpatientsallvisitsdata <- fludrocortisoneextractiontouse %>% filter(ï..record_id %in% nullpatients )
```

we already know each of these patients had more than one visit, so let's find out who has once_daily
```{r}
oncedailytouse <- nullpatientsallvisitsdata %>% filter(fludrocortisone_frequency=="once_daily")
twicedailytouse <- nullpatientsallvisitsdata %>% filter(fludrocortisone_frequency=="twice_daily")
threetimesdailytouse <- nullpatientsallvisitsdata  %>% filter(fludrocortisone_frequency=="three_times_a_day")
```

```{r}
nullandoncedailypatients <- unique(oncedailytouse$ï..record_id)
nullandtwicedailypatients <- unique(twicedailytouse$ï..record_id)
nullandthreetimesdailypatients <- unique(threetimesdailytouse$ï..record_id)
```

so now we simply take our to use frame, and if the patient is nullandoncedailypatients, we change their frequency to once daily, etc

```{r}
fludrocortisoneextractiontouse$fludrocortisone_frequency <- ifelse(
  fludrocortisoneextractiontouse$ï..record_id %in% nullandoncedailypatients ,
  "once_daily",
  fludrocortisoneextractiontouse$fludrocortisone_frequency
)

fludrocortisoneextractiontouse$fludrocortisone_frequency <- ifelse(
  fludrocortisoneextractiontouse$ï..record_id %in% nullandtwicedailypatients ,
  "twice_daily",
  fludrocortisoneextractiontouse$fludrocortisone_frequency
)

fludrocortisoneextractiontouse$fludrocortisone_frequency <- ifelse(
  fludrocortisoneextractiontouse$ï..record_id %in% nullandthreetimesdailypatients ,
  "three_times_a_day",
  fludrocortisoneextractiontouse$fludrocortisone_frequency
)

```


now when you do a frequency check on this frame, we should not have any NULL readings

```{r}
freq(fludrocortisoneextractiontouse$fludrocortisone_frequency)
```

HOWEVER - this still leads 51 NULL entries of people who don't have a recorded frequency. WE COULD possibly assume that they are taking it once a day, but that's not really safe, so instead we just exclude. 

```{r}
fludrocortisoneextractiontouse <- fludrocortisoneextractiontouse %>% filter(fludrocortisone_frequency!="NULL")
freq(fludrocortisoneextractiontouse$fludrocortisone_frequency)
```

that still leaves us 6099 visits and we've done all we can to use them all. We now want to join this frame



let's sort out the date column


```{r}
fludrocortisoneextractiontouse$visitdate <- as.POSIXct(fludrocortisoneextractiontouse$assessment_date , format="%d/%m/%Y")
```

and make a frequency column that's useful to multiply

```{r}
fludrocortisoneextractiontouse$fludrofrequencyperday <- ifelse(fludrocortisoneextractiontouse$fludrocortisone_frequency == "once_daily", 1, NA)
fludrocortisoneextractiontouse$fludrofrequencyperday <- ifelse(fludrocortisoneextractiontouse$fludrocortisone_frequency == "twice_daily", 2, fludrocortisoneextractiontouse$fludrofrequencyperday)
fludrocortisoneextractiontouse$fludrofrequencyperday <- ifelse(fludrocortisoneextractiontouse$fludrocortisone_frequency == "three_times_a_day", 3, fludrocortisoneextractiontouse$fludrofrequencyperday)
```
create a total fludro dose column - will need to analyse this to see if there is enough evidence that people aren't entering separate doses, but are perhaps entering total doses
```{r}
fludrocortisoneextractiontouse$fludrodosetimesfrequency <- as.numeric(fludrocortisoneextractiontouse$fludrocortisone_dose) * fludrocortisoneextractiontouse$fludrofrequencyperday
```

to visualise this you want some histograms of dose, split by those that have once daily, those that have twice daily etc. but looking down the data, I'm certain of it - a lot of people are entering total daily fludrocortisone dose, then they are adding how many DIVIDED doses they are giving it over. 

However, some people have entered 75 micrograms twice daily - I think this is much more likely to be 75 BD with a total of 150

so we will just turn the dose column into a number for joining 
```{r}
fludrocortisoneextractiontouse$fludroentereddose <- as.numeric(fludrocortisoneextractiontouse$fludrocortisone_dose)

```

we don't create an idpastevisitdate column in this data because each row has an appropriate assessment id

then get it ready to join
```{r}
names(fludrocortisoneextractiontouse)[names(fludrocortisoneextractiontouse)=="visitdate"] <- "fludrovisitdate"
fludrocortisoneextractiontojoin <- fludrocortisoneextractiontouse[,c("assessment_id", "fludrovisitdate", "fludroentereddose", "fludrofrequencyperday")]
```

let's display the doses of fludrocortisone with different frequencies as histograms
```{r}
fludrodoseoncedailyforhistogram <- subset(fludrocortisoneextractiontouse, fludrofrequencyperday==1) %>% dplyr::group_by(fludroentereddose) %>%  dplyr::summarise(n=n())
fludrodosetwicedailyforhistogram <- subset(fludrocortisoneextractiontouse, fludrofrequencyperday==2) %>% dplyr::group_by(fludroentereddose) %>%  dplyr::summarise(n=n())
fludrodosethreetimesdailyforhistogram <- subset(fludrocortisoneextractiontouse, fludrofrequencyperday==3) %>% dplyr::group_by(fludroentereddose) %>%  dplyr::summarise(n=n())

histogramoncedaily <- ggplot(data=fludrodoseoncedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of fludrocortisone dose for patients taking it once a day", 
x="Fludrocortisone Dose", 
y="Frequency") + themehist + xlim(0,500) + ylim(0,10)
histogramoncedaily

histogramtwicedaily <- ggplot(data=fludrodosetwicedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of fludrocortisone dose for patients taking it twice a day", 
x="Fludrocortisone Dose", 
y="Frequency") + themehist+ xlim(0,500)+ ylim(0,10)
histogramtwicedaily

histogramoncedaily <- ggplot(data=fludrodoseoncedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of fludrocortisone dose for patients taking it once a day", 
x="Fludrocortisone Dose", 
y="Frequency") + themehist + xlim(0,50) + ylim(0,10)
histogramoncedaily

histogramtwicedaily <- ggplot(data=fludrodosetwicedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of fludrocortisone dose for patients taking it twice a day", 
x="Fludrocortisone Dose", 
y="Frequency") + themehist+ xlim(0,50)+ ylim(0,10)
histogramtwicedaily

```

these plots aren't that useful as it could be different ages, we need to do this really with a dose per BSA

right, let's put the fludrocortisone into the main frame later on using  fludrocortisoneextractiontojoin


*************************************

Visit statistics

***********************************

This chunk groups the records by separate patients, and tells us how many visits they had. Then we take that long dataframe that has told us how many visits eavh of them have, and create some summary statistics to give us an idea of how many patients we have, and how many visits we have data for. After conversations with Nils, we could do with having an idea over how much time these visits span, i.e. are these 4 visits a year or are they visits that span 10 years?
```{r}
numbervisits <- participantsnoduplicates %>% dplyr::group_by(Register.ID...Record) %>%  dplyr::summarise(n=n())
numbervisitsstats <- numbervisits %>% summarise(numberpatients =n(), meanvisits=mean(n, na.rm = TRUE), medianvisits=median(n, na.rm = TRUE),
                                                sdvisits=sd(n, na.rm = TRUE), minvisits=min(n, na.rm = TRUE), maxvisits=max(n, na.rm = TRUE))
```

now we do that for each assessment in the medication frame. This will tell us how many visits we have that have details about the medication that the patient was taking. 
```{r}
numbervisitswithmedication <- medication %>% dplyr::group_by(assessment_id) %>%  dplyr::summarise(n=n())
```
this adds the number of visits with medication to the frame that tells us the number of visits. 
```{r}
numbervisitsstats$totalvisitswithmedicationdetails <- numbervisitswithmedication %>% summarise(n=n())
````

It then writes it to a comma separated values file that is easily  opened in excel just for sharing these results
```{r}
write.csv(numbervisitsstats, "visitsstats.csv")
```

let's display the number of visits as a histogram:


```{r}
histogram <- ggplot(data=numbervisits, aes(n)) + 
  geom_histogram(bins=42, colour="black"
                 ) + 
  labs(title="Histogram of Number of Visits for which patients have data", 
x="Number of visits", 
y="Frequency") + themehist
ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")

```


let's next combine the three frames of participantsnoduplicates, labs and medications

***********************

calculating total medication doses

************************

let's calculate the total doses of medication per visit, i.e. per assessment id in the medication frame
```{r}
totalmedicationcalculation <- medication %>% group_by(assessment_id) %>% summarise(totaldose=sum(dose, na.rm=TRUE))
```

now we have to bear in mind that their is a dose unit column, so we have to alter any doses that are not reported in mg
this column contains values for mcg, for mg and for NA. Let's find out which values have NA for unit

```{r}
test <- medication %>% filter(unit=="mcg")
```

we also need to bear in mind that some doses are zero. This will obviously not effect a total dose calculation, but must be borne in mind for future calculations that try to count the number of doses patients have.

For the purposes of our analysis, we will assume that any dose that is recorded without associated units, has been recorded in milligrams (it ranges from 1 to 17.5, so this is perfectly reasonable)

Looking at those who have entered 'micrograms' alongside hydrocortisone, it is much more likely that this is simply a mistake in entering micrograms, rather than a genuine use of microgram units as the range 1 to 6 (1 to 6 micrograms of hydrocortisone is nonsensically tiny, even for a baby). These entries have therefore not been altered, and rolled up into total dose as if they are milligrams. 

the one dexamethasone dose is 40 micrograms, which does make sense. This is therefore converted to milligrams after the join

our total medication frame gives us a frame with just two columns. To get all of the other info for each visit we can left_join, which only keeps the rows from the first data frame, it doesn't create any duplicates. So this leaves us with multiple rows for each visit, the total dose being the same in each row of the same visit. 
We can therefore use 'distinct' to just take the first column, to make it one row per visit
```{r}
totalmedication <- left_join(medication, totalmedicationcalculation, by="assessment_id")
singletotalmedication <- totalmedication %>% distinct(assessment_id, .keep_all=T)
```

singletotalmedication also gives us the first value for 'dose', the value of the first row of the corresponding visit, which may be confusing. I have therefore removed this column at this stage, along with time because all of the times are zero and there the notes as there are no notes in this data frame at all. 

```{r}
drop <- c("time", "dose", "note")
singletotalmedication <-  singletotalmedication[,!(names(singletotalmedication) %in% drop)]
```

let's appropriately convert the dexamethasone dose from mcg to mg

```{r}

singletotalmedication$totaldose <- ifelse(
  singletotalmedication$medicine=="dexamethasone" & 
  singletotalmedication$unit=="mcg",
  singletotalmedication$totaldose / 1000,
  singletotalmedication$totaldose)
  
singletotalmedication$unit <- ifelse(singletotalmedication$medicine=="dexamethasone" & singletotalmedication$unit=="mcg",
  "mg",
  singletotalmedication$unit)
```


***************************

Rearranging lab data to join to the participant frame

***************************

with the labs frame, we have a slightly better underlying spreadsheet, in that we have a 'key' column which is 'labs_type', and a value column called 'value'. We can therefore sort this data frame out by using the function spread. However, we also have an interpretation column that we want to spread with the value - whether they think it is high low or normal. We therefore want to spread these separately, then combine them.

To use spread you need just the key and value column to be different on each line, so I've had to remove the result and date/time columns prior to spreading
```{r}
drop <- c("result", "date_and_time")
labsvalues <- labs[,!(names(labs) %in% drop)]
labsvalues <- spread(labsvalues, key=labs_type, value=value)
#labsvalues2 <- pivot_wider(labsvalues, names_from = assessment_id, values_from = value)

drop <- c("value", "date_and_time")
labsinterpretation <- labs[,!(names(labs) %in% drop)]
labsinterpretation <- spread(labsinterpretation, key=labs_type, value=result)
```

now we can join the interpretation and the value to get one line for each clinic visit
```{r}
labswide <- left_join(labsvalues,labsinterpretation, by=c("ï..record_id", "assessment_id", "assessment_date", "centreName"))
```

this now gives us a wide frame with the number of the lab test suffixed with .x, and the centre interpretation of that number suffixed with .y
let's change those suffix's to something that makes more sense
```{r}
names(labswide) <- gsub(x = names(labswide), pattern = "\\.x", replacement = ".value")
names(labswide) <- gsub(x = names(labswide), pattern = "\\.y", replacement = ".interp")
```

check we only have one assessment for each 

```{r}
freqtocheck441 <- freq(labswide$assessment_id)
```
this is correct, there is only one assessment_id per person

We now have 3 frames with one row for each clinic visit:
participantsnoduplicates - this contains 'Date...CAH.Longitudinal.Data' - character dd/mm/yyyy
singletotalmedication - this contains 'assessment_date' - character dd/mm/yyyy 
labswide - this contains 'assessment_date' - character dd/mm/yyyy 

the one question I have at this stage for yourself, or for faisel, is when the centre enters the medication at clinic, is that the medication that the patient has been on, or the medication that they will be on after clinic (if the medication has changed?)

************************************************************************************************

Joining the participant data to their lab data and their medication data

************************************************************************************************

the structure is a character and will have to be turned to a date, but as they follow the same strucure of date we should be able to join them in character form
```{r}
medsandlabs <- left_join(singletotalmedication, labswide, by = c("ï..record_id", "centreName", "assessment_id", "assessment_date"))
```

Now we can join the medsandlabs data to the rest of the participants data
```{r}
medslabsparticipantsdata <- left_join(participantsnoduplicates, medsandlabs, by=c("Register.ID...Record"="ï..record_id", "Date...CAH.Longitudinal.Data"="assessment_date"))
```

```{r}
str(medslabsparticipantsdata$idpastevisitdate)
str(uniquefludrocortisonetojoin$idpastevisitdate)
```

problem we have here is the date is in a slightly different format because i hadn't sorted it out properly the first time round in the medslabsparticipantsdata, so let's posixct the date in the medslabsandparticipants data

```{r}
medslabsparticipantsdata$visitdate <- as.POSIXct(medslabsparticipantsdata$Date...CAH.Longitudinal.Data , format="%d/%m/%Y")
medslabsparticipantsdata$idpastevisitdate <- paste(medslabsparticipantsdata$Register.ID...Record , medslabsparticipantsdata$visitdate)

```

so this is a bit ridiculous now as I subbed it earlier in the fludrocortisone frame and probably shouldn't have, but I've written all the manual corrections with slashes, so I need to sub the - for a / again and check this doesn't ruin any joins later on

```{r}
medslabsparticipantsdata$idpastevisitdate <- gsub("-", "/" , medslabsparticipantsdata$idpastevisitdate)
head(medslabsparticipantsdata$idpastevisitdate)
head(fludrocortisonetojoin$idpastevisitdate)
```



we can now join the fludrocortisone data using the idpastevisitdate column
uniquefludrocortisonetojoin is the old data
```{r}
icahalldatawitholdfludrocortisone <- left_join(medslabsparticipantsdata, uniquefludrocortisonetojoin, by="idpastevisitdate")
```

then the proper extraction is fludrocortisoneextractiontojoin

we need an 

```{r}
icahalldatawithlatestextractionoffludrocortisone <- left_join(icahalldatawitholdfludrocortisone, fludrocortisoneextractiontojoin, by="assessment_id")

nrow(icahalldatawitholdfludrocortisone)
nrow(fludrocortisoneextractiontojoin)
nrow(icahalldatawithlatestextractionoffludrocortisone)

```
so we have data from roughly 200 visits that have fludrocortisone data but none of the other data as we got that at a later date.





********************

different fludrocortisone data sources key

*********************

```{r}
icahalldatabackup952 <- icahalldatawithlatestextractionoffludrocortisone
icahalldata <- icahalldatawithlatestextractionoffludrocortisone
icahalldata <- icahalldatabackup952
```

the old extraction from martin has the column names:
"fludrocortisone_dose"      "fludrocortisone_frequency" "fludrocortisone_note" 

our NEW extraction properly extracted  the second time has the column names

"fludroentereddose"     "fludrofrequencyperday"



meaning we now have total dose for a little over 1000 visits, which seems low. Are we missing anything from visits that don't have date? This filtering tells us not:

```{r}
freq(icahalldata$Fludrocortisone...Current.Medication)
freqtocheck <- as.data.frame(freq(fludrocortisoneframe$ï..register_id))
freqtocheck <- as.data.frame(freq(fludrocortisoneframe$visitdate))

frametocheck <- fludrocortisoneframe %>% filter((date=="NULL"))
frametocheck$fludrocortisone_dose
```


```{r}
icahalldatabackup469 <- icahalldata
freqtocheck469 <- freq(icahalldata$assessment_id)
```
unique assessmnet)id

HOWEVER - we don't have an assessment_id for any visit that just has biometrics data, without any meds or labs data entered. We don't want to unnecessarily lose that data, so for any value of NA in the assessment_id column we want to create a unique id. This can be the recordID concatenated, or pasted together, with the visit data

```{r}
icahalldata$assessment_id <- ifelse(is.na(icahalldata$assessment_id), paste(icahalldata$Register.ID...Record, icahalldata$Date...CAH.Longitudinal.Data,sep=""), icahalldata$assessment_id)

```

Every visit now has a unique id, even if the visit contains no labs or meds


**********************************************************

Add anonymisation code for centres

**********************************************************

The following centres have made it into the paper, so we add a coded column for each of those to be able to anonymised plots later:

A	Aarhus
B	Barcelona
C	Belgrade - Endocrinology
D	Berlin
E	Bologna
F	Buenos Aires
G	Cairo Ain Shams University
H	Cambridge
I	Craiova
J	Glasgow RHC
K	Istanbul Marmara
L	Istanbul Zeynep Kamil
M	Leiden University Medical Centre
N	Nijmegen
O	Petah Tiqvah
P	Rotterdam
Q	Sao Paulo
R	Sheffield Childrens Hospital
S	Stockholm
T	Torino - Regina Margherita Childrens Hospital
U	Utrecht-CAH
V	Winterthur

```{r}
icahalldata$centreanoncode <- icahalldata$Centre.Name...Centre
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Aarhus", "A", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Barcelona", "B", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Belgrade - Endocrinology", "C", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Berlin", "D", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Bologna", "E", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Buenos Aires", "F", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Cairo Ain Shams University", "G", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Cambridge", "H", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Craiova", "I", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Glasgow RHC", "J", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Istanbul Marmara", "K", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Istanbul Zeynep Kamil", "L", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Leiden University Medical Centre", "M", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Nijmegen", "N", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Petah Tiqvah", "O", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Rotterdam", "P", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Sao Paulo", "Q", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Sheffield Childrens Hospital", "R", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Stockholm", "S", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Torino - Regina Margherita Childrens Hospital", "T", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Utrecht-CAH", "U", icahalldata$centreanoncode)
icahalldata$centreanoncode <- ifelse(icahalldata$centreanoncode=="Winterthur", "V", icahalldata$centreanoncode)

icahalldatabackup1055 <- icahalldata
```

**************************************

joining the old dates of birth

**************************************

```{r}
nrow(icahalldata)
nrow(uniqueoldagestojoin)

newandold <- left_join(icahalldata, uniqueoldagestojoin, by=c("assessment_id"="dsd_cah_visit_idold"))
nrow(newandold)

justnewwithold <- inner_join(icahalldata, uniqueoldagestojoin, by=c("assessment_id"="dsd_cah_visit_idold"))
nrow(justnewwithold)

print("new rows here tells us the number of visits that have been added between the extractions")
newrows <- nrow(newandold) - nrow(justnewwithold)
newrows

justold <- anti_join(uniqueoldagestojoin, icahalldata, by=c("dsd_cah_visit_idold"="assessment_id"))
nrow(justold)
justold
```

we now need to tidy up the uniwueoldagestojoin to share it with neurocrine. They want register id, visit id, date of visit, and age of patient

```{r}
colnames(uniqueoldagestojoin)
write.csv(uniqueoldagestojoin, "oldextractionages.csv")
```



here, we can just turn icahalldata into the frame that has the old dates in as well

```{r}
icahalldata <- newandold
```

let's find out how many old ages we have

```{r}
freq(icahalldata$ageold)
```

That's really encouraging, only 54 of them are NA

now we can sort out the dateofvisitold column and ageold column to give us old estimated date of birth

here, for some reason I can subtract from a posixlt object, but not from a posixct object. The posixlt object comes as something with two objects inside it, so I convert back to posixct
```{r}
icahalldata$dateofvisitoldposix <- as.POSIXct(icahalldata$dateofvisitold,format="%d/%m/%Y")

icahalldata$ageolddecimal <- as.numeric(icahalldata$ageold)

#we call it date of birth here event hough it is not yet calculated
icahalldata$dateofbirtholdposixct <- icahalldata$dateofvisitoldposix

#create a posixlt object that can handle subtractions
icahalldata$dateofbirtholdcalculated <- as.POSIXlt(icahalldata$dateofvisitoldposix)

#subtract our age to get a date of 
icahalldata$dateofbirtholdcalculated$year <- 
  icahalldata$dateofbirtholdcalculated$year - icahalldata$ageolddecimal

#turn it back into posixct so that it's in a straightforward date formate
icahalldata$dateofbirthcalculated <- as.POSIXct(icahalldata$dateofbirtholdcalculated)

viewcalculateddob <- icahalldata[,c("Register.ID...Record", "assessment_id", "Date...CAH.Longitudinal.Data","dateofvisitold", "dateofbirtholdcalculated", "dateofbirthcalculated")]

```

dateofbirthcalculated is therefore the column with a calculated date of birth that we can use. We would want to take this for each patient and calculate their oldest possible date of birth, and their youngest possible date of birth. Could then cross reference this with the date of youngest visit that would further narrow down their date of birth.

********************************************

finding earliest and latest calculated dates of birth

********************************************

let's get a minimum date of birth and a maximum, and then rejoin them into the frame

```{r}
latestcalculateddateofbirth <- viewcalculateddob %>% group_by(Register.ID...Record) %>% slice_max(dateofbirthcalculated, n=1, with_ties=F) 
names(latestcalculateddateofbirth)[names(latestcalculateddateofbirth)=="dateofbirthcalculated"] <- "latestdateofbirthcalculated"
latestcalculateddateofbirthtojoin <- latestcalculateddateofbirth[,c("Register.ID...Record", "latestdateofbirthcalculated")]

earliestcalculateddateofbirth <- viewcalculateddob %>% group_by(Register.ID...Record) %>% slice_min(dateofbirthcalculated, n=1, with_ties=F) 
names(earliestcalculateddateofbirth)[names(earliestcalculateddateofbirth)=="dateofbirthcalculated"] <- "earliestdateofbirthcalculated"
earliestcalculateddateofbirthtojoin <- earliestcalculateddateofbirth[,c("Register.ID...Record", "earliestdateofbirthcalculated")]


icahalldatawithlatest <- left_join (icahalldata, latestcalculateddateofbirthtojoin, by="Register.ID...Record")
icahalldatawithearliest <- left_join (icahalldatawithlatest, earliestcalculateddateofbirthtojoin, by="Register.ID...Record")
icahalldata <- icahalldatawithearliest

```
now we can see what we're dealing with with regards to the difference between the earliest and the latest calculated dates of birth

subtracting the two gives you time in seconds which isn't much use
```{r}
icahalldata$latestdobminusearliestdob <- (icahalldata$latestdateofbirthcalculated - icahalldata$earliestdateofbirthcalculated) /60 /60 /24 /365.25

```

so now we can plot that as a histogram

```{r}
histogramofageuncertaintybyvisit <- ggplot(icahalldata, aes(x=latestdobminusearliestdob)) +
  geom_histogram(bins=200, colour="black", fill="azure3") + scale_x_continuous(name = "Difference between possible dates of birth",  breaks=c(seq(0,150, by=1)))
histogramofageuncertaintybyvisit
```


That histogram shows some pretty rubbish uncertainte in the dates of birth

However, if the earliest date of birth is before the visit date, then we know it is nonsense

```{r}
icahalldata$earliestdobminusvisitdate <- ( icahalldata$visitdate - icahalldata$earliestdateofbirthcalculated )/ 60 /60 /24 /365.25
icahalldata$earliestdobminusvisitdate
```

We also have to bear in mind that some of those 'oldage's are simply reported as zero decimal places, so each has the possibility of being .99 years older 

to try and quantify this, I would want to display how many decimal points my ages are reported to 

take the column icahalldata$ageold. Separate it into before the decimal point and after the decimal point.

this would be a way of subbing beyond the decimal point, which won't be what want
```{r}
#icahalldata$ageoldbeforedecimal <- gsub("\\..*$", "" , icahalldata$ageold)
```

```{r}
icahalldata$beforedecimalpoint <- sapply(strsplit(icahalldata$ageold, "."), `[`, 2)


#THIS IS WHERE I AM TRYING TO VISUALISE HOW MUCH PRECISION WE HAVE FOR DATES OF BIRTH

```
************************************

THIS IS WHERE YOU CAN WORK ON VISUALISING HOW TO DISCUSS PRECISION OF DATE OF BIRTH

*************************************





*********************************************

Formatting date and time

*********************************************

previously I used protracted code to calculate a date of birth that ended up too young (taking the date of birth as a definite year of birth, but accounting for uncertainty of the day and month). Instead, I stopped doing this and started to use the Decimal.age as agetouse. This is why I have just created another column of agetouse that is the same as decimal age - to prevent having to change code in all other files. All that needs to be done is to change the decimal age, and recalculate the z scores appropriately. Now we have the old ages (from above), we could consider changing the age to use again. 

let's tidy the columns that need to be registered properly as date and time. Create a year column to facilitate easy plotting by year later. Also create day and month column to be able to easily visualise that a lot of the dates of birth are clearly incorrect / fudged. 

```{r}
icahalldata$dob <- as.POSIXct(icahalldata$ï..Date.of.birth...Birth , format="%d/%m/%Y")
icahalldata$visitdate <- as.POSIXct(icahalldata$Date...CAH.Longitudinal.Data , format="%d/%m/%Y")
icahalldata$agetouse <- as.numeric(icahalldata$Decimal.Age)
#str(icahalldata$agetouse)
icahalldata$dayofdob <- as.numeric(format(icahalldata$dob,'%d'))
icahalldata$monthofdob <- as.numeric(format(icahalldata$dob,'%m'))
icahalldata$yearofdob <- as.numeric(format(icahalldata$dob,'%Y'))

icahalldata$dayofvisit <- as.numeric(format(icahalldata$visitdate,'%d'))
icahalldata$monthofvisit <- as.numeric(format(icahalldata$visitdate,'%m'))
icahalldata$yearofvisit <- as.numeric(format(icahalldata$visitdate,'%Y'))
```

now we can create a year of study column

```{r}
icahalldata$yearofstudy <- icahalldata$yearofvisit - 2000
icahalldata$yearofstudy <- ifelse(icahalldata$yearofstudy<0 , NA, icahalldata$yearofstudy)
icahalldata$yearofstudy <- ifelse(icahalldata$yearofstudy>20 , NA, icahalldata$yearofstudy)
```


we now need to order this sheet appropriately 
```{r}
icahalldata <- 
  icahalldata[order(icahalldata$Register.ID...Record, icahalldata$Date...CAH.Longitudinal.Data),]
```

*********************************

adding an overall visit number

*********************************

For purposes in the future of wanting to know whether this is the patients first visit recorded in the registry. Clearly not an ideal way of knowing whether we are near to diagnosis, but no one fills out the date of diagnosis column

```{r}
icahalldata$visitnumber <- ave(icahalldata$agetouse, icahalldata$Register.ID...Record, FUN = seq_along)

```


********************************

calculating an oldest possible age of diagnosis

*********************************
There are several columns present in relation to diagnosis

Date of diagnosis is very poorly completed

However, age at first presentation seems to be well completed. This involves age brackets, so if a patient is 8 at age of presentation, they could theoretically by 8 years 11 months. So we can create an oldestpossibleageatdiagnosis variable that adds 1 year to the ages, and takes the end of each age bracket under 1 year

```{r}
icahalldata$ageatpresentationnumbers <- as.numeric(icahalldata$Age.at.first.presentation...CAH.First.Presentation)
freq(icahalldata$ageatpresentationnumbers)
icahalldata$oldestpossibleageatdiagnosis <- icahalldata$ageatpresentationnumbers + 1
freq(icahalldata$oldestpossibleageatdiagnosis)

icahalldata$oldestpossibleageatdiagnosis <- ifelse(
  icahalldata$Age.at.first.presentation...CAH.First.Presentation == "< 1 month", 
  0.08333, 
  icahalldata$oldestpossibleageatdiagnosis)
icahalldata$oldestpossibleageatdiagnosis <- ifelse(
  icahalldata$Age.at.first.presentation...CAH.First.Presentation == "1 - 3 months", 
  0.25, 
  icahalldata$oldestpossibleageatdiagnosis)
icahalldata$oldestpossibleageatdiagnosis <- ifelse(
  icahalldata$Age.at.first.presentation...CAH.First.Presentation == "3 months - 1 year", 
  1, 
  icahalldata$oldestpossibleageatdiagnosis)
freq(icahalldata$oldestpossibleageatdiagnosis)
```

***************************************

coding sex

**************************************

we need a coded sex column within our data to use for sex rather than the characters of Male and Female

```{r}
icahalldata$sex <- ifelse(icahalldata$Sex.at.birth...Birth=="Male" , 1, NA)
icahalldata$sex <- ifelse(icahalldata$Sex.at.birth...Birth=="Female" , 2, icahalldata$sex)
```

let's get a list of visits that have something other than hydrocortisone
```{r}
freq(icahalldata$medicine)
icahalldata$medicationotherthanhydrocortisone <- ifelse(icahalldata$medicine=="prednisone" | 
                                                          icahalldata$medicine=="prednisolone" | 
                                                          icahalldata$medicine=="dexamethasone" |
                                                          icahalldata$medicine=="other", 1, 0)
icahvisitsotherthanhydrocortisone <- icahalldata %>% filter(medicationotherthanhydrocortisone==1)
nrow(icahvisitsotherthanhydrocortisone)

icahalldatabackup848 <- icahalldata
```

*******************

coding visits after a medication other than hydrocortisone has been entered

*******************


now we want to take out of those visits the visit with the youngest age when the patient is on a medicine other than hydrocortisone, and that visit date.

Then we can join those columns of interest back into the main frame at every visit of a patient

then we can exclude all visits post a change in medication for the sake of modelling

```{r}
icahvisitsotherthanhydrocortisonetoextract <- icahvisitsotherthanhydrocortisone[,c("Register.ID...Record", "visitdate")]
icahvisitsotherthanhydrocortisonetojoin <- icahvisitsotherthanhydrocortisonetoextract %>% group_by(Register.ID...Record) %>% slice_min(visitdate, n=1, with_ties=F)
nrow(icahvisitsotherthanhydrocortisonetojoin)

names(icahvisitsotherthanhydrocortisonetojoin)[names(icahvisitsotherthanhydrocortisonetojoin)=="visitdate"] <- "firstdateothermedication"

icahalldatawithothermedicationdate <- left_join(icahalldata, icahvisitsotherthanhydrocortisonetojoin, by = "Register.ID...Record")

icahalldatawithothermedicationdate$visitaftermedicationotherthanhydrocortisonestarted <- 
  ifelse(icahalldatawithothermedicationdate$visitdate > icahalldatawithothermedicationdate$firstdateothermedication, 1, 0)
#now we need to make sure that anyone who doesn't have a firstdateothermedication (because they've always been on hydrocortisone) are also coded a zero
icahalldatawithothermedicationdate$visitaftermedicationotherthanhydrocortisonestarted <-
  ifelse(is.na(icahalldatawithothermedicationdate$visitaftermedicationotherthanhydrocortisonestarted), 
         0,
         icahalldatawithothermedicationdate$visitaftermedicationotherthanhydrocortisonestarted)

allvisitsafterothermedication <- icahalldatawithothermedicationdate %>%
filter(visitaftermedicationotherthanhydrocortisonestarted==1)
nrow(allvisitsafterothermedication)

allvisitshydrocorrtisoneafterothermedication <- allvisitsafterothermedication %>% filter(medicine=="hydrocortisone")

nrow(allvisitshydrocorrtisoneafterothermedication)

icahalldata <- icahalldatawithothermedicationdate
```

so 23 visits are people that have hydrocortisone after they've had something else
we now have the column visitaftermedicationotherthanhydrocortisonestarted which tells us they have previously taken a glucocorticoid other than hydrocortisone

this allows us to filter out people who flit back to hydrocortisone

it does also allow us to keep in the visit where someone is started on prednisolone or something else, as the biometrics at that visit will still be valid as they won't have yet started that medication


****************************************

coding visit numbers for each patient and time between visits

****************************************

create a visitnumber column to allow us to figure out whether a patient is on their first visit where data has been put into the registry

```{r}

icahalldata <- icahalldata[order(icahalldata$Register.ID...Record,icahalldata$visitdate),]
icahalldata$visitnumber <- 
  ave(icahalldata$agetouse, icahalldata$Register.ID...Record, FUN = seq_along)


```

create a lag column of the visitdate, correct it if it is the first visit, then subtract lag visit date from visit date

```{r}
icahalldata$lagvisitdate <- lag(icahalldata$visitdate)
icahalldata$lagvisitdate <- ifelse(icahalldata$visitnumber==1, NA, icahalldata$lagvisitdate)
icahalldata$lagvisitdate <- as.POSIXct(icahalldata$lagvisitdate, origin="1970-01-01")
icahalldata$yearssincepreviousvisit <- difftime(icahalldata$visitdate , icahalldata$lagvisitdate , units="days") / 365.25

```



```{r}
icahalldatatolookat <- icahalldata[,c("Register.ID...Record", "visitdate", "visitnumber", "lagvisitdate", "yearssincepreviousvisit")]
```

******************************

extrapolating medication through visits where the medication wasn't changed cocl cocl

******************************

luckily the 'has treatment changed column' is completed very well. We may therefore have biometric data but 'no' dose data, but we do know that the dose hasn't changed. We can therefore fill in visits where specific dose data hasn't been entered, but we know that the dose hasn't changed

so if treatment has changed yes, we want to compare whether it is different to last visit

get a lag absolute dose column
```{r}
icahalldata$lagtotaldose <- lag(icahalldata$totaldose)
icahalldata$lagtotaldose <- ifelse(
  icahalldata$visitnumber==1, NA , icahalldata$lagtotaldose )
icahalldata$laglagtotaldose <- lag(lag(icahalldata$totaldose))
icahalldata$laglagtotaldose <- ifelse(
  icahalldata$visitnumber<=2, NA , icahalldata$laglagtotaldose )
icahalldata$laglaglagtotaldose <- lag(lag(lag(icahalldata$totaldose)))
icahalldata$laglaglagtotaldose <- ifelse(
  icahalldata$visitnumber<=3, NA , icahalldata$laglaglagtotaldose )
icahalldata$laglaglaglagtotaldose <- lag(lag(lag(lag(icahalldata$totaldose))))
icahalldata$laglaglaglagtotaldose <- ifelse(
  icahalldata$visitnumber<=4, NA , icahalldata$laglaglaglagtotaldose )
icahalldata$laglaglaglaglagtotaldose <- lag(lag(lag(lag(lag(icahalldata$totaldose)))))
icahalldata$laglaglaglaglagtotaldose <- ifelse(
  icahalldata$visitnumber<=5, NA , icahalldata$laglaglaglaglagtotaldose )


```

this frame clearly shows what is going on. The dose that is entered is the current dose going forward. Patient may have no dose entered, but they may have has treatment changed since last visit marked as 'no', in which case the total dose will be the same as the previous dose. We could therefore gain some extra dose data

create totaldoseextrapolated, which will insert the same dose as the previous visit if the treatment hasn't changed, we aren't at the first visit and the totaldose column isn't populated. This uses 5 lag columns, so a patient can be on the same dose for 5 visits.

After that it is considered that the dose information is too old to be reliable if it is more than 5 visits ago. 

```{r}
icahalldata$totaldoseextrapolated <- icahalldata$totaldose

icahalldata$totaldoseextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$totaldoseextrapolated) ,
  icahalldata$lagtotaldose , 
  icahalldata$totaldoseextrapolated )

icahalldata$totaldoseextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$totaldoseextrapolated) ,
  icahalldata$laglagtotaldose , 
  icahalldata$totaldoseextrapolated )

icahalldata$totaldoseextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$totaldoseextrapolated) ,
  icahalldata$laglaglagtotaldose , 
  icahalldata$totaldoseextrapolated )

icahalldata$totaldoseextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$totaldoseextrapolated) ,
  icahalldata$laglaglaglagtotaldose , 
  icahalldata$totaldoseextrapolated )

icahalldata$totaldoseextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$totaldoseextrapolated) ,
  icahalldata$laglaglaglaglagtotaldose , 
  icahalldata$totaldoseextrapolated )


```

we now have totaldoseextrapolated which gives us extra data. I also want a previoustotaldoseextrapolated

```{r}
icahalldata$previoustotaldoseextrapolated <- lag(icahalldata$totaldoseextrapolated)
icahalldata$previoustotaldoseextrapolated <-
  ifelse(icahalldata$visitnumber==1, NA, icahalldata$previoustotaldoseextrapolated)
```

we also need a medicine type extrapolated along with that to make sure we are talking about hydrcortisone, or to convert to hydrocortisone equivalent

get a lag medicine column
```{r}
icahalldata$lagmedicine <- lag(icahalldata$medicine)
icahalldata$lagmedicine <- ifelse(
  icahalldata$visitnumber==1, NA , icahalldata$lagmedicine )

icahalldata$laglagmedicine <- lag(lag(icahalldata$medicine))
icahalldata$laglagmedicine <- ifelse(
  icahalldata$visitnumber<=2, NA , icahalldata$laglagmedicine )

icahalldata$laglaglagmedicine <- lag(lag(lag(icahalldata$medicine)))
icahalldata$laglaglagmedicine <- ifelse(
  icahalldata$visitnumber<=3, NA , icahalldata$laglaglagmedicine )

icahalldata$laglaglaglagmedicine <- lag(lag(lag(lag(icahalldata$medicine))))
icahalldata$laglaglaglagmedicine <- ifelse(
  icahalldata$visitnumber<=4, NA , icahalldata$laglaglaglagmedicine )

icahalldata$laglaglaglaglagmedicine <- lag(lag(lag(lag(lag(icahalldata$medicine)))))
icahalldata$laglaglaglaglagmedicine <- ifelse(
  icahalldata$visitnumber<=5, NA , icahalldata$laglaglaglaglagmedicine )


```

create medicineextrapolated, which will insert the same dose as the previous visit if the treatment hasn't changed, we aren't at the first visit and the medicine column isn't populated. This uses 5 lag columns, so a patient can be on the same medicine for 5 visits. After that it is considered that the dose information is too old to be reliable if it is more than 5 visits ago. 

```{r}
icahalldata$medicineextrapolated <- icahalldata$medicine

icahalldata$medicineextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$medicineextrapolated) ,
  icahalldata$lagmedicine , 
  icahalldata$medicineextrapolated )

icahalldata$medicineextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$medicineextrapolated) ,
  icahalldata$laglagmedicine , 
  icahalldata$medicineextrapolated )

icahalldata$medicineextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$medicineextrapolated) ,
  icahalldata$laglaglagmedicine , 
  icahalldata$medicineextrapolated )

icahalldata$medicineextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$medicineextrapolated) ,
  icahalldata$laglaglaglagmedicine , 
  icahalldata$medicineextrapolated )

icahalldata$medicineextrapolated <- ifelse(
  icahalldata$Has.treatment.changed.since.last.visit...Current.Medication == "No" &
    is.na(icahalldata$medicineextrapolated) ,
  icahalldata$laglaglaglaglagmedicine , 
  icahalldata$medicineextrapolated )


```


**************************************

floor age

**************************************

Now create a flooragetouse 

Note that using a floor age below 1 of zero is not very helpful. This code will take anyone between 6 months and 1 year and make their floor age 0.5
```{r}
icahalldata$flooragetouse <- floor(icahalldata$agetouse)
#create strictfloorage so we have something to plot
icahalldata$strictfloorage <- floor(icahalldata$agetouse)
icahalldata$flooragetouse <- ifelse(icahalldata$agetouse >=0.5 & icahalldata$agetouse <1,
                                      0.5,
                                      icahalldata$flooragetouse)
floorages <- as.data.frame(freq(icahalldata$flooragetouse))

```

**************************************

age bracket coding

**************************************

Create a coded column for those under and over 12
```{r}
icahalldata$age12andover <- ifelse(icahalldata$agetouse <12 ,
                                 0,
                                 NA)
icahalldata$age12andover <- ifelse(icahalldata$agetouse >=12 ,
                                 1,
                                 icahalldata$age12andover)


icahalldata$age12andover <- as.factor(icahalldata$age12andover )
```

*******************

Minimum and maximum age and time in registry

*****************************

Because patients are disproportionately recorded as having a date of birth on 1st January, this code presumes that the year of birth is correct, but that the day and month aren't. We calculate an oldest age possible taking into account their youngest visit, and a youngest age possible. 
```{r}
icahalldataorderedbyage <- icahalldata[order(icahalldata$Register.ID...Record, icahalldata$agetouse),]

icaholdestdata   <- icahalldataorderedbyage %>% group_by(Register.ID...Record) %>% slice_max(agetouse, n=1, with_ties=F)

icahyoungestdata <- icahalldataorderedbyage %>% group_by(Register.ID...Record) %>% slice_min(agetouse, n=1, with_ties=F)

icaholdestage    <- icaholdestdata[, c("Register.ID...Record", "agetouse")]
names(icaholdestage)[names(icaholdestage)=="agetouse"] <- "oldestageofpatient"

icahyoungestage  <- icahyoungestdata[, c("Register.ID...Record", "agetouse")]
names(icahyoungestage)[names(icahyoungestage)=="agetouse"] <- "youngestageofpatient"
```

now you can join that in to the main frame and calculate the time in the registry

```{r}
icahalldata <- left_join(icahalldata, icaholdestage, by="Register.ID...Record")
icahalldata <- left_join(icahalldata, icahyoungestage, by="Register.ID...Record")
icahalldata$yearsinregistry <- icahalldata$oldestageofpatient - icahalldata$youngestageofpatient
```

*********************************************

Age categories

**********************************************

I also want some categories for my ages

```{r}
icahalldata$flooragecategory <- ifelse(icahalldata$flooragetouse < 5, "aunder5", NA)
icahalldata$flooragecategory <- 
  ifelse(icahalldata$flooragetouse >= 5 & icahalldata$flooragetouse < 10, "b5to10", icahalldata$flooragecategory)
icahalldata$flooragecategory <- 
  ifelse(icahalldata$flooragetouse >= 10 & icahalldata$flooragetouse < 15, "c10to15", icahalldata$flooragecategory)
icahalldata$flooragecategory <- 
  ifelse(icahalldata$flooragetouse >= 15 & icahalldata$flooragetouse < 20, "d15to20", icahalldata$flooragecategory)
```

```{r}
icahalldatabackup578 <- icahalldata
freqtocheck1052 <- freq(icahalldatabackup578$idpastevisitdate)
```


*********************************************

Calculation of mid parental height, target height

*********************************************

mid parental height is simply the average of the parent heights
family target height is the mid parental height adjusted for sex of the child
```{r}
icahalldata$midparentalheight <- 
  (icahalldata$Mother.s.height..cm....Family + icahalldata$Father.s.height..cm....Family) / 2

icahalldata$familytargetheight <- 
  ifelse(icahalldata$Sex.at.birth...Birth=="Male", 
         icahalldata$midparentalheight+6.5, 
         NA)
icahalldata$familytargetheight <- 
  ifelse(icahalldata$Sex.at.birth...Birth=="Female", 
         icahalldata$midparentalheight-6.5, 
         icahalldata$familytargetheight)
```


*********************************************

Bone age and difference with chronological age

**********************************************

Bone age is just reported as a single year

Method is:

Greulich & Pyle: 581, TW20: 17, Radius-ulna-short bone: 6

```{r}
icahalldata$boneminuschronological <- 
  icahalldata$Bone.age.result..years....Bone.health.and.maturation - icahalldata$agetouse
```

```{r}

```

how does bone age change with age within patients? quick LMEM:

```{r}
bonedata <- icahalldata[!is.na(icahalldata$Bone.age.result..years....Bone.health.and.maturation),]
boneagemodel <- lmer(Bone.age.result..years....Bone.health.and.maturation ~ 
                      agetouse +
                      (1 | Register.ID...Record) +
                       (1 | Centre.Name...Centre),
                      data= bonedata, REML=F)
summary(boneagemodel)
ranova(boneagemodel)
bonedata$bone <- predict(boneagemodel)

ggplot(data=bonedata, aes(x=agetouse, y= Bone.age.result..years....Bone.health.and.maturation)) + geom_point() + geom_smooth() + xlim(0,20) + ylim(0,20) + geom_abline(data=NULL, mapping=NULL, size=3 , aes(), slope=1, intercept=0 , colour="green") +  geom_line(aes(y=bone, group=Register.ID...Record), alpha=1, colour="black") 
```

```{r}
bonedata <- icahalldata[!is.na(icahalldata$Bone.age.result..years....Bone.health.and.maturation),]
boneagemodel <- lmer(Bone.age.result..years....Bone.health.and.maturation ~ 
                      agetouse + I(agetouse^2) +
                      (1 | Register.ID...Record) +
                       (1 | Centre.Name...Centre),
                      data= bonedata, REML=F)
summary(boneagemodel)
ranova(boneagemodel)
bonedata$bone <- predict(boneagemodel)

ggplot(data=bonedata, aes(x=agetouse, y= Bone.age.result..years....Bone.health.and.maturation)) + geom_point() + geom_smooth() + xlim(0,20) + ylim(0,20) + geom_abline(data=NULL, mapping=NULL, size=3 , aes(), slope=1, intercept=0 , colour="green") +  geom_line(aes(y=bone, group=Register.ID...Record), alpha=1, colour="black") 
```
it actually looks best like a quadratic relationship, which is really weird and completely not what the neurocrine are saying

*************************

calculation of z scores and blood pressure - to run through growth analyser and online calculators

***********************

WHO normative data is available. They also give out the code for an r macro. I struggled to import this directly, so instead have used the same macro via the following website:

https://apps.cpeg-gcep.net/BPz_cpeg/

To use this website, we first must pull out the appropriate columsn from our complete data frame of icahalldata and name them appropriately:
```{r}
biometrics <- icahalldata[,c("assessment_id", "agetouse", "sex", "Weight..kg....CAH.Longitudinal.Data", "Height..cm....CAH.Longitudinal.Data", "Systolic..mmHg....CAH.Longitudinal.Data", "Diastolic..mmHg....CAH.Longitudinal.Data", "midparentalheight", "familytargetheight")]

names(biometrics)[names(biometrics)=="assessment_id"] <- "id"
names(biometrics)[names(biometrics)=="agetouse"] <- "age"
names(biometrics)[names(biometrics)=="Weight..kg....CAH.Longitudinal.Data"] <- "weight"
names(biometrics)[names(biometrics)=="Height..cm....CAH.Longitudinal.Data"] <- "height"
names(biometrics)[names(biometrics)=="Systolic..mmHg....CAH.Longitudinal.Data"] <- "sbp"
names(biometrics)[names(biometrics)=="Diastolic..mmHg....CAH.Longitudinal.Data"] <- "dbp"

biometrics$bmi <- biometrics$weight / (biometrics$height/100 * biometrics$height/100 )
biometrics$agemons <- biometrics$age * 12
```

then we write the file to csv
```{r}
write.csv(biometrics, "biometrics.csv", row.names = F)
```

some of the calculators don't want na in any of the important columns, so we need to filter

```{r}
biometricsnona <- biometrics[!is.na(biometrics$id), ]
biometricsnona <- biometricsnona[!is.na(biometricsnona$sex), ]
biometricsnona <- biometricsnona[!is.na(biometricsnona$agemons), ]

write.csv(biometricsnona, "biometricsnona.csv", row.names = F)
```

Note that some of them throw errors

the blood pressure error is:

Data include subjects < 1 years or > 18 years; please revise.
Missing values are not allowed for id, sex, and agemons. Please revise.

so let's filter the data to get blood pressures

```{r}
biometrics1to18 <- biometrics %>% filter(age >= 2 & age <= 18)
biometrics1to18nona <- biometrics1to18[!is.na(biometrics1to18$id), ]

biometrics1to18nona <- biometrics1to18nona[!is.na(biometrics1to18nona$sex), ]
biometrics1to18nona <- biometrics1to18nona[!is.na(biometrics1to18nona$agemons), ]

write.csv(biometrics1to18nona, "biometrics1to18nona.csv", row.names = F)
```

```{r}
icahalldatabackup702 <- icahalldata
freqtocheck702 <- freq(icahalldata$assessment_id)
```
*************************

HERE IS WHERE YOU NEED TO TAKE THAT csv file produced of blood pressure z scores, and load it into the online calculators

*************************

now after the zscores have been calculated using the online calculator and exported into csv files, we can upload them into this code in r. You just need to rename the output file from the online calculators appropriately, then put them into the folder "outputfilestoreload". These also include results from the growth analyser produced by Irina:


*************************

HERE IS WHERE RE RELOAD OUTPUT FILES

*************************

```{r}
whozscores0to5        <- read.csv("./outputfilestoreload/2021-03-21whozscores0to5.csv")
whozscores5to19       <- read.csv("./outputfilestoreload/2021-03-21whozscores0to5whozscores5to19.csv")
aapnewbpzscores       <- read.csv("./outputfilestoreload/2021-03-21aapbpscores.csv")
growthanalyserzscores <- read.csv("./outputfilestoreload/2021-03-21biometricsgrowthanalyser.csv", colClasses=c("ï..id"="character"))

#aapnewbpzscores$systolicpercentile
```

the column names of these columns are not very descriptive, so let's change them to make sure we know what they mean. Then we can join into our icahalldata frame

the description of what is created for whozscores 0to5 is:

The WHO 2006 igrowup R macro (2013-05-16) will then calculate Z-scores (z...) and out-of-range warning flags (f...) for BMI-for-age (zbmi), weight-for-length (zwfl), weight-for-age (zwei), height-for-age (zlen), head-circumference-for-age (zhc), as well as arm circumference (zac), triceps skin fold (zts), and subcapsular skin fold (zss) . Once results are displayed, download them by clicking the <Download> button, which will typically save them to your browser's Download folder with 'out_' prepended to the original dataset name.

let's remove columns that have no use to us. The measure column is length versus height, but our data doesn't tell us this so the algorithm is simply using an automated adjustment depending on how old the kids are
```{r}
drop <- c("measure", "sub", "head", "muac", "clenhei", "musc", "tri", "zht", "zac", "zts", "zss", "zhc", "fht", "fac", "fts", "fss", "fhc", "oedema")
whozscores0to5 <-  whozscores0to5[,!(names(whozscores0to5) %in% drop)]
```

let's rename the columns before joining so that they make sense
```{r}
names(whozscores0to5)[names(whozscores0to5)=="zbmi"] <- "zbmiforage"
names(whozscores0to5)[names(whozscores0to5)=="zwfl"] <- "zweightforheight"
names(whozscores0to5)[names(whozscores0to5)=="zwei"] <- "zweightforage"
names(whozscores0to5)[names(whozscores0to5)=="zlen"] <- "zheightforage"
names(whozscores0to5)[names(whozscores0to5)=="fbmi"] <- "flagbmiforage"
names(whozscores0to5)[names(whozscores0to5)=="fwfl"] <- "flagweightforheight"
names(whozscores0to5)[names(whozscores0to5)=="fwei"] <- "flagweightforage"
names(whozscores0to5)[names(whozscores0to5)=="flen"] <- "flagheightforage"
```

this calculator gives us z scores for everyone up to 61 months old, so can filter that later

next sort out the 5 to 19 frame. The instructions are:

The WHO 2007 R macro (2013-05-16) will then calculate Z-scores (z...) and out-of-range warning flags (f...) for BMI-for-age (zbfa), weight-for-age (zwfa), and height-for-age (zhfa). Once results are displayed, download them by clicking the <Download> button, which will typically save them to your Download folder with 'out_' prepended to the original dataset name.

we get rid of oedema - this isn't monitored in our patients so all patients are simply classed as not having oedema
```{r}
drop <- c("oedema")
whozscores5to19 <-  whozscores5to19[,!(names(whozscores5to19) %in% drop)]

```


```{r}
icahalldatabackup764 <- icahalldata
freqtocheck764 <- freq(icahalldata$assessment_id)
icahalldata <- icahalldatabackup764
```

let's rename the columns
```{r}
names(whozscores5to19)[names(whozscores5to19)=="zbfa"] <- "zbmiforage"
names(whozscores5to19)[names(whozscores5to19)=="zwfa"] <- "zweightforage"
names(whozscores5to19)[names(whozscores5to19)=="zhfa"] <- "zheightforage"
names(whozscores5to19)[names(whozscores5to19)=="fbfa"] <- "flagbmiforage"
names(whozscores5to19)[names(whozscores5to19)=="fwfa"] <- "flagweightforage"
names(whozscores5to19)[names(whozscores5to19)=="fhfa"] <- "flagheightforage"
```

this calculator gives z scores for everyone over 61 months old, so can filter that also 

as long as we filter the ages the same across both then we won't have a problem when joining

filter the frames either side of 61 months
```{r}
whozscores0to5tojoin <- whozscores0to5 %>% filter(agemons <=61)
whozscores5to19tojoin <- whozscores5to19 %>% filter(agemons > 61)
```

```{r}

whozscoresboth <- plyr::rbind.fill(whozscores0to5tojoin, whozscores5to19tojoin)
whozscoresboth$sex <- as.numeric(whozscoresboth$sex)
```

lets sort out the blood pressure data frame. the website informs us that this is what we get from this calculator:

Blood pressure measurements are rounded to the nearest whole number before calculating percentiles. NB: Quantile regression is computationally intensive, since it must calculate centiles 1-99 for both SBP and DBP to compare with measured BP, and the code may (will) run slowly on large datasets. Dr. Rosner's algorithm does not assign BP percentiles for outlier heights i.e. HtZ < -3.09 (0.1%) or HtZ > 3.09 (99.9%), which are returned as ht1 and ht2, respectively. The output file also contains the variable 'stage', which assigns a diagnosis of normal, elevated, stage 1, or stage 2 based on the 2017 AAP guidelines, which represent a mixture of percentiles and absolute thresholds:

We also return sex-, age-, and height-specific 90th and 95th percentile values for SBP (fxsys) and DBP (fxdia). Users should exercise caution and confirm important results using published charts, particularly for assignment of BP stages. For example, in the table above, a small number of children < 13y will be normal with BP < 90th percentile, but have high BP because they exceed static thresholds (> 120/80). This should not be confused with another statistical issue inherent in quantile regression, which is well-described by the WHO Expert Panel (Borghi, 2006): Since each centile is fitted separately without additional constraints, centile curves may actually cross, and it is theoretically possible for the 95th percentile to be less than the 90th percentile! While we have yet to find an example of 'crossed percentiles', we have seen cases where the 87th and 90th percentiles are equal, which may lead to a diagnosis of elevated blood pressure even though the assigned percentile is less than the 90th. As recommended by the AAP subcommittee, we generally apply the 'lesser of' condition when dealing with ambiguity.

You may be wondering why the age-range for these charts begins at age 2y when the AAP report includes tables for children as young as 1y. The calculator will in fact return percentile estimates for children as young as 1y. However, these results are based on measurements in a very small number of children < 2y of age (Table 1, Rosner 2008). Caveat Emptor.

```{r}
names(aapnewbpzscores)[names(aapnewbpzscores)=="outlier"] <- "bpoutlier"
names(aapnewbpzscores)[names(aapnewbpzscores)=="ht1"]     <- "bpcentile0.1"
names(aapnewbpzscores)[names(aapnewbpzscores)=="ht2"]     <- "bpcentile99.9"
names(aapnewbpzscores)[names(aapnewbpzscores)=="syspct"]  <- "systolicpercentile"
names(aapnewbpzscores)[names(aapnewbpzscores)=="diapct"]  <- "diastolicpercentile"
names(aapnewbpzscores)[names(aapnewbpzscores)=="fxsys90"] <- "90thcentilesystolic"
names(aapnewbpzscores)[names(aapnewbpzscores)=="fxsys95"] <- "95thcentilesystolic"
names(aapnewbpzscores)[names(aapnewbpzscores)=="fxdia90"] <- "90thcentilediastolic"
names(aapnewbpzscores)[names(aapnewbpzscores)=="fxdia95"] <- "95thcentilediastolic"
names(aapnewbpzscores)[names(aapnewbpzscores)=="stage"]   <- "aapbpstage"
```

now join those frames. Let's get rid of all the columns in appnewbpzscores that would duplicate things, and just join by the id that we know is unique
```{r}
aapnewbpzscores$sex <- NULL
aapnewbpzscores$weight <- NULL
aapnewbpzscores$height <- NULL
aapnewbpzscores$sbp <- NULL
aapnewbpzscores$dbp <- NULL
aapnewbpzscores$agemons <- NULL
aapnewbpzscores$midparentalheight <- NULL
aapnewbpzscores$familytargetheight <- NULL
aapnewbpzscores$bmi <- NULL

whozscoreswithbp <- left_join(whozscoresboth, aapnewbpzscores, by = "id")
```

```{r}
icahalldatabackup814 <- icahalldata
freqtocheck815 <- freq(icahalldata$assessment_id)

```

let's join my z scores to the main data file

get rid of some unnecessary columns from the whoscoreswithbp to make it an easier join with less memomry

```{r}
whozscoreswithbp$sex <- NULL
whozscoreswithbp$midparentalheight <- NULL
whozscoreswithbp$familytargetheight <- NULL
whozscoreswithbp$systolicpercentile
```

```{r}
icahalldata <- left_join(icahalldata, whozscoreswithbp, by=c("assessment_id"="id"))
```

now join the growth analyser z scores

```{r}
zscores <- left_join(icahalldata, growthanalyserzscores, by=c("assessment_id"= "ï..id" ) )

write.csv(zscores, "zscores.csv")

icahalldata <- zscores


```

now we can create blood pressure z scores from percentiles using the r function qnorm
```{r}
icahalldata$systoliczscore <- qnorm(icahalldata$systolicpercentile)
icahalldata$diastoliczscore <- qnorm(icahalldata$diastolicpercentile)
```

we now have weightanalyserzscore, heightanalyserzscore and bmianalyserzscore as well as familytargetheightzscore that comes from the growth analyser

Now we have z scores, we can exclude ridiculous z scores as one of the simplest exclusion mechanisms

the who data flags things with their exclusions so you could use the flags to do this. I'd rather make it bespoke so we can enter our own exclsuion z scores

*****************************************

Creating change of height sds statistics

*******************************************

first we take all visits with height
first create a lag column of the person id
create a column of different person
then a lag column of the height analyser z score

```{r}
icahalldatawithheightanalyserzscore <- subset(icahalldata, !is.na(heightanalyserzscore))
icahalldatawithheightanalyserzscore$lagid <- lag(icahalldatawithheightanalyserzscore$Register.ID...Record)
icahalldatawithheightanalyserzscore$lagheightanalyserzscore <- lag(icahalldatawithheightanalyserzscore$heightanalyserzscore)
icahalldatawithheightanalyserzscore$lagagetouse <- lag(icahalldatawithheightanalyserzscore$agetouse)
icahalldatawithheightanalyserzscore$sameidcode <- 
  ifelse(icahalldatawithheightanalyserzscore$Register.ID...Record == icahalldatawithheightanalyserzscore$lagid , 1, 0)
icahalldatawithheightanalyserzscore$changeinheightanalyserzscore <- icahalldatawithheightanalyserzscore$heightanalyserzscore - icahalldatawithheightanalyserzscore$lagheightanalyserzscore

```

we want to know the change over which this occured

```{r}
icahalldatawithheightanalyserzscore$timeperiodbetweenheightscores <- icahalldatawithheightanalyserzscore$agetouse - icahalldatawithheightanalyserzscore$lagagetouse
```

now we can get change in height z score per year

```{r}
icahalldatawithheightanalyserzscore$changeinheightanalyserzscoreperyear <- icahalldatawithheightanalyserzscore$changeinheightanalyserzscore / icahalldatawithheightanalyserzscore$timeperiodbetweenheightscores

icahalldatawithheightanalyserzscore$sameidcode2 <- icahalldatawithheightanalyserzscore$sameidcode 

icahalldatawithheightanalyserzscore$changeinheightanalyserzscoreperyear <- ifelse(icahalldatawithheightanalyserzscore$sameidcode == 0 , NA, icahalldatawithheightanalyserzscore$changeinheightanalyserzscoreperyear)

icahalldatawithheightanalyserzscore <- icahalldatawithheightanalyserzscore[,c("assessment_id", "changeinheightanalyserzscore", "changeinheightanalyserzscoreperyear")]
```

```{r}
icahalldatabackup911<- icahalldata
icahalldata <- icahalldatabackup911
icahalldata <- left_join(icahalldata , icahalldatawithheightanalyserzscore, by="assessment_id")

```



now we can plot the points that have varying levels of flag change if you would like - this creates various tif files:

``{r}
for (i in (1:10)){
flagchange <- i
icahalldatawithheightanalyserzscore$flagheight <- ifelse(icahalldatawithheightanalyserzscore$changeinheightanalyserzscoreperyear > flagchange | icahalldatawithheightanalyserzscore$changeinheightanalyserzscoreperyear < -(flagchange), 0, 1)
icahalldatawithheightanalyserzscore$flagheight <- as.factor(icahalldatawithheightanalyserzscore$flagheight)

plottotal <- ggplot(icahalldatawithheightanalyserzscore, aes(x=agetouse,y=heightanalyserzscore, colour=flagheight)) + geom_point()

plotremoved <- ggplot(subset(icahalldatawithheightanalyserzscore, flagheight==1), aes(x=agetouse,y=heightanalyserzscore)) + geom_point()
ggsave(filename=paste0("plottotal", i, ".tif"), path="C:/Users/Thinkpad/", plot = plottotal, device="tiff",  width=10, height=5.625, compression = "lzw")
ggsave(filename=paste0("plotremoved", i, ".tif"), path="C:/Users/Thinkpad/", plot = plotremoved, device="tiff",  width=10, height=5.625, compression = "lzw")
}
``

*********************************

delta score predicted height differential - let's change this so a higher number means a shorter child  

***********************************

let's calculate the delta score for a patient, as their familytargetheightzscore - patient height z score - CHANGED to patient height z score - familytargetheightzscore. So a positive delta height score means the amount they are above achieving their height by.

let's do this raw, and also do tthis with the cheetham formula for regression to the mean

the hypothesis we are testing, is that a patient with cah will have a LOW delta score when pre pubescent (i.e. negative), that rises up to puberty and then a decreasing delta score when post pubescent. The more extreme these values, the worse the control 

```{r}
icahalldata$familytargetheightzscoreregressed <- 0.51*icahalldata$familytargetheightzscore + 0.015

icahalldata$deltascore <- icahalldata$heightanalyserzscore - icahalldata$familytargetheightzscore

icahalldata$deltascoreregressed <- icahalldata$heightanalyserzscore - icahalldata$familytargetheightzscoreregressed

```

On average, these kids are losing a z score of about 1 from their familytargetheight

*********************************************

Calculations of variables - BSA, total dose per BSA

**********************************************

calculate dose per BSA. Use the mosteller formula to calculate body surface area. Alter the ratios that you want to use for prednisolone and dexamethasone within the code below. 

We want to do this for just the total dose entered, and also for the totaldoseextrapolated, in case for any reason someone doesn't like the extrapolation in the future



```{r}
icahalldata$bsa <- 
  sqrt(icahalldata$Height..cm....CAH.Longitudinal.Data * icahalldata$Weight..kg....CAH.Longitudinal.Data /3600)

prednisoloneratio <- 4
dexamethasoneratio <- 25
prednisoneratio <- prednisoloneratio

icahalldata$hydrocortisoneequivalent <- 
  ifelse(icahalldata$medicine=="hydrocortisone", icahalldata$totaldose, NA)
icahalldata$hydrocortisoneequivalent <- 
  ifelse(icahalldata$medicine=="prednisolone", (icahalldata$totaldose * prednisoloneratio), icahalldata$hydrocortisoneequivalent)
icahalldata$hydrocortisoneequivalent <- 
  ifelse(icahalldata$medicine=="prednisone", (icahalldata$totaldose * prednisoneratio), 
         icahalldata$hydrocortisoneequivalent)
icahalldata$hydrocortisoneequivalent <- 
  ifelse(icahalldata$medicine=="dexamethasone", (icahalldata$totaldose * dexamethasoneratio), 
         icahalldata$hydrocortisoneequivalent)

icahalldata$hydrocortisoneperbsa <- icahalldata$hydrocortisoneequivalent / icahalldata$bsa

###########same for extrapolated doses
icahalldata$hydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$medicine=="hydrocortisone", icahalldata$totaldoseextrapolated, NA)
icahalldata$hydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$medicine=="prednisolone", (icahalldata$totaldoseextrapolated * prednisoloneratio), icahalldata$hydrocortisoneequivalentextrapolated)
prednisoneratio <- prednisoloneratio

icahalldata$hydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$medicine=="prednisone", (icahalldata$totaldoseextrapolated * prednisoneratio), 
         icahalldata$hydrocortisoneequivalentextrapolated)
icahalldata$hydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$medicine=="dexamethasone", (icahalldata$totaldoseextrapolated * dexamethasoneratio), 
         icahalldata$hydrocortisoneequivalentextrapolated)

icahalldata$hydrocortisoneperbsaextrapolated <- 
  icahalldata$hydrocortisoneequivalentextrapolated / icahalldata$bsa
```

Now we also want to convert previous dose. We already have a lag medicine column for this:

```{r}
icahalldata$lagid <- lag(icahalldata$Register.ID...Record)

icahalldata$sameidcode <- ifelse(icahalldata$Register.ID...Record == icahalldata$lagid , 1, 0)

icahalldata$samemedicinecode <- ifelse(icahalldata$medicine == icahalldata$lagmedicine , 1, 0)
#correct lag medicine if it is the first visit of a patient
icahalldata$lagmedicine <- ifelse (icahalldata$visitnumber==1, "firstrecordedmedicine", icahalldata$lagmedicine)
#then correct the first row
icahalldata[1,"lagmedicine"] <- "firstrecordedmedicine"

view <- icahalldata[,c("Register.ID...Record", "visitnumber", "agetouse", "medicine", "lagmedicine", "medicineextrapolated", "Has.treatment.changed.since.last.visit...Current.Medication")]


```

and a previous dose column using lag:
```{r}
icahalldata$previousdose <- lag(icahalldata$totaldose)
icahalldata$previousdose <-
  ifelse(icahalldata$visitnumber==1, NA, icahalldata$previousdose)

```

```{r}

icahalldata$previoushydrocortisoneequivalent <- 
  ifelse(icahalldata$lagmedicine=="hydrocortisone", icahalldata$previousdose, NA)


icahalldata$previoushydrocortisoneequivalent <- 
  ifelse(icahalldata$lagmedicine=="prednisolone", (icahalldata$previousdose * prednisoloneratio), 
         icahalldata$previoushydrocortisoneequivalent)

icahalldata$previoushydrocortisoneequivalent <- 
  ifelse(icahalldata$lagmedicine=="prednisone", (icahalldata$previousdose * prednisoneratio), 
         icahalldata$previoushydrocortisoneequivalent)

icahalldata$previoushydrocortisoneequivalent <- 
  ifelse(icahalldata$lagmedicine=="dexamethasone", (icahalldata$previousdose * dexamethasoneratio), 
         icahalldata$previoushydrocortisoneequivalent)

icahalldata$previoushydrocortisoneequivalent <-
  ifelse(icahalldata$visitnumber==1, NA, icahalldata$previoushydrocortisoneequivalent)
```

turn the hydrocortisone equivalent into a dose per bsa
```{r}
icahalldata$previoushydrocortisoneequivalentpercurrentbsa <- 
  icahalldata$previoushydrocortisoneequivalent / icahalldata$bsa


```

we want to do the same with the extrapolated data. to do that we need a lagmedicineextrapolated column

```{r}
icahalldata$lagmedicineextrapolated <- lag(icahalldata$medicineextrapolated)
icahalldata$lagmedicineextrapolated <- ifelse(
  icahalldata$visitnumber==1, NA , icahalldata$lagmedicineextrapolated )
```


```{r}
icahalldata$previoushydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$lagmedicineextrapolated=="hydrocortisone", icahalldata$previoustotaldoseextrapolated, NA)

icahalldata$previoushydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$lagmedicineextrapolated=="prednisolone", (icahalldata$previoustotaldoseextrapolated * prednisoloneratio), 
         icahalldata$previoushydrocortisoneequivalentextrapolated)

icahalldata$previoushydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$lagmedicineextrapolated=="prednisone", (icahalldata$previoustotaldoseextrapolated * prednisoneratio), 
         icahalldata$previoushydrocortisoneequivalentextrapolated)

icahalldata$previoushydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$lagmedicineextrapolated=="dexamethasone", (icahalldata$previoustotaldoseextrapolated * dexamethasoneratio), 
         icahalldata$previoushydrocortisoneequivalentextrapolated)

icahalldata$previoushydrocortisoneequivalentextrapolated <- 
  ifelse(icahalldata$visitnumber==1, NA, icahalldata$previoushydrocortisoneequivalentextrapolated)
```

now calculate the relative previous extrapolated hydrocortisone dose per current bsa, and the same based on idealbsa later on after I've added idealbsa
```{r}
icahalldata$previoushydrocortisoneequivalentextrapolatedpercurrentbsa <- 
  icahalldata$previoushydrocortisoneequivalentextrapolated / icahalldata$bsa



```

I used to repeat this code with different ratios to try in multilevel models - refer to Before 06/2021 if you want those back, they take up a lot of space


******************

calculating fludrocortisone per bsa

********************

```{r}
icahalldata$fludrocortisoneperbsa <- icahalldata$fludroentereddose / icahalldata$bsa
```

We now need to add a zero into the column for patients that aren't treated with fludrocortisone

```{r}
icahalldata$fludrocortisoneperbsa <- 
  ifelse(icahalldata$Fludrocortisone...Current.Medication == "No" , 0, icahalldata$fludrocortisoneperbsa)
```


*****************************************

normal range for 17OH progesterone and androstenedione cocl

***************************************

Note that these ranges are incredibly contentious, and just being put in to graph later. An alternative is to use the maleandrostenedione normal ranges etc that come from kurchir 

```{r}
icahalldata$low17ohp <- 12
icahalldata$high17ohp <- 36

icahalldata$lowandrostenedione <- 1
icahalldata$highandrostenedione <- 10
```

calculate whether the dose is less than 10mg/m2 or 12mg/mg2 or more than 15 in separate columns
```{r}
icahalldata$hydrocortisoneperbsalessthan10 <- icahalldata$hydrocortisoneperbsacategory10 <- NA
icahalldata$hydrocortisoneperbsalessthan10 <- ifelse(icahalldata$hydrocortisoneperbsa<10, 1, icahalldata$hydrocortisoneperbsalessthan10)
icahalldata$hydrocortisoneperbsacategory10 <- ifelse(icahalldata$hydrocortisoneperbsa<10, "lessthan10", icahalldata$hydrocortisoneperbsacategory10)
icahalldata$hydrocortisoneperbsalessthan10 <- ifelse(icahalldata$hydrocortisoneperbsa>=10, 0, icahalldata$hydrocortisoneperbsalessthan10)

icahalldata$hydrocortisoneperbsa10to15 <- NA
icahalldata$hydrocortisoneperbsa10to15 <- ifelse(icahalldata$hydrocortisoneperbsa >=10 & icahalldata$hydrocortisoneperbsa<=15 , 1, icahalldata$hydrocortisoneperbsa10to15)
icahalldata$hydrocortisoneperbsacategory10 <- ifelse(icahalldata$hydrocortisoneperbsa >=10 & icahalldata$hydrocortisoneperbsa<=15 , "inrange10to15", icahalldata$hydrocortisoneperbsacategory10)
icahalldata$hydrocortisoneperbsa10to15 <- ifelse(icahalldata$hydrocortisoneperbsa <10 | icahalldata$hydrocortisoneperbsa>15 , 0, icahalldata$hydrocortisoneperbsa10to15)


icahalldata$hydrocortisoneperbsalessthan12 <- icahalldata$hydrocortisoneperbsacategory12 <- NA
icahalldata$hydrocortisoneperbsalessthan12 <- ifelse(icahalldata$hydrocortisoneperbsa<12, 1, icahalldata$hydrocortisoneperbsalessthan12)
icahalldata$hydrocortisoneperbsacategory12 <- ifelse(icahalldata$hydrocortisoneperbsa<12, "lessthan12", icahalldata$hydrocortisoneperbsacategory12)
icahalldata$hydrocortisoneperbsalessthan12 <- ifelse(icahalldata$hydrocortisoneperbsa>=12, 0, icahalldata$hydrocortisoneperbsalessthan12)


icahalldata$hydrocortisoneperbsa12to15 <- NA
icahalldata$hydrocortisoneperbsa12to15 <- ifelse(icahalldata$hydrocortisoneperbsa >=12 & icahalldata$hydrocortisoneperbsa<=15 , 1, icahalldata$hydrocortisoneperbsa12to15)
icahalldata$hydrocortisoneperbsacategory12 <- ifelse(icahalldata$hydrocortisoneperbsa >=12 & icahalldata$hydrocortisoneperbsa<=15, "inrange12to15", icahalldata$hydrocortisoneperbsacategory12)
icahalldata$hydrocortisoneperbsa12to15 <- ifelse(icahalldata$hydrocortisoneperbsa <12 | icahalldata$hydrocortisoneperbsa>15 , 0, icahalldata$hydrocortisoneperbsa12to15)

icahalldata$hydrocortisoneperbsagreaterthan15 <- NA
icahalldata$hydrocortisoneperbsagreaterthan15 <- ifelse(icahalldata$hydrocortisoneperbsa>15, 1, icahalldata$hydrocortisoneperbsagreaterthan15)
icahalldata$hydrocortisoneperbsacategory10 <- ifelse(icahalldata$hydrocortisoneperbsa>15, "greaterthan15", icahalldata$hydrocortisoneperbsacategory10)
icahalldata$hydrocortisoneperbsacategory12 <- ifelse(icahalldata$hydrocortisoneperbsa>15, "greaterthan15", icahalldata$hydrocortisoneperbsacategory12)
icahalldata$hydrocortisoneperbsagreaterthan15 <- ifelse(icahalldata$hydrocortisoneperbsa<=15, 0, icahalldata$hydrocortisoneperbsagreaterthan15)

icahalldata$hydrocortisoneperbsacategory10 <- ordered(icahalldata$hydrocortisoneperbsacategory10, levels=c("lessthan10", "inrange10to15", "greaterthan15"))
icahalldata$hydrocortisoneperbsacategory12 <- ordered(icahalldata$hydrocortisoneperbsacategory12, levels=c("lessthan12", "inrange12to15", "greaterthan15"))
```

do the same again with extrapolated values:


calculate whether the dose is less than 10mg/m2 or 12mg/mg2 or more than 15 in separate columns
```{r}
icahalldata$hydrocortisoneperbsaextrapolatedlessthan10 <- icahalldata$hydrocortisoneperbsaextrapolatedcategory10 <- NA
icahalldata$hydrocortisoneperbsaextrapolatedlessthan10 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated<10, 1, icahalldata$hydrocortisoneperbsaextrapolatedlessthan10)
icahalldata$hydrocortisoneperbsaextrapolatedcategory10 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated<10, "lessthan10", icahalldata$hydrocortisoneperbsaextrapolatedcategory10)
icahalldata$hydrocortisoneperbsaextrapolatedlessthan10 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated>=10, 0, icahalldata$hydrocortisoneperbsaextrapolatedlessthan10)

icahalldata$hydrocortisoneperbsaextrapolated10to15 <- NA
icahalldata$hydrocortisoneperbsaextrapolated10to15 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated >=10 & icahalldata$hydrocortisoneperbsaextrapolated<=15 , 1, icahalldata$hydrocortisoneperbsaextrapolated10to15)
icahalldata$hydrocortisoneperbsaextrapolatedcategory10 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated >=10 & icahalldata$hydrocortisoneperbsaextrapolated<=15 , "inrange10to15", icahalldata$hydrocortisoneperbsaextrapolatedcategory10)
icahalldata$hydrocortisoneperbsaextrapolated10to15 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated <10 | icahalldata$hydrocortisoneperbsaextrapolated>15 , 0, icahalldata$hydrocortisoneperbsaextrapolated10to15)


icahalldata$hydrocortisoneperbsaextrapolatedlessthan12 <- icahalldata$hydrocortisoneperbsaextrapolatedcategory12 <- NA
icahalldata$hydrocortisoneperbsaextrapolatedlessthan12 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated<12, 1, icahalldata$hydrocortisoneperbsaextrapolatedlessthan12)
icahalldata$hydrocortisoneperbsaextrapolatedcategory12 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated<12, "lessthan12", icahalldata$hydrocortisoneperbsaextrapolatedcategory12)
icahalldata$hydrocortisoneperbsaextrapolatedlessthan12 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated>=12, 0, icahalldata$hydrocortisoneperbsaextrapolatedlessthan12)


icahalldata$hydrocortisoneperbsaextrapolated12to15 <- NA
icahalldata$hydrocortisoneperbsaextrapolated12to15 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated >=12 & icahalldata$hydrocortisoneperbsaextrapolated<=15 , 1, icahalldata$hydrocortisoneperbsaextrapolated12to15)
icahalldata$hydrocortisoneperbsaextrapolatedcategory12 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated >=12 & icahalldata$hydrocortisoneperbsaextrapolated<=15, "inrange12to15", icahalldata$hydrocortisoneperbsaextrapolatedcategory12)
icahalldata$hydrocortisoneperbsaextrapolated12to15 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated <12 | icahalldata$hydrocortisoneperbsaextrapolated>15 , 0, icahalldata$hydrocortisoneperbsaextrapolated12to15)

icahalldata$hydrocortisoneperbsaextrapolatedgreaterthan15 <- NA
icahalldata$hydrocortisoneperbsaextrapolatedgreaterthan15 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated>15, 1, icahalldata$hydrocortisoneperbsaextrapolatedgreaterthan15)
icahalldata$hydrocortisoneperbsaextrapolatedcategory10 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated>15, "greaterthan15", icahalldata$hydrocortisoneperbsaextrapolatedcategory10)
icahalldata$hydrocortisoneperbsaextrapolatedcategory12 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated>15, "greaterthan15", icahalldata$hydrocortisoneperbsaextrapolatedcategory12)
icahalldata$hydrocortisoneperbsaextrapolatedgreaterthan15 <- ifelse(icahalldata$hydrocortisoneperbsaextrapolated<=15, 0, icahalldata$hydrocortisoneperbsaextrapolatedgreaterthan15)

icahalldata$hydrocortisoneperbsaextrapolatedcategory10 <- ordered(icahalldata$hydrocortisoneperbsaextrapolatedcategory10, levels=c("lessthan10", "inrange10to15", "greaterthan15"))
icahalldata$hydrocortisoneperbsaextrapolatedcategory12 <- ordered(icahalldata$hydrocortisoneperbsaextrapolatedcategory12, levels=c("lessthan12", "inrange12to15", "greaterthan15"))
```




calculate whether the ohp17.value is less than 12 or over 36

```{r}
icahalldata$ohp17lessthan12 <- icahalldata$ohp17category12 <- NA
icahalldata$ohp17lessthan12 <- ifelse(icahalldata$ohp17.value<12, 1, icahalldata$ohp17lessthan12)
icahalldata$ohp17category12 <- ifelse(icahalldata$ohp17.value<12, "lessthan12", icahalldata$ohp17category12)
icahalldata$ohp17lessthan12 <- ifelse(icahalldata$ohp17.value>=12, 0, icahalldata$ohp17lessthan12)

icahalldata$ohp1712to36 <- NA
icahalldata$ohp1712to36 <- ifelse(icahalldata$ohp17.value >=12 & icahalldata$ohp17.value<=36 , 1, icahalldata$ohp1712to36)
icahalldata$ohp17category12 <- ifelse(icahalldata$ohp17.value >=12& icahalldata$ohp17.value<=36 , "inrange12to36", icahalldata$ohp17category12)
icahalldata$ohp1712to36 <- ifelse(icahalldata$ohp17.value <12 | icahalldata$ohp17.value>36 , 0, icahalldata$ohp1712to36)

icahalldata$ohp17greaterthan36 <- NA
icahalldata$ohp17greaterthan36 <- ifelse(icahalldata$ohp17.value>36, 1, icahalldata$ohp17greaterthan36)
icahalldata$ohp17category12 <- ifelse(icahalldata$ohp17.value>36, "greaterthan36", icahalldata$ohp17category12)
icahalldata$ohp17greaterthan36 <- ifelse(icahalldata$ohp17.value<=36, 0, icahalldata$ohp17greaterthan36)

icahalldata$ohp17category12 <- ordered(icahalldata$ohp17category12, levels=c("lessthan12", "inrange12to36", "greaterthan36"))
```

calculate whether the ohp17.value is less than 500 or over 1000

```{r}
icahalldata$ohp17lessthan500 <- icahalldata$ohp17category500 <- NA
icahalldata$ohp17lessthan500 <- ifelse(icahalldata$ohp17.value<500, 1, icahalldata$ohp17lessthan500)
icahalldata$ohp17category500 <- ifelse(icahalldata$ohp17.value<500, "lessthan500", icahalldata$ohp17category500)
icahalldata$ohp17lessthan500 <- ifelse(icahalldata$ohp17.value>=500, 0, icahalldata$ohp17lessthan500)

icahalldata$ohp17500to1000 <- NA
icahalldata$ohp17500to1000 <- ifelse(icahalldata$ohp17.value >=500 & icahalldata$ohp17.value<=1000 , 1, icahalldata$ohp17500to1000)
icahalldata$ohp17category500 <- ifelse(icahalldata$ohp17.value >=500& icahalldata$ohp17.value<=1000 , "inrange500to1000", icahalldata$ohp17category500)
icahalldata$ohp17500to1000 <- ifelse(icahalldata$ohp17.value <500 | icahalldata$ohp17.value>1000 , 0, icahalldata$ohp17500to1000)

icahalldata$ohp17greaterthan1000 <- NA
icahalldata$ohp17greaterthan1000 <- ifelse(icahalldata$ohp17.value>1000, 1, icahalldata$ohp17greaterthan1000)
icahalldata$ohp17category500 <- ifelse(icahalldata$ohp17.value>1000, "greaterthan1000", icahalldata$ohp17category500)
icahalldata$ohp17greaterthan1000 <- ifelse(icahalldata$ohp17.value<=1000, 0, icahalldata$ohp17greaterthan1000)

icahalldata$ohp17category500 <- ordered(icahalldata$ohp17category500, levels=c("lessthan500", "inrange500to1000", "greaterthan1000"))
```

calculate whether the androstenedione.value is less than 100 or over 200

```{r}
icahalldata$androstenedionelessthan50 <- icahalldata$androstenedionecategory50 <- NA

icahalldata$androstenedionelessthan50 <- ifelse(icahalldata$andostenedione.value<50, 1, icahalldata$androstenedionelessthan50)
icahalldata$androstenedionecategory50 <- ifelse(icahalldata$andostenedione.value<50, "lessthan50", icahalldata$androstenedionecategory50)
icahalldata$androstenedionelessthan50 <- ifelse(icahalldata$andostenedione.value>=50, 0, icahalldata$androstenedionelessthan50)

icahalldata$androstenedione50to200 <- NA
icahalldata$androstenedione50to200 <- ifelse(icahalldata$andostenedione.value >=50 & icahalldata$andostenedione.value<=200 , 1, icahalldata$androstenedione50to200)
icahalldata$androstenedionecategory50 <- ifelse(icahalldata$andostenedione.value >=50& icahalldata$andostenedione.value<=200 , "inrange50to200", icahalldata$androstenedionecategory50)
icahalldata$androstenedione50to200 <- ifelse(icahalldata$andostenedione.value <50 | icahalldata$andostenedione.value>200 , 0, icahalldata$androstenedione50to200)

icahalldata$androstenedionegreaterthan200 <- NA
icahalldata$androstenedionegreaterthan200 <- ifelse(icahalldata$andostenedione.value>200, 1, icahalldata$androstenedionegreaterthan200)
icahalldata$androstenedionecategory50 <- ifelse(icahalldata$andostenedione.value>200, "greaterthan200", icahalldata$androstenedionecategory50)
icahalldata$androstenedionegreaterthan200 <- ifelse(icahalldata$andostenedione.value<=200, 0, icahalldata$androstenedionegreaterthan200)

icahalldata$androstenedionecategory50 <- ordered(icahalldata$androstenedionecategory50, levels=c("lessthan50", "inrange50to200", "greaterthan200"))
```

```{r}
icahalldatabackup1211 <- icahalldata
icahalldata <- icahalldatabackup1211
freqtocheck1211 <- freq(icahalldatabackup1211$idpastevisitdate)
freqtocheck1211assessment <- freq(icahalldatabackup1211$assessment_id)

```

**********************************************

Adding the 50th centile BMI for children and calculating their ideal BMI and ideal  body weight

**********************************************

To calculate ideal body weight, the paper 'Ideal Body Weight in Children' by Phillips references the 'BMI method' of taking the ideal BMI of a child of the age, and backcalculating their weight dependent on their height from this 50th centile value for their ideal bmi. 

The WHO normative data comes in spreadsheets in LMS format. This allows us to use the 'M', median, as the 50th centile

We need to load in this normative data - I've combined the WHO 0 to 5 and 5 to 19 in one spreadsheet for ease of loading and manipulation

```{r}
wholmsdata <- read.csv("./datatoload/WHOnormativelmsforr.csv")
```

now let's take out the ideal bmi

```{r}
idealbmiforage <- wholmsdata[,c("Years", "Mbfab", "Mbfag")]

names(idealbmiforage)[names(idealbmiforage)=="Years"] <- "idealageyears"
names(idealbmiforage)[names(idealbmiforage)=="Mbfab"] <- "idealbmimale"
names(idealbmiforage)[names(idealbmiforage)=="Mbfag"] <- "idealbmifemale"
```

We need to find the nearest neighbour for each of the attributes

they use data.table here:
https://stackoverflow.com/questions/20133344/find-closest-value-in-a-vector-with-binary-search

to use this we need the columns in the different frames to be the same name, so duplicate the agetouse

NOTE - this code only works with a frame that has a value in every one of the columns you are using
```{r}
library(data.table)
icahalldata$idealageyears <- icahalldata$agetouse
icahalldatawithage <- icahalldata[!is.na(icahalldata$agetouse),]
icahalldatawithage <-  icahalldatawithage[!is.na(icahalldatawithage$agetouse), ]
```


```{r}
icahalldatawithagemale <- icahalldatawithage %>% filter(Sex.at.birth...Birth=="Male")
idealbmimale <- idealbmiforage[, c("idealbmimale", "idealageyears")]
idealbmimale <- as.data.table(idealbmimale)
setkey(idealbmimale, "idealageyears")
```

I need my assessment_id and Decimal.Age to be in a separate frame as I've been getting the error Error in `[.data.table`(idealbmimale, icahalldatawithagemale, roll = "nearest", : Internal error: CsubsetVector is internal-use-only but has received negatives, zeros or out-of-range

I never debugged that error, so instead roll nearest on just the values I care about, and then join them into the frame

```{r}
icahmaleassessmentandage <- icahalldatawithagemale[,c("assessment_id", "Decimal.Age")]
```

now I should be able to roll the nearest idealbmimale

the two nrow's here should read the same digits:
```{r}
icahmaleassessmentandagewithidealbmi <- 
  idealbmimale[icahmaleassessmentandage, roll="nearest" , on=c("idealageyears"="Decimal.Age")]
print("nrow")
nrow(icahmaleassessmentandage)
#here I rearrange this frame to put the assessment_id on the left out of paranoia
icahmaleassessmentidealbmitojoin <- icahmaleassessmentandagewithidealbmi[,c("assessment_id", "idealbmimale")]
print("nrow")
nrow(icahmaleassessmentidealbmitojoin)
```

they don't read the same so we need to slice_max for the ties, and select the higher bmi (arbitrary, ties occur on such few occasions this decision doesn't matter)

```{r}
icahmaleassessmentidealbmitojoin   <- icahmaleassessmentidealbmitojoin %>% group_by(assessment_id) %>% slice_max(idealbmimale, n=1, with_ties=F)
print("nrow")
nrow(icahmaleassessmentidealbmitojoin)
```
we see the nrow then comes back down to the same as we started with.

now I can join that in to the rest of the data
```{r}
icahalldatawithagemalewithidealbmi <- left_join(icahalldatawithagemale, icahmaleassessmentidealbmitojoin, by="assessment_id")
```


I used to change the Decimal Age here, which doesn't make sense, so I've stopped doing it

now create a general idealbmi column that we can later add the female to
```{r}
icahalldatawithagemalewithidealbmi$idealbmi <- icahalldatawithagemalewithidealbmi$idealbmimale
```

```{r}
icahalldatabackup1358 <- icahalldata
```
 
 
 do the same for female 

```{r}
icahalldatawithagefemale <- icahalldatawithage %>% filter(Sex.at.birth...Birth=="Female")
idealbmifemale <- idealbmiforage[, c("idealbmifemale", "idealageyears")]
idealbmifemale <- as.data.table(idealbmifemale)
setkey(idealbmifemale, "idealageyears")
```

I need my assessment_id and Decimal.Age to be in a separate frame as I've been getting the error Error in `[.data.table`(idealbmifemale, icahalldatawithagefemale, roll = "nearest", : Internal error: CsubsetVector is internal-use-only but has received negatives, zeros or out-of-range

I never debugged that error, so instead roll nearest on just the values I care about, and then join them into the frame

```{r}
icahfemaleassessmentandage <- icahalldatawithagefemale[,c("assessment_id", "Decimal.Age")]
```

now I should be able to roll the nearest idealbmifemale

the two nrow's here should read the same digits:
```{r}
icahfemaleassessmentandagewithidealbmi <- 
  idealbmifemale[icahfemaleassessmentandage, roll="nearest" , on=c("idealageyears"="Decimal.Age")]
print("nrow")
nrow(icahfemaleassessmentandage)
#here I rearrange this frame to put the assessment_id on the left out of paranoia
icahfemaleassessmentidealbmitojoin <- icahfemaleassessmentandagewithidealbmi[,c("assessment_id", "idealbmifemale")]
print("nrow")
nrow(icahfemaleassessmentidealbmitojoin)
```

they don't read the same so we need to slice_max for the ties, and select the higher bmi (arbitrary, ties occur on such few occasions this decision doesn't matter)

```{r}
icahfemaleassessmentidealbmitojoin   <- icahfemaleassessmentidealbmitojoin %>% group_by(assessment_id) %>% slice_max(idealbmifemale, n=1, with_ties=F)
print("nrow")
nrow(icahfemaleassessmentidealbmitojoin)
```
we see the nrow then comes back down to the same as we started with.

now I can join that in to the rest of the data
```{r}
icahalldatawithagefemalewithidealbmi <- left_join(icahalldatawithagefemale, icahfemaleassessmentidealbmitojoin, by="assessment_id")
```


```{r}

icahalldatawithagefemalewithidealbmi$idealbmi <- icahalldatawithagefemalewithidealbmi$idealbmifemale

icahalldatabackup1376 <- icahalldata
freqtocheck1958<- freq(icahalldatabackup1376$idpastevisitdate)
freqtocheck1958assessment <- freq(icahalldatabackup1376$assessment_id)
```


```{r}
#icahalldata <- icahalldatabackup1160
#str(icahalldatawithagefemalewithidealbmi)
freqtocheck1289 <- freq(icahalldatawithagefemalewithidealbmi$assessment_id)
bothsexeswithageandidealbmi <- bind_rows(icahalldatawithagemalewithidealbmi, icahalldatawithagefemalewithidealbmi)

```
That frame misses out anyone without a registered sex or a registered decimal.age , so let's just take out the ideal bmi and join it in to the main frame

```{r}
idealbmitojoin <- bothsexeswithageandidealbmi[,c("assessment_id", "idealbmi")]
icahalldatawithidealbmi <- left_join(icahalldata, idealbmitojoin, by="assessment_id")
```



```{r}
icahalldatabackup1292 <- icahalldatawithidealbmi
icahalldata <- icahalldatawithidealbmi
freqtocheck1292 <- freq(icahalldatabackup1292$idpastevisitdate)
freqtocheck1292assessment <- freq(icahalldatabackup1292$assessment_id)
```


TO CHECK THIS CODE, I NEED TO PLOT patient age on the x axis against my ideal bmi value, then on the same axis plot the age against ideal bmi from the core who frame

```{r}
ggplot(data=icahalldata, aes(x=Decimal.Age, y=idealbmi, colour=Sex.at.birth...Birth))  + geom_point(aes(x=Decimal.Age, y=bmi, colour=Sex.at.birth...Birth)) + ylim(0,30) + geom_line(size=2, alpha=0.3)
```


Now to take this ideal bmi, and calculate the ideal body weight based on the patient's height
bmi = weight/heightsquared
ideal weight = bmi * height * height

```{r}
icahalldatabackup1297 <- icahalldata
freqtocheck1297 <- freq(icahalldatabackup1297$idpastevisitdate)
freqtocheck1297assessment <- freq(icahalldatabackup1297$assessment_id)
nrow(icahalldatabackup1297)
```



```{r}
icahalldata$idealbodyweight <- icahalldata$idealbmi * icahalldata$Height..cm....CAH.Longitudinal.Data / 100 * icahalldata$Height..cm....CAH.Longitudinal.Data / 100
```

which allows us now to calculate the ideal body surface area
and also to calculate the lean body surface area using LBM =  IBW + 0.29(TBW-IBW)

```{r}
icahalldata$idealbsa <- sqrt(icahalldata$Height..cm....CAH.Longitudinal.Data * icahalldata$idealbodyweight /3600)

icahalldata$leanbodymass <- icahalldata$idealbodyweight + 
  0.29 * (icahalldata$Weight..kg....CAH.Longitudinal.Data - icahalldata$idealbodyweight)
icahalldata$leanbsa <- sqrt(icahalldata$Height..cm....CAH.Longitudinal.Data * icahalldata$leanbodymass /3600)

icahalldata$hydrocortisoneperidealbsa <- 
  icahalldata$hydrocortisoneequivalent / icahalldata$idealbsa
icahalldata$hydrocortisoneperleanbsa <- 
  icahalldata$hydrocortisoneequivalent / icahalldata$leanbsa
icahalldata$hydrocortisoneperkg <- 
  icahalldata$hydrocortisoneequivalent / icahalldata$Weight..kg....CAH.Longitudinal.Data
icahalldata$hydrocortisoneperidealkg <- 
  icahalldata$hydrocortisoneequivalent / icahalldata$idealbodyweight

icahalldata$hydrocortisoneperidealbsaextrapolated <- 
  icahalldata$hydrocortisoneequivalentextrapolated / icahalldata$idealbsa
icahalldata$hydrocortisoneperleanbsaextrapolated <- 
  icahalldata$hydrocortisoneequivalentextrapolated / icahalldata$leanbsa
icahalldata$hydrocortisoneperkgextrapolated <- 
  icahalldata$hydrocortisoneequivalentextrapolated / icahalldata$Weight..kg....CAH.Longitudinal.Data
icahalldata$hydrocortisoneperidealkgextrapolated <- 
  icahalldata$hydrocortisoneequivalentextrapolated / icahalldata$idealbodyweight

```

Now we can calculate dose per idealbsa

```{r}
icahalldata$previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa <- 
  icahalldata$previoushydrocortisoneequivalentextrapolated / icahalldata$idealbsa
```




*****************************************

Creating change of medication statistics

*******************************************

Investigating prednisolone ratio change

we already have the lag columns created above 



NEED CODE THAT ACCOUNTS FOR A VISIT THAT DOESNT HAVE MEDICATION INFO! Could separate out the visits with medication info first - therefore pull out just those with medication, work on that, then join it back in later

```{r}
icahalldatawithmedication <- icahalldata[!is.na(icahalldata$medicine), ]
```

First of all we need to say whether it is first visit - top of the spreadsheet will be NA, other columns will be zero.

Note to stop it deleting cells when you have na, you need the !is.na clauses

note we already have a lagmedicine column above
```{r}
icahalldatawithmedication$lagid <- lag(icahalldatawithmedication$Register.ID...Record)

icahalldatawithmedication$sameidcode <- 
  ifelse(icahalldatawithmedication$Register.ID...Record == icahalldatawithmedication$lagid , 1, 0)
icahalldatawithmedication$samemedicinecode <- 
  ifelse(icahalldatawithmedication$medicine == icahalldatawithmedication$lagmedicine , 1, 0)

icahalldatawithmedication$medicinechange <- 
  ifelse(icahalldatawithmedication$sameidcode == 0 , "firstvisitwithmeds", NA)

icahalldatawithmedication$medicinechange <- 
  ifelse(is.na(icahalldatawithmedication$sameidcode), "firstvisitwithmeds", icahalldatawithmedication$medicinechange)

icahalldatawithmedication$medicinechange <- ifelse(is.na(icahalldatawithmedication$medicinechange),
                                                   paste0(icahalldatawithmedication$lagmedicine, "to", icahalldatawithmedication$medicine), icahalldatawithmedication$medicinechange)
```

then a lead medicinechange column is useful to the know the dose BEFORE a medication change

```{r}
icahalldatawithmedication$leadmedicinechange <- lead(icahalldatawithmedication$medicinechange)
```

we already have the lag dose column from above

now we have a column called medicinechange that is what we need. Let's tie that back into our main frame, and we will have a value for medication change whenever we want it

```{r}
medicationchange <- 
  icahalldatawithmedication[,c("Register.ID...Record", "idpastevisitdate", "medicinechange", "leadmedicinechange")]

icahalldata <- left_join(icahalldata, medicationchange, by=c("Register.ID...Record", "idpastevisitdate"))
```

now I can filter out patients that moved from hydrocortisone to prednisolone etc

```{r}
icahhydrocortisonetoprednisolone <- icahalldata %>% filter(medicinechange=="hydrocortisonetoprednisolone")
icahhydrocortisonetoprednisone   <- icahalldata %>% filter(medicinechange=="hydrocortisonetoprednisone")
icahprednisolonetohydrocortisone <- icahalldata %>% filter(medicinechange=="prednisolonetohydrocortisone")
icahprednisolonetoprednisone     <- icahalldata %>% filter(medicinechange=="prednisolonetoprednisone")
icahprednisonetohydrocortisone   <- icahalldata %>% filter(medicinechange=="prednisonetohydrocortisone")
icahprednisonetoprednisolone     <- icahalldata %>% filter(medicinechange=="prednisonetoprednisolone")

visitswithmedicationchange <- rbind (icahhydrocortisonetoprednisolone, icahhydrocortisonetoprednisone, icahprednisolonetohydrocortisone,
                                     icahprednisolonetoprednisone, icahprednisonetohydrocortisone, icahprednisonetoprednisolone)
patientsthathaveamedicationchange <- visitswithmedicationchange$Register.ID...Record
```

pull out the patients that ever have a medication change. 

```{r}
alldataofthosewithmedicationchange <-  subset(icahalldata, Register.ID...Record %in% patientsthathaveamedicationchange)
alldataofthosewithoutmedicationchange <- 
  icahalldata[ ! icahalldata$Register.ID...Record %in% patientsthathaveamedicationchange, ]
```

```{r}
icahalldatabackup1439 <- icahalldata
freqtocheck1439 <- freq(icahalldatabackup1439$idpastevisitdate)
freqtocheck1439assessment <- freq(icahalldatabackup1439$assessment_id)

```

**************

arranging puberty stages and tanner stages

*****************

we can combine genital and pubic hair numbers of male and female if we want to plot or analyse by pubic hair stage. This is important to be able to assign normative data

```{r}
icahalldata$genitalstagemalenumber <- as.numeric(icahalldata$Genital.stage...Puberty.Male) 
icahalldata$genitalstagefeemalenumber <- as.numeric(icahalldata$Pubic.hair.stage...Puberty.Female) 
icahalldata$genitalstagebothsexesnumber <- 
  ifelse(is.na(icahalldata$genitalstagemalenumber), icahalldata$genitalstagefeemalenumber, icahalldata$genitalstagemalenumber) 


icahalldata$malepubichairnumber <- as.numeric(icahalldata$Pubic.hair.stage...Puberty.Male)
icahalldata$femalepubichairnumber <- as.numeric(icahalldata$Pubic.hair.stage...Puberty.Female)

icahalldata$pubichairnumber <- 
  ifelse(!is.na(icahalldata$malepubichairnumber), icahalldata$malepubichairnumber, NA)
icahalldata$pubichairnumber <- 
  ifelse(!is.na(icahalldata$femalepubichairnumber), icahalldata$femalepubichairnumber, icahalldata$pubichairnumber)

icallalldatapubic1 <- icahalldata %>% filter (pubichairnumber==1)
icallalldatapubic2 <- icahalldata %>% filter (pubichairnumber==2)
icallalldatapubic3 <- icahalldata %>% filter (pubichairnumber==3)
icallalldatapubic4 <- icahalldata %>% filter (pubichairnumber==4)
icallalldatapubic5 <- icahalldata %>% filter (pubichairnumber==5)

```

**********************************************************************************************

Androstenedione and testosterone normative data and ranges

**********************************************************************************************

let's sort out the Androstenedione normal ranges. Now we have pubertal stages that is useful for joining appropriate data

Upload some normative data of adrostenedione and testosterone as these are age and gender specific.

Androstenedione and testosterone are available for ages from Kushnir 2010

Hormones by genital stage are available from Soeberg 2014

```{r}
kushnirfemalenormativetestosterone   <- read.csv("./normativehormones/2020-10-28 female normative testosterone.csv")
kushnirfemalenormativeandrostenedione <- read.csv("./normativehormones/2021-04-08 female normative androstenedione.csv")

kushnirmalenormativetestosterone   <- read.csv("./normativehormones/2020-10-28 male normative testosterone.csv")
kushnirmalenormativeandrostenedione <- read.csv("./normativehormones/2021-04-08 male normative androstenedione.csv")

soeborgfemalenormativehormones <- read.csv("./normativehormones/soeborgfemalenormativehormones.csv")
soeborgmalenormativehormones <- read.csv("./normativehormones/soeborgmalenormativehormones.csv")
soeborgbothsexesnormativehormones <- read.csv("./normativehormones/soeborgbothsexesnormativehormones.csv")
```
we need to note here that the kushnir paper doesn't report ranges for those under 6 months old, but we are just using the lowest age range available for those under 6 months old

join appropriate normative data, as long as the floorage=Age..years. AND the sex=ï..sexcode
```{r}
icahalldata <- left_join(icahalldata,kushnirfemalenormativetestosterone, 
                         by=c("flooragetouse"="Age..years.", "sex"="ï..sexcode"))
icahalldata <- left_join(icahalldata,kushnirfemalenormativeandrostenedione, 
                         by=c("flooragetouse"="Age..years.", "sex"="ï..sexcode"))
icahalldata <- left_join(icahalldata,kushnirmalenormativetestosterone, 
                         by=c("flooragetouse"="Age..years.", "sex"="ï..sexcode"))
icahalldata <- left_join(icahalldata,kushnirmalenormativeandrostenedione, 
                         by=c("flooragetouse"="Age..years.", "sex"="ï..sexcode"))
```



join appropriate normative data from soeborg as per genital stage. Strictly, the soeborg data is based on children over age 4, and exhibits some high values for the neonatal data they have. However, I'm joining and providing reference data for anyone past 6 months of age as per Kusnir, by genital stage, which I think is justifiable.

First we need to abstract the numbers from the character column of genital stages and combine the male genital stage with the female pubic hair stage
```{r}

icahalldata <- left_join(icahalldata,soeborgbothsexesnormativehormones, 
                         by=c("genitalstagebothsexesnumber"="genitalstage", "Sex.at.birth...Birth"="ï..sex"))


```


For soeborg data Having joined that to all people with a gential stage of 1, we have to correct for not being able to trust those limits before 6 months of age, by removing each of the columns if the patient visit is below that age:

```{r}
icahalldata[which(icahalldata$agetouse <0.5), c("dheasoeborgnormativemean"  ,            "dheasoeborglowerlimit2sd"     ,         "dheasoeborgupperlimit2sd"  ,           
 "dheassoeborgnormativemean"            , "dheassoeborglowerlimit2sd"            , "dheassoeborgupperlimit2sd"            ,
 "androstenedionesoeborgnormativemean"  , "androstenedionesoeborglowerlimit2sd"  , "androstenedionesoeborgupperlimit2sd"  ,
 "ohp17soeborgnormativemean"            , "ohp17soeborglowerlimit2sd"            , "ohp17soeborgupperlimit2sd"            ,
 "testosteronesoeborgnormativemean"     , "testosteronesoeborglowerlimit2sd"     , "testosteronesoeborgupperlimit2sd"     ,
 "freetestosteronesoeborgnormativemean" , "freetestosteronesoeborglowerlimit2sd" , "freetestosteronesoeborgupperlimit2sd" ,
 "freeandrogenindexsoeborgnormativemean", "freeandrogenindexsoeborglowerlimit2sd", "freeandrogenindexsoeborgupperlimit2sd")] <- NA
```



now we can easily create soeborg interpretation columns, and also soeberg standardised columns

As we only have upper and lower limits, and not the full L M S criteria from the soeberg paper, we can use the formula from Statistica Applicata, Vol. 2, n.4. 1990 - analysing data as safety data in clinical trials

standardised value = ( original value - lower limit of normal ) / (upper limit of normal - lower limit of normal)

note with dheas, the soeberg normative value is in nmol/L

judging by the gloucestershire hospitals normative ranges https://www.gloshospitals.nhs.uk/our-services/services-we-offer/pathology/tests-and-investigations/dheas-dehydroepiandrosterone-sulphate/
the numbers in the registry are more in keeping with micromol/L - i.e. 1000 x more than the soeberg units

I've standardised the testosterone as though the registry is all nmol/L, but by the looks of it, people have testosterone in the hundreds or thousands, so people are clearly using different units? THis is the same with 17ohp and androstenedione to be fair, they just need to be cleaned by unit or country to diagnose which ones can't be trusted. 

I've standardised here the 17ohp both to soeburg, and to the 12-36 target for which we have another reference

```{r}
icahalldata$dheasstandardisedsoeberg <- ( icahalldata$dheas.value * 1000 - icahalldata$dheassoeborglowerlimit2sd ) /
                                       ( icahalldata$dheassoeborgupperlimit2sd - icahalldata$dheassoeborglowerlimit2sd )

icahalldata$androstenedionestandardisedsoeberg <- ( icahalldata$andostenedione.value - icahalldata$androstenedionesoeborglowerlimit2sd ) /
                                       ( icahalldata$androstenedionesoeborgupperlimit2sd - icahalldata$androstenedionesoeborglowerlimit2sd )

icahalldata$testosteronestandardisedsoeberg <- ( icahalldata$total_testosterone.value - icahalldata$testosteronesoeborglowerlimit2sd ) /
                                       ( icahalldata$testosteronesoeborgupperlimit2sd - icahalldata$testosteronesoeborglowerlimit2sd )

icahalldata$ohp17standardisedsoeberg <- ( icahalldata$ohp17.value - icahalldata$ohp17soeborglowerlimit2sd ) /
                                       ( icahalldata$ohp17soeborgupperlimit2sd - icahalldata$ohp17soeborglowerlimit2sd )

icahalldata$ohp17standardised1236 <- ( icahalldata$ohp17.value - 12 ) /
                                       ( 36 - 12 )
```


**************

arranging puberty stages and tanner stages and imputing stages - this was taken out due to streamlining requirements and can be found in code before 2021-03-21

*****************

**********************************

calculating a time adjusted weighted mean for absolute 17ohp - this was taken out due to stremlining requirement sna dcan be froun din code before 2021-03-21

************************************


***************************

basic plots of standardised serum steroid values - again remvoed and found as above

******************************


************************

interpreting serum steroids into low inrnage high

*****************************


now that we have normative data in, and serum steroid measurements, I can create a code column that has low/inrange/high for each of the steroids

Now calculate whether the patient has a value for each hormone as low, inrange or high. First we attribute the appropriate low and high range for our hormones according to sex and age from the kushnir data set

```{r}

icahalldata$androstenedionelowthreshold <- 
  ifelse(icahalldata$sex==1, icahalldata$Kushnir.Male.Androstenedione.low..nmol.L., NA)
icahalldata$androstenedionelowthreshold <- 
  ifelse(icahalldata$sex==2, icahalldata$Kushnir.Female.Androstenedione.low..nmol.L., icahalldata$androstenedionelowthreshold)
icahalldata$androstenedionehighthreshold <- 
  ifelse(icahalldata$sex==1, icahalldata$Kushnir.Male.Androstenedione.high..nmol.L., NA)
icahalldata$androstenedionehighthreshold <- 
  ifelse(icahalldata$sex==2, icahalldata$Kushnir.Female.Androstenedione.high..nmol.L., icahalldata$androstenedionehighthreshold)

icahalldata$testosteronelowthreshold <- ifelse(icahalldata$sex==1, icahalldata$Male.Testosterone.low..nmol.L., NA)
icahalldata$testosteronelowthreshold <- ifelse(icahalldata$sex==2, icahalldata$Female.Testosterone.low..nmol.L., icahalldata$testosteronelowthreshold)
icahalldata$testosteronehighthreshold <- ifelse(icahalldata$sex==1, icahalldata$Male.Testosterone.high..nmol.L., NA)
icahalldata$testosteronehighthreshold <- ifelse(icahalldata$sex==2, icahalldata$Female.Testosterone.high..nmol.L., icahalldata$testosteronehighthreshold)                                     
icahalldata$progesterone17ohlowthreshold <- 12
icahalldata$progesterone17ohhighthreshold <- 36
```

Now we can interpret our serum blood values in the context of the thresholds we have
```{r}
icahalldata$androstenedionelevel <- 
  ifelse(icahalldata$andostenedione.value < icahalldata$androstenedionelowthreshold, "low", NA)
icahalldata$androstenedionelevel <- 
  ifelse(icahalldata$andostenedione.value > icahalldata$androstenedionehighthreshold, "high", icahalldata$androstenedionelevel)
icahalldata$androstenedionelevel <- 
  ifelse(icahalldata$andostenedione.value >= icahalldata$androstenedionelowthreshold & 
                                     icahalldata$andostenedione.value <= icahalldata$androstenedionehighthreshold,
         "inrange", icahalldata$androstenedionelevel)

icahalldata$testosteronelevel <- 
  ifelse(icahalldata$total_testosterone.value < icahalldata$testosteronelowthreshold, "low", NA)
icahalldata$testosteronelevel <- 
  ifelse(icahalldata$total_testosterone.value > icahalldata$testosteronehighthreshold, "high", icahalldata$testosteronelevel)
icahalldata$testosteronelevel <- 
  ifelse(icahalldata$total_testosterone.value >= icahalldata$testosteronelowthreshold & 
                                     icahalldata$total_testosterone.value <= icahalldata$testosteronehighthreshold, "inrange", icahalldata$testosteronelevel)



icahalldata$progesterone17ohlevel <- 
  ifelse(icahalldata$ohp17.value < icahalldata$progesterone17ohlowthreshold, "low", NA)
icahalldata$progesterone17ohlevel <- 
  ifelse(icahalldata$ohp17.value > icahalldata$progesterone17ohhighthreshold, "high",
                                    icahalldata$progesterone17ohlevel)
icahalldata$progesterone17ohlevel <- 
  ifelse(icahalldata$ohp17.value >= icahalldata$progesterone17ohlowthreshold & 
                                     icahalldata$ohp17.value <= icahalldata$progesterone17ohhighthreshold, "inrange",
                                    icahalldata$progesterone17ohlevel)

```

Can also compare our interpretations to local interpretations

```{r}
androstenedionelocalinterpretation <- as.data.frame(freq(icahalldata$andostenedione.interp))
androstenedionecentralinterpretation <- as.data.frame(freq(icahalldata$androstenedionelevel))
```

```{r}
icahalldata$interpretationcomparison <- 
  ifelse(icahalldata$andostenedione.interp == icahalldata$androstenedionelevel, "same", NA)
icahalldata$interpretationcomparison <- 
  ifelse(icahalldata$andostenedione.interp != icahalldata$androstenedionelevel, "different",
         icahalldata$interpretationcomparison)
```

```{r}
freqinterpretation <- as.data.frame(freq(icahalldata$interpretationcomparison))

freqinterpretation <- rownames_to_column(freqinterpretation, var = "interpretationcomparison")

freqinterpretationplot <- freqinterpretation %>% filter (interpretationcomparison=="different" | interpretationcomparison=="same" )
interpretationplot <- ggplot(data=freqinterpretationplot, aes(x=interpretationcomparison, y=Freq)) +
  geom_bar(stat="identity", position = position_dodge()) +
    geom_text(aes(label=Freq), vjust=-1) + 
  ylim(0,1000)+
  labs(title="Comparison of our interpretation of Androstenedione to that of the centre",
       x = "Local versus Kushnir comparison", y="Number of Visits")+
  scale_fill_brewer(palette="Dark2") +
    theme
interpretationplot
```

To assess concordance between markers, we can combine our columns

let's do concordance between androstenedione and 17OHP

```{r}
icahalldata$andro17ohplevel <- paste0(icahalldata$androstenedionelevel, "with", icahalldata$progesterone17ohlevel)
alldataandro17ohpconcordance <- as.data.frame(freq(icahalldata$andro17ohplevel))
write.csv(alldataandro17ohpconcordance, "alldataandro17ohpconcordance.csv")
```



*********************************************

Establishing separate patient data

*********************************************

As we have a frame with all of the visits on a separate row, that will be invaluable and we will need to calculate everything in that frame to maintain the richness of the data. Once all calculations are done, we can then create a 'summary' data frame where we group by all the patients and provide summary data for the patients 

The first question we want is to describe hydrocortisone and fludrocortisone in relation to plasma 17OHP

To do this, we don't necessarily want to create averages, as the average of a patients doses over time and an average of their markers would not necessarily be representative. i would say that the most recent patient visit is going to be one of the most useful

so for this we need to use some variation of top_row

we want to order the frame in order of the patient number, then in order of the patient visit

Register.ID...Record

assessment_id - HOWEVER, our assessment_id contains some character dates, so this probably isn't wise. We instead want to order by the POSIXct column of the visit date which ive created as "visitdate". Most recent should be at the top, so we need a negative sign. HOWEVER, the negative sign doesnt work with POSIXct, so instead we need to add rev()

```{r}
orderedicahalldata <- icahalldata[rev(order(icahalldata$Register.ID...Record, icahalldata$visitdate)),] 
```

now they are ordered I can use top_n to just keep the most recent visit for each separate patient

If someone doesn't have a visit date their data is getting removed. To stop this, we need to assign a visit date that we know to be incorrect, then we can remove those dates after we have filtered. Note you have to then posixct it again because when used in an ifelse statement r frustratingly returns it in UNIX epoch format

I've converted things a lot here but I'm still getting the time zone. I think I need to turn it into a different format from POSIXct before using in ggplot
```{r}
orderedicahalldata$visitdate <- 
  ifelse(is.na(orderedicahalldata$visitdate), as.POSIXct("01/01/1900" , format="%d/%m/%Y"), orderedicahalldata$visitdate)
mostrecenticahalldata <- orderedicahalldata %>% group_by(Register.ID...Record) %>% top_n(1, visitdate)
mostrecenticahalldata <- ungroup(mostrecenticahalldata)

mostrecenticahalldata$visitdate <- 
  ifelse((mostrecenticahalldata$visitdate=="01/01/1900"), NA, mostrecenticahalldata$visitdate)
mostrecenticahalldata$visitdate <- 
  as.POSIXct(mostrecenticahalldata$visitdate, origin="1970-01-01")
mostrecenticahalldata$visitdatenotz <- 
  as_date(mostrecenticahalldata$visitdate)

mostrecenticahalldata$visitdatenotz <- 
  ifelse((mostrecenticahalldata$visitdatenotz=="01/01/1900"), NA, mostrecenticahalldata$visitdate)
mostrecenticahalldata$visitdatenotz <- 
  as.POSIXct(mostrecenticahalldata$visitdatenotz, origin="1970-01-01")
mostrecenticahalldata$visitdatenotz <- 
  as.POSIXct(mostrecenticahalldata$visitdatenotz, format="%d-%m-%Y")

```

Note that that code will give multiple rows if their are ties, but we have already removed duplicate visits from that frame. 
Note that this will give you their most recent clinic visit - you might not want to restrict yourself to this, because they might not have had the variable of interest measured at that most recent visit, but they might have had it measured at the visit before.

We can now have some summary statistics for each participants most recent visit

```{r} 
recentmedicationtosummarise <- 
  mostrecenticahalldata %>% dplyr::select(Register.ID...Record, Country...Centre, agetouse, hydrocortisoneequivalent, hydrocortisoneperbsa,acth.value
:total_testosterone.value)
```

we can create a data frame of results like this quite easily with the ready made function descr() because there is only one visit for each patient in this frame

```{r}
descrrecentmedicationtosummarise <- as.data.frame(descr(recentmedicationtosummarise))
write.csv(descrrecentmedicationtosummarise, "mostrecentvisitsdescribed.csv")
```

we can also filter out any patients as per the request from Nils:

A list has been requested of all patients and their centre that were receiving a dose of 12mg/m2 or more at latest visit

```{r}
patientsgreaterorequaltodose12allcolumns <- mostrecenticahalldata %>% filter(hydrocortisoneperbsalessthan12==0)
patientsgreaterorequaltodose12 <- 
  patientsgreaterorequaltodose12allcolumns[,c("Register.ID...Record", "Centre.Name...Centre", "Country...Centre", "hydrocortisoneperbsa", "medicine", "visitdate")]
write.csv(patientsgreaterorequaltodose12, "patientsgreaterorequaltodose12.csv", row.names = F )
```

Later on we will do the same on patients in just the last 5 years

****************************

create smaller data frames that are easier to look at and sense check

*******************

```{r}
mostrecenticahalldatatocheck <- mostrecenticahalldata %>% dplyr::select(Register.ID...Record, visitdate, dob, agetouse)
icahalldatatocheck <- icahalldata %>% dplyr::select(Register.ID...Record, visitdate, dob, agetouse, ï..Date.of.birth...Birth)
participantstocheck <- participants %>% dplyr::select(Register.ID...Record,  ï..Date.of.birth...Birth)

```


**************************

height velocity calculations cocl

**************************

to get height velocity, we want the gain in height over the period of a year in cm. But similar to breast, we want the half way point in time
```{r}
icahalldatawithheight <- icahalldata[!is.na(icahalldata$Height..cm....CAH.Longitudinal.Data), ]
icahalldatawithheight <- icahalldatawithheight[order(icahalldatawithheight$Register.ID...Record,icahalldatawithheight$agetouse),]
```

First of all we need to say whether it is first visit - top of the spreadsheet will be NA, other columns will be zero.

Note to stop it deleting cells when you have na, you need the !is.na clauses

```{r}
icahalldatawithheight$lagid <- lag(icahalldatawithheight$Register.ID...Record)
icahalldatawithheight$lagheight <- lag(icahalldatawithheight$Height..cm....CAH.Longitudinal.Data)
icahalldatawithheight$lagagetouse <- lag(icahalldatawithheight$agetouse)

icahalldatawithheight$sameidcode <- 
  ifelse(icahalldatawithheight$Register.ID...Record == icahalldatawithheight$lagid , 1, 0)

icahalldatawithheight$heightchange <- 
  ifelse(icahalldatawithheight$sameidcode == 0 , "firstvisitwithheight", NA)

icahalldatawithheight$heightchange <- 
  ifelse(is.na(icahalldatawithheight$sameidcode), "firstvisitwithheight", icahalldatawithheight$heightchange)

icahalldatawithheight$heightchange <- ifelse(is.na(icahalldatawithheight$heightchange), "heightchangecalculated", icahalldatawithheight$heightchange)

icahalldatawithheight$heightincrease <- icahalldatawithheight$Height..cm....CAH.Longitudinal.Data - icahalldatawithheight$lagheight

str(icahalldatawithheight$heightincrease)

icahalldatawithheight$heightincrease <- ifelse(icahalldatawithheight$heightchange=="firstvisitwithheight", NA, as.numeric(icahalldatawithheight$heightincrease) )

icahalldatawithheight$periodofheightincrease <- icahalldatawithheight$agetouse - icahalldatawithheight$lagagetouse

icahalldatawithheight$ageofheightvelocity <- (icahalldatawithheight$agetouse - icahalldatawithheight$lagagetouse) / 2 + icahalldatawithheight$lagagetouse

icahalldatawithheight$heightvelocity <-   icahalldatawithheight$heightincrease / icahalldatawithheight$periodofheightincrease

```

```{r}
icahalldatawithheight <- icahalldatawithheight[rev(order(icahalldatawithheight$Register.ID...Record, icahalldatawithheight$heightvelocity)),] 
peakheightvelocity <- icahalldatawithheight %>% group_by(Register.ID...Record) %>% top_n(1, heightvelocity)

```

peakheighvelocity obviously gives us some answers that are neonatal, which isn't overly helpful. so I also want a peak heightvelocity after age 3.
I also just want the patients that have been in throughout puberty, so until after 10
I also just want patients that have been in throughout all of puberty, so from 5 and until 10

```{r}
icahalldatawithheightover3 <- icahalldatawithheight %>% filter(agetouse>3)
peakheightvelocityover3 <- icahalldatawithheightover3 %>% group_by(Register.ID...Record) %>% top_n(1, heightvelocity)
peakheightvelocityover3nowover10 <- peakheightvelocityover3 %>% filter(oldestageofpatient>10)
peakheightvelocityover3from5nowover10 <- peakheightvelocityover3 %>% filter(youngestageofpatient<5 & oldestageofpatient>10)

```

also getting a lot of early ages before puberty, so make over 5 also

```{r}
icahalldatawithheightover5 <- icahalldatawithheight %>% filter(agetouse>5)
peakheightvelocityover5 <- icahalldatawithheightover5 %>% group_by(Register.ID...Record) %>% top_n(1, heightvelocity)
peakheightvelocityover5nowover10 <- peakheightvelocityover5 %>% filter(oldestageofpatient>10)

```

**************************

calculating cumulative 17ohp

***************************

this is very similar to calculating the cumulative years in each tanner stage

we take out just the 17ohp, which has been done above. we will do exactly the same thing again just for the sake of creating code that will run alone

```{r}
options(scipen = 999)
icahalldatawithohp17 <- icahalldata[!is.na(icahalldata$ohp17.value), ]
memory.limit(9999999999)
icahalldatawithohp17 <- icahalldatawithohp17[order(icahalldatawithohp17$Register.ID...Record,icahalldatawithohp17$agetouse),]

icahalldatawithohp17$visitdate2 <- icahalldatawithohp17$visitdate

```


Instead, we want to spread the data. So each patient has one row

first take out the columns of interest from the frame

then give each patient a visit number with ohp17

then we have each value and the ages
You want to calculate your differential ages
then you can multiply the value by the differntial age, and you get numbers you can add up to give you cumulative ohp17


```{r}
icahalldatawithohp17tospread <- icahalldatawithohp17[,c("Register.ID...Record", "assessment_id", "agetouse", "ohp17.value")]

icahalldatawithohp17tospread$lagagetouse <- lag(icahalldatawithohp17tospread$agetouse)
icahalldatawithohp17tospread$yearswiththisreading <- icahalldatawithohp17tospread$agetouse - icahalldatawithohp17tospread$lagagetouse

icahalldatawithohp17tospread$lagRegister.ID...Record <- lag(icahalldatawithohp17tospread$Register.ID...Record)
icahalldatawithohp17tospread$yearswiththisreading <- ifelse(icahalldatawithohp17tospread$Register.ID...Record != icahalldatawithohp17tospread$lagRegister.ID...Record, icahalldatawithohp17tospread$agetouse, icahalldatawithohp17tospread$yearswiththisreading)
#then just correct for the top line
icahalldatawithohp17tospread$yearswiththisreading <- ifelse(is.na(icahalldatawithohp17tospread$lagRegister.ID...Record), icahalldatawithohp17tospread$agetouse, icahalldatawithohp17tospread$yearswiththisreading)

icahalldatawithohp17tospread$lagagetouse <- NULL
icahalldatawithohp17tospread$lagRegister.ID...Record <- NULL

icahalldatawithohp17tospread$ohp17visitnumber <- ave(icahalldatawithohp17tospread$ohp17.value, icahalldatawithohp17tospread$Register.ID...Record, FUN = seq_along)
```

now we can multiply the yearswiththisreading by the ohp.17value to get ohp17years in mmolyears/L

```{r}
icahalldatawithohp17tospread$ohp17years <- icahalldatawithohp17tospread$yearswiththisreading * icahalldatawithohp17tospread$ohp17.value
```

then we can have a cumulative column

```{r}
icahalldatawithohp17tospreadwithcumsum <- icahalldatawithohp17tospread %>% 
  group_by(Register.ID...Record) %>% mutate(cumsumohp17years = cumsum(ohp17years))
cumulativeohp17tojoin <- icahalldatawithohp17tospreadwithcumsum[,c("assessment_id", "cumsumohp17years")]
```


```{r}
cumulativeohp17tojoin <- unique(cumulativeohp17tojoin)
```

```{r}
icahalldatabackup1825 <- icahalldata
icahalldata <- icahalldatabackup1825
freqcumulativeohp171825 <- freq(icahalldatabackup1825$idpastevisitdate)
```


add our cumulative sum data to the main frame

again I have a problem of some different cumulativesumohp17 so take the maximum

```{r}
cumulativeohp17tojoin <- cumulativeohp17tojoin %>% group_by(assessment_id) %>% slice_max(cumsumohp17years, n=1, with_ties=F)
```

```{r}
icahalldatawithcumulativeohp17 <- left_join(icahalldata, cumulativeohp17tojoin, by="assessment_id")
cumulativeohp17tojoin <- NULL
icahalldata <- icahalldatawithcumulativeohp17
```

```{r}
icahalldatabackup2759 <- icahalldata
icahalldata <- icahalldatabackup2759
```

here we can once again consider extrapolation of data - we get left with gaps where we have a visit but no blood reading. Could assume the blood reading is half way between the previous readings. Ideally you'd want it in relation to no change in dose.

using that inside the model is working well

********************

we therefore want to extend this into the pubertal stages - this has been removed and can be forund in code before 2021-03-22

*******************


*****************************************

calculating the delta score transition age - this has been removed in favour of more sophisticated change point analysis

*****************************************


*********************************

Adjusted code to calculate cumulative 17ohp numbers for pre and post transition age -  we can do this to only the patients that have a transition age: icahonlydatawithtransitionage

********************************



```{r}
icahalldatabackup2790 <- icahalldata
icahalldata <- icahalldatabackup2790
```

**********************************************

Cleaning data - removing abnormal results by blunt force icahallclean cocl cocl

**********************************************

so lets create icahallclean, but first establish what to clean by
```{r}
lowzweightforage   <- -3
highzweightforage  <- +3
lowzheightforage   <- -3
highzheightforage  <- +3
lowzbmiforage      <- -3
highzbmiforage     <- +3
minimumageyears    <- 0
maximumageyears    <- 20

icahallclean <- icahalldata %>% filter(zweightforage  >= lowzweightforage &
                                         zweightforage <= highzweightforage &
                                         zheightforage >= lowzheightforage &
                                         zheightforage <= highzheightforage &
                                         zbmiforage    >= lowzbmiforage &
                                         zbmiforage    <= highzbmiforage &
                                          agetouse   >= minimumageyears &
                                          agetouse   <= maximumageyears
                                        )
colnamesicahallclean <- colnames(icahallclean)
write.csv(colnamesicahallclean, "colnamesicahallclean.csv")
```

To see what gets filtered out, it's then good to create some separate frames where we can inspect patients that were filtered for each reason

```{r}
differentages <- freq(icahalldata$agetouse)
differentmedicine <- freq(icahalldata$medicine)
differentdose <- freq(icahalldata$totaldose)

excludedduetozweightforage  <- icahalldata %>% filter(zweightforage < lowzweightforage | zweightforage > highzweightforage)
excludedduetozheightforage <- icahalldata %>% filter( zheightforage < lowzheightforage | zheightforage > highzheightforage   )
excludedfornoage <- icahalldata %>% filter(                              is.na(agetouse)             )
excludedfornomedicationtype <- icahalldata %>% filter(                     is.na(medicine)             )
excludedfornobmi <- icahalldata %>% filter(                               is.na(zbmiforage)                                       )
excludedfornodosing <- icahalldata %>% filter(                 is.na(hydrocortisoneperbsa)                               )
excludedduetozbmiforage <- icahalldata %>% filter(   zbmiforage < lowzbmiforage |               zbmiforage > highzbmiforage )
excludedduetoage <- icahalldata %>% filter(           agetouse < minimumageyears |agetouse > maximumageyears                    )
```

That therefore gives us some frames of data that have dodgy values we can look into if necessary. Height is coming out most frequently, so want to look into that first

For a write up, I want some information about icahallclean

```{r}
icahalldatacountries <- as.data.frame(freq(icahalldata$Country...Centre))
icahalldatacentres <- as.data.frame(freq(icahalldata$Centre.Name...Centre))
icahalldatapatients <- as.data.frame(freq(icahalldata$Register.ID...Record))
icahallcleancountries <- as.data.frame(freq(icahallclean$Country...Centre))
icahallcleancentres <- as.data.frame(freq(icahallclean$Centre.Name...Centre))
icahallcleanpatients <- as.data.frame(freq(icahallclean$Register.ID...Record))
```

```{r}
orderedicahallclean <- icahallclean[rev(order(icahallclean$Register.ID...Record, icahallclean$visitdate)),] 

mostrecenticahallclean <- orderedicahallclean %>% group_by(Register.ID...Record) %>% top_n(1, visitdate)
mostrecenticahallclean <- ungroup(mostrecenticahallclean)
```

```{r}

```





**************************************************************************************

```{r}
icahalldata <- icahalldata[order(icahalldata$Register.ID...Record,icahalldata$agetouse),]
colnamesicahalldata <- as.data.frame(colnames(icahalldata))
write.csv(icahalldata, "icahalldata.csv")
write.csv(colnamesicahalldata, "colnamesicahalldata.csv")
#colnames(icahalldata)

icahalldatabackup2875 <- icahalldata
icahalldata <- icahalldatabackup2875
```


*******************************

calculating time spent around change points - analysing data from a multiple change point model run on another machine

********************************

this code has been removedin favour of cubic models inside the multilevel modelling document. This was carried out before units were available. You can refer to file 2021-04-29icahanalysiswithfludrocortisone to find it, but you're better off looking at the latest file that cleans and filters the data more appropriately

**********************************************

Corrected Biomarker analysis : Assigning units from email information and previous extraction

***********************************************

I've updated this on 29/4/21 to reflect latest inputs from responses from centres, and also to remove the first visit from analysis to ensure we are not getting any biomarkers in for people that are on treatment.

The quickest way to adjust for removing the first visit is to do it at the beginning - remove all first visits from the data set, then all the rest of the frames will follow.

Go back to the code in 27/4/21 if you want to see the statistical significancies that were reported in the first draft of the abstract

ï..

Contents:

These are the variables we create and sections of work:

previousextractionwithunits : this is the frame that jillian sent me of a previous extraction
contactfromcentres : this is a csv version of the spreadsheet I have put together with email answers from centres
icahalldatawithallunits : this is the data with unit columns joined in
$unitsohptouse
$unitsandrostenedionetouse
those are the confirmed units of measurement, being NA if we don't know
correctednijmegentojoin is the corrected Nijmegen values
ohp17valuecorrected / androstenedionevaluecorrected is a global column that has corrected values inside it
correctedbologna is the spreadsheet loaded in with corrections from bologna. This deletes a couple of entries so bear in mind that bologna will have some 'unassigned' values, because they have been deleted by the centre
icahbiomarkerstouse : the main data frame with all corrections and units incorporated
aarhus sent through 3 corrections that are manually added to that sheet inside the code
convertedohpmmoll - these are the columns to use for our biomarkers which have confirmed units
convertedandrostenedionemmoll - these are the columns to use for our biomarkers which have confirmed units
icahalldatawithoutunitsorcorrectionsforohpbuthasvalue and icahalldatawithoutunitsorcorrectionsforandrostenedionebuthasvalue are the frames used to look at what data we are losing from a lack of response from the centres
lostohp and lostandrostenedione are summary frames of what we have lost from those centres
convertedohp17category is a column in the frame with the categories of ohp17
mostrecentmale / mostrecentfemale  is the most recent visits
mostrecentohp / mostrecentandrostenedione is the most recent visit for each patient with each biomarker present
mostrecenteitherbiomarker / mostrecenteitherbiomarkermale / mostrecenteitherbiomarkerfemale
mostrecentbothbiomerkers is a simple filter with just the most recent visit of patients that have both measured simultaneously
mostrecentohpmale and mostrecentohpfemale etc all self explanatory
centrebiomarkerfrequencies tell us how many patients have a recent value for each biomarker in each centre
mostrecentbiomarkersmale and mostrecentbiomarkersfemale are similar frames but constructed in a different way. These frames may have two rows for each patient, because the most recent androstenedione is only a different date
then we have some simple number variables that get produced:
numbermalepatientswithbiomarkers
proportionmale
numberfemalepatientswithbiomarkers
proportionfemale
totalpatientswithbiomarkers
then we have their ages in one row data frames:
agesoftotalcohort
agesofohpcohortmale
agesofohpcohortfemale
agesofandrostenedionecohortmale
agesofandrostenedionecohortfemale
to get the ohp category percentages we have some basic frames
ohprangecategoriesmale
ohprangecategoriesfemale
then we have the summary stats by year ages and years of visits:
malesummarystatsbyyearofvisit
femalesummarystatsbyyearofvisit
combinedsummarybyyearofvisitplotohp
combinedsummarybyyearofvisitplotandrostenedione
combinedsummarybyyearofvisitplotheightsds
malesummarystatsbypatientage
femalesummarystatsbypatientage
combinedsummarybypatientageplotohp
combinedsummarybypatientageplotandrostenedione
combinedsummarybypatientageplotheightsds
all those can be produced per centre by the function:
summarisebyageandcentrefunction
summarisebyyearandcentrefunction
then to create category statistics:
summarystatscategorytable
summarystatscategorytablebycentrefunction
summarystatscategoryyeartable

then we get to 
Assessing concordance between 17ohp readings and androstenedione cocl cocl
where I have plotted regression equations, multiple change point analysis and alike

then we get to 
Comparing centres cocl cocl 
Here there are boxplots with appropriate comparisons

then we get
Viewing the visits with units to inform contacting the centres cocl cocl 
where we have filtered some of the main frame with markers to send to units who ask for clarification about the questions asked






************************************************************************


Jillian has sent a previous extraction that has some units
We need to load this in and split the string to obtain the text that contains units from this file

```{r}
previousextractionwithunits <- read.csv("./datatoload/previousextractionwithunits.csv" )
#colnames(previousextractionwithunits)
```
rename the columns so we know which is 17ohp and which is androstenedione
note that a lot of entries in this spreadsheet are duplicated, so straight away we want to work with a unique version. 1181 entries goes straight down to 428. Rename the columns

```{r}
previousextractionwithunits <- unique(previousextractionwithunits)
names(previousextractionwithunits)[names(previousextractionwithunits)=="Result.Value"] <- "ohp17.valueoriginal"
names(previousextractionwithunits)[names(previousextractionwithunits)=="Result.Value.1"] <- "andostenedione.valueoriginal"
```


then we want to split the numbers from any less than or greater than symbol, and any text

so let's pull out the numbers for values

```{r}
previousextractionwithunits$ohp17.value <- gsub("[^[:digit:]]","",previousextractionwithunits$ohp17.valueoriginal)
previousextractionwithunits$ohp17.valueless <- gsub("[^<]","",previousextractionwithunits$ohp17.valueoriginal)
previousextractionwithunits$ohp17.valuemore <- gsub("[^>]","",previousextractionwithunits$ohp17.valueoriginal)
previousextractionwithunits$ohp17.valuesaliva <- gsub("[^saiva]","",previousextractionwithunits$ohp17.valueoriginal)
previousextractionwithunits$ohp17.valueunits <- gsub("[^ng/dmol]","",previousextractionwithunits$ohp17.valueoriginal)

```
from that units column we can remove specific string that comes from 'saliva morning' or l which comes from saliva morning which is nothing to do with units. Also put NA here in cells that are empty in that column.

```{r}

 previousextractionwithunits$ohp17.valueunits <- ifelse(previousextractionwithunits$ohp17.valueunits==  "lmonng", NA, previousextractionwithunits$ohp17.valueunits )
 previousextractionwithunits$ohp17.valueunits <- ifelse(previousextractionwithunits$ohp17.valueunits==  "l", NA, previousextractionwithunits$ohp17.valueunits)
 previousextractionwithunits$ohp17.valueunits <- ifelse(previousextractionwithunits$ohp17.valueunits==  "", NA, previousextractionwithunits$ohp17.valueunits)
 
```

Now do the same with androstenedione

```{r}
previousextractionwithunits$andostenedione.value<- gsub("[^[:digit:]]","",previousextractionwithunits$andostenedione.valueoriginal)
previousextractionwithunits$andostenedione.valuesaliva <- gsub("[^saiva]","",previousextractionwithunits$andostenedione.valueoriginal)
previousextractionwithunits$andostenedione.valueunits <- gsub("[^ng/dmol]","",previousextractionwithunits$andostenedione.valueoriginal)
```


```{r}
previousextractionwithunits$andostenedione.valueunits <- ifelse(previousextractionwithunits$andostenedione.valueunits==  "lmonng", NA, previousextractionwithunits$andostenedione.valueunits )
  previousextractionwithunits$andostenedione.valueunits <- ifelse(previousextractionwithunits$andostenedione.valueunits==  "monngl", NA, previousextractionwithunits$andostenedione.valueunits )
 previousextractionwithunits$andostenedione.valueunits <- ifelse(previousextractionwithunits$andostenedione.valueunits==  "l", NA, previousextractionwithunits$andostenedione.valueunits)
 previousextractionwithunits$andostenedione.valueunits <- ifelse(previousextractionwithunits$andostenedione.valueunits==  "nngl", NA, previousextractionwithunits$andostenedione.valueunits)
 previousextractionwithunits$andostenedione.valueunits <- ifelse(previousextractionwithunits$andostenedione.valueunits==  "", NA, previousextractionwithunits$andostenedione.valueunits)
```

so the morale of the story is that bologna have used both ng/ml and ng/dL in the past - need to know that all of our readings can be assigned to one of those

nijmegen have reported saliva measurements before, so they all need excluding

neither bologna or nijmegen have gone into the paper to send to jeremy

now I need to concentrate on which readings from bologna I can rescue, and just give him a list of the readings that I need to check - this should be short

turn the date into a proper date and create idpastevisitdate to join by later
```{r}
previousextractionwithunits$visitdate <- as.POSIXct(previousextractionwithunits$Date , format="%Y-%m-%d")
previousextractionwithunits$visitdatetopaste <- strptime(as.character(previousextractionwithunits$visitdate), "%Y-%m-%d")
previousextractionwithunits$visitdatetopaste <- format(previousextractionwithunits$visitdatetopaste, "%d/%m/%Y")
previousextractionwithunits$idpastevisitdate <- paste(previousextractionwithunits$ï..Register.ID, previousextractionwithunits$visitdatetopaste)
```

let's look at that frame by centre and also then take out the important columns to join

```{r}
previousextractionnijmegen <- previousextractionwithunits %>% filter(Centre=="Nijmegen")
previousextractionporto <- previousextractionwithunits %>% filter(Centre=="Porto Alegre")
previousextractionbologna <- previousextractionwithunits %>% filter(Centre=="Bologna")
previousextractionamsterdam <- previousextractionwithunits %>% filter(Centre=="Amsterdam")
previousextractionbuenos <- previousextractionwithunits %>% filter(Centre=="Buenos Aires")
previousextractionwinterthur <- previousextractionwithunits %>% filter(Centre=="Winterthur")
freq(previousextractionwithunits$Centre)
previousextractionwithunitstojoin <- previousextractionwithunits[,c("idpastevisitdate", "ohp17.valueunits", "andostenedione.valueunits", "ohp17.valuesaliva", "andostenedione.valuesaliva")]

previousextractionwithunitstojoin <- previousextractionwithunitstojoin %>% filter(!is.na(ohp17.valueunits) | !is.na(andostenedione.valueunits))

```
this shows bologna has a mix - we need to incorporate the ng/mL from Bologna, and those without units are clearly ng/dL, so Bologna can be used. This data will have to be joined in

we have 86 visits with units

```{r}
#cocl HERE IS WHERE WE ARE FILTERING OUT ANY OF THE FIRST VISITS TO ENSURE NO PRE DIAGNOSTiC MEASUREMENTS
```

We have a lot of patients removed if we simply use the blunt force tool of taking out all first visits. Instead, we can use the oldest possible age of diagnosis variable that we have created, and add 3 months to that to ensure that we are not analysing anyone who is not being treated

we now want to join those, then filter the joined frame to see how many of those visits we have in our total frame


```{r}
icahalldatabackup3083 <- icahalldata
icahalldata <- icahalldatabackup3083
nrow(icahalldata)
```

****************************

FILTERING THE DATA APPROPRIATELY FOR THE JOURNAL ARTICLE jocl

  NOTE HERE WE USE BRUTE FORCE TO REMOVE PATIENTS NEAR TO A POSSIBLE DIAGNOSIS DATE - IF YOU WANT TO USE THE ENTIRE DATASET AND JUST TAKE THE NIJMEGEN VALUES OUT THAT WE KNOW ARE PRE DIAGNOSIS, WE WOULD HAVE TO ALTER THIS FILTER HERE, BUT THE SAFEST THING TO DO AND MOST JUSTIFIABLE IS TO REMOVE THESE PREDIAGNOSTIC VALUES HERE
  
  HERE WE ALSO REMOVE PATIENTS THAT ARE 'NOT ASSIGNED' A SEX at birth - this was 4 people
  
  I have now changed on 2021-06-09 to filtering out anyone's visits who are AFTER a medication other than hydrocortisone. Because the entered medication is what they are taking going forward, then we need to keep in the first time they are registered as pred or dex, as the time up to that they were taking the medication before (i.e. hydrocortisone). We then need to run this and see how much it changes the numbers - I doubt much for summary stats, but it's important for modelling
  
  We must also remove anyone who, at their current visit, is listed as taking something other than hydrocortisone AND is listed as NOT having a change in medication. This may well be a mistake entry, and doesn't cover many entries, but we must assume at this point that they have had a visit in between visits that wasn't recorded in the registry, and in which their medication changed. Therefore the numbers at that visit reflect treatment on this changed medication
  
****************************

```{r}
icahalldatawithsex <- icahalldata %>% filter(Sex.at.birth...Birth=="Male" | Sex.at.birth...Birth=="Female" )
nrow(icahalldatawithsex)
#this tells us how many people are going to get filtered because of visitaftermedicationotherthanhydrocortisonestarted
freq(icahalldatawithsex$visitaftermedicationotherthanhydrocortisonestarted)

icahallhydrocortisonewithsex <- icahalldatawithsex %>% filter(visitaftermedicationotherthanhydrocortisonestarted==0)
nrow(icahallhydrocortisonewithsex)

icahvisitstoremove <- icahallhydrocortisonewithsex %>% 
  filter(
    medicine=="prednisone" & Has.treatment.changed.since.last.visit...Current.Medication =="No" |
      medicine=="prednisolone" & Has.treatment.changed.since.last.visit...Current.Medication =="No" |
      medicine=="dexamethasone" & Has.treatment.changed.since.last.visit...Current.Medication =="No" )



icahalldefinitelyhydrocortisonewithsex <- subset(icahallhydrocortisonewithsex, !(assessment_id %in% icahvisitstoremove$assessment_id))

icahalldatanoprediagnosis <- icahalldefinitelyhydrocortisonewithsex %>% filter(agetouse > (oldestpossibleageatdiagnosis + 0.25) | visitnumber > 1)

nrow(icahvisitstoremove)
icahvisitstoremove$assessment_id
nrow(icahalldatanoprediagnosis)
```


```{r}
assessmentsinuse <- icahalldatanoprediagnosis$assessment_id
icahalldatapossibleprediagnosis <- subset(icahalldata , !(assessment_id %in% assessmentsinuse))
frequencyoflosttoprediagnosisohp <- as.data.frame(freq(icahalldatapossibleprediagnosis$ohp17.value))
icahalldatapossibleprediagnosiswithohp <- icahalldatapossibleprediagnosis %>% filter(!is.na(ohp17.value))
centrefrequencyoflosttoprediagnosisohp <- freq(icahalldatapossibleprediagnosiswithohp$Centre.Name...Centre)
centrefrequencyoflosttoprediagnosisohp
```


frequencyoflosttoprediagnosisohp shows we have taken out 60 readings due to our filters, spread out between centres


```{r}
icahalldatawithpreviousunits <- left_join(icahalldatanoprediagnosis, previousextractionwithunitstojoin , by="idpastevisitdate")
#str(icahalldatawithpreviousunits)
icahalldatabackup3109 <- icahalldatawithpreviousunits
```


****************************

joining the contact from centres

***************************

I have a spreadsheet populated with all of the answers from the centres. This is excel to facilitate easy viewing. Ensure the most recent one is converted into a csv file and loaded here:


```{r}
contactfromcentres <- read.csv("./Responses of centres log for units/2021-05-07 Results of centre contacts.csv")
```

Note that in this frame we must also account for one value from Berlin being in nmol/L

```{r}

freq(contactfromcentres$Units.of.17OHP)
freq(contactfromcentres$Units.of.Androstenedione)

contactunits17ohptojoin <- contactfromcentres[,c("ï..Centre.Name", "Units.of.17OHP")]
contactunitsandrotojoin <- contactfromcentres[,c("ï..Centre.Name", "Units.of.Androstenedione")]

contactunits17ohptojoin <- contactunits17ohptojoin %>% filter(Units.of.17OHP=="ng/dl" | Units.of.17OHP=="ng/dL" | 
                                                                Units.of.17OHP== "ng/ml"| Units.of.17OHP== "ng/mL"|
                                                                Units.of.17OHP== "nmol/l"|Units.of.17OHP== "nmol/L")
contactunitsandrotojoin <- contactunitsandrotojoin %>% filter(Units.of.Androstenedione=="ng/dl" | 
                                                                Units.of.Androstenedione=="ng/dL" | 
                                                                Units.of.Androstenedione== "ng/ml"| 
                                                                Units.of.Androstenedione=="ng/mL" | 
                                                                Units.of.Androstenedione=="nmol/L" | 
                                                                Units.of.Androstenedione== "nmol/l"
                                                              )
```

now we have two sets of lists of units by centre that we can join to our main frame to get a centre unit




```{r}
icahalldatawith17ohpunits <- left_join(icahalldatawithpreviousunits , contactunits17ohptojoin , by=c("Centre.Name...Centre"="ï..Centre.Name"))
icahalldatawithallunits <- left_join(icahalldatawith17ohpunits , contactunitsandrotojoin , by=c("Centre.Name...Centre"="ï..Centre.Name"))
centrenames <- freq(icahalldatawithpreviousunits$Centre.Name...Centre)
centrenamesframe <- as.data.frame(rownames(centrenames))
write.csv(centrenamesframe, "originalcentrenames.csv", row.names = F)
```

then we can create a unittouse column, where the units from the previous extraction trump the centre unit

Units.of.17OHP and Units.of.Androstenedione are both the units from the contact of the centres
ohp17.valueunits and andostenedione.valueunits are the units from the previous extraction

then just standardise to a lower case L as currently there are some upper case 'L's' for units. Also correct for the typo of nd/dl to ng/dl that was in an isolated reading

```{r}
freq(icahalldatawith17ohpunits$Units.of.17OHP)
```


```{r}
icahalldatawithallunits$unitsohptouse <- 
  ifelse(is.na(icahalldatawithallunits$ohp17.valueunits), 
         icahalldatawithallunits$Units.of.17OHP , 
         icahalldatawithallunits$ohp17.valueunits)
icahalldatawithallunits$unitsandrostenedionetouse <- 
  ifelse(is.na(icahalldatawithallunits$andostenedione.valueunits), 
         icahalldatawithallunits$Units.of.Androstenedione , 
         icahalldatawithallunits$andostenedione.valueunits)

icahalldatawithallunits$unitsohptouse <- ifelse(icahalldatawithallunits$unitsohptouse=="ng/mL", "ng/ml", icahalldatawithallunits$unitsohptouse)
icahalldatawithallunits$unitsohptouse <- ifelse(icahalldatawithallunits$unitsohptouse=="ng/dL", "ng/dl", icahalldatawithallunits$unitsohptouse)
icahalldatawithallunits$unitsohptouse <- ifelse(icahalldatawithallunits$unitsohptouse=="nd/dl", "ng/dl", icahalldatawithallunits$unitsohptouse)
icahalldatawithallunits$unitsohptouse <- ifelse(icahalldatawithallunits$unitsohptouse=="nmol/L", "nmol/l", icahalldatawithallunits$unitsohptouse)
icahalldatawithallunits$unitsandrostenedionetouse <- ifelse(icahalldatawithallunits$unitsandrostenedionetouse=="ng/mL", "ng/ml", icahalldatawithallunits$unitsandrostenedionetouse)
icahalldatawithallunits$unitsandrostenedionetouse <- ifelse(icahalldatawithallunits$unitsandrostenedionetouse=="ng/dL", "ng/dl", icahalldatawithallunits$unitsandrostenedionetouse)
icahalldatawithallunits$unitsandrostenedionetouse <- ifelse(icahalldatawithallunits$unitsandrostenedionetouse=="nmol/L", "nmol/l", icahalldatawithallunits$unitsandrostenedionetouse)
freq(icahalldatawithallunits$unitsohptouse)
freq(icahalldatawithallunits$unitsandrostenedionetouse)

icahalldatabackup3558 <- icahalldatawithallunits

```



here we now just want to correct for the one reading that Berlin told us about that was in nmol/L for 17ohp

register:1842	23/09/2011	assessment: 510	17ohp: 171	nmol/l	androstenedione 2	ng/ml

```{r}
icahalldatawithallunits$unitsohptouse <- 
  ifelse(icahalldatawithallunits$Register.ID...Record=="1842" & icahalldatawithallunits$assessment_id=="510", 
         "nmol/l", 
         icahalldatawithallunits$unitsohptouse)

icahalldatawithallunitstester <- icahalldatawithallunits %>% filter(Register.ID...Record==1842)

icahalldatabackup3205 <- icahalldatawithallunits
icahalldata <- icahalldatawithallunits
nrow(icahalldata)
icahalldatawithallunits <- icahalldatabackup3205
```

that tester shows us the appropriate visit was changed. 

Now we need to incorporate the corrected figures from the spreadsheet from Nijmegen:

Nijmegen had some transposed values. Christina kindly went through it for me and corrected the values for a lot of the visits
```{r}
correctednijmegen <- read.csv("./Responses of centres log for units/Responses from centres/Nijmegen/icahnijmegencorrectedvaluestoload.csv")
correctednijmegentojoin <- correctednijmegen[,c("Register.ID...Record", "assessment_id", "correctednijmegenohp17nmoll", "correctednijmegenandrostenedionenmoll")]
correctednijmegentojoin$assessment_id <- as.character(correctednijmegentojoin$assessment_id)
correctednijmegentojoin$nijmegensentcorrection <- 1

icahbiomarkerstouse <- left_join(icahalldatawithallunits, correctednijmegentojoin, by=c("Register.ID...Record", "assessment_id"))
icahbiomarkerstouse$nijmegensentcorrection <- ifelse(is.na(icahbiomarkerstouse$nijmegensentcorrection), 
                                                                       0 , 
                                                                       icahbiomarkerstouse$nijmegensentcorrection)

```
let's duplicate the original value columns so that I have a reference later
```{r}
icahbiomarkerstouse$ohp17valuecorrected <- icahbiomarkerstouse$ohp17.value
icahbiomarkerstouse$androstenedionevaluecorrected <- icahbiomarkerstouse$andostenedione.value
```

now we can start populating the corrected columns with corrections from centres

```{r}
icahbiomarkerstouse$ohp17valuecorrected <- 
  ifelse(icahbiomarkerstouse$nijmegensentcorrection==1, 
         icahbiomarkerstouse$correctednijmegenohp17nmoll, 
         icahbiomarkerstouse$ohp17valuecorrected)
icahbiomarkerstouse$androstenedionevaluecorrected <- 
  ifelse(icahbiomarkerstouse$nijmegensentcorrection==1,
         icahbiomarkerstouse$correctednijmegenandrostenedionenmoll,
         icahbiomarkerstouse$androstenedionevaluecorrected)


```


```{r}
correctedbologna <- read.csv("./Responses of centres log for units/Responses from centres/Bologna/Bolognacorrectedbiomarkerstoload.csv")
correctedbologna$ohp17correctedbologna <- ifelse(correctedbologna$X == "delete" | correctedbologna$X == "delete record" , NA , correctedbologna$ohp17correctedbologna)
correctedbologna$androstenedionecorrectedbologna <- ifelse(correctedbologna$X == "delete" | correctedbologna$X == "delete record" , NA , correctedbologna$androstenedionecorrectedbologna)
correctedbolognatojoin <- 
  correctedbologna[,c("ï..Register.ID...Record", "assessment_id", "ohp17correctedbologna", "androstenedionecorrectedbologna", "ohp17.valueunitsohp17correctedbologna", "andostenedione.valueunitsohp17correctedbologna")]

correctedbolognatojoin$assessment_id <- as.character(correctedbolognatojoin$assessment_id)
correctedbolognatojoin$bolognasentcorrection <- 1



icahbiomarkerstouse <- 
  left_join(icahbiomarkerstouse, correctedbolognatojoin, 
            by=c("Register.ID...Record"="ï..Register.ID...Record", "assessment_id"="assessment_id"))
icahbiomarkerstouse$bolognasentcorrection <- ifelse(is.na(icahbiomarkerstouse$bolognasentcorrection), 
                                                                       0 , 
                                                                       icahbiomarkerstouse$bolognasentcorrection)
icahbiomarkerstouse$ohp17valuecorrected <- 
  ifelse(icahbiomarkerstouse$bolognasentcorrection==1,
  icahbiomarkerstouse$ohp17correctedbologna,
  icahbiomarkerstouse$ohp17valuecorrected)
icahbiomarkerstouse$androstenedionevaluecorrected <- 
  ifelse(icahbiomarkerstouse$bolognasentcorrection==1, 
         icahbiomarkerstouse$androstenedionecorrectedbologna,
         icahbiomarkerstouse$androstenedionevaluecorrected)

icahbiomarkerstouse$unitsohptouse <- 
  ifelse(icahbiomarkerstouse$bolognasentcorrection==1,
  icahbiomarkerstouse$ohp17.valueunitsohp17correctedbologna,
  icahbiomarkerstouse$unitsohptouse)
icahbiomarkerstouse$unitsandrostenedionetouse <- 
  ifelse(icahbiomarkerstouse$bolognasentcorrection==1, 
         icahbiomarkerstouse$andostenedione.valueunitsohp17correctedbologna,
         icahbiomarkerstouse$unitsandrostenedionetouse)

```

Aarhus sent through the following three corrections:

register ID 2923 assessmentid 2128 changed androstenedione to 0
register ID 2925 assessmentid 2171 changed androstenedione to NA
register ID 2925 assessmentid 2163 changed androstenedione to NA

```{r}
icahbiomarkerstouse$androstenedionevaluecorrected <- ifelse(
  icahbiomarkerstouse$Register.ID...Record == 2923 & icahbiomarkerstouse$assessment_id == 2128,
  0,
  icahbiomarkerstouse$androstenedionevaluecorrected)
icahbiomarkerstouse$androstenedionevaluecorrected <- ifelse(
  icahbiomarkerstouse$Register.ID...Record == 2925 & icahbiomarkerstouse$assessment_id == 2171,
  NA,
  icahbiomarkerstouse$androstenedionevaluecorrected)
icahbiomarkerstouse$androstenedionevaluecorrected <- ifelse(
  icahbiomarkerstouse$Register.ID...Record == 2925 & icahbiomarkerstouse$assessment_id == 2163,
  NA,
  icahbiomarkerstouse$androstenedionevaluecorrected)

  
```

Porto Alegre has explained that there has been a change to their units, so we need some manual code that changes the unit depending on age. Their answer was:

1) What units of 17-OH Progesterone are you entering into the Registry?
ng/dl; at least most of the results, I could check in the registry.
 2) What units of Androstenedione are you entering into the Registry?
ng/ml
 3) Have either of these measurement units changed between January 2000 and January 2021?
Yes
17-OH progesterone: 
ng/ml from 2013 to 2015; 
ng/dl from 2016 to 2020; 
this year come back to ng/ml.
 4) Do you ever enter values for these biomarkers measured in anything other than blood serum (e.g. saliva)?
No

```{r}
icahbiomarkerstouse$unitsohptouse <- ifelse ( icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                icahbiomarkerstouse$yearofvisit == 2013 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2014 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2015 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2021 ,
                                                                "ng/ml", icahbiomarkerstouse$unitsohptouse
                                                                  )
icahbiomarkerstouse$unitsohptouse <- ifelse ( icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                icahbiomarkerstouse$yearofvisit == 2016 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2017 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2018 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2019 |
                                                                icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre" &
                                                                  icahbiomarkerstouse$yearofvisit == 2020 ,
                                                                "ng/dl", icahbiomarkerstouse$unitsohptouse
                                                                  )



icahbiomarkerstouse$unitsandrostenedionetouse <- ifelse ( 
  icahbiomarkerstouse$Centre.Name...Centre=="Porto Alegre", "ng/ml", icahbiomarkerstouse$unitsandrostenedionetouse)

freq(subset(icahbiomarkerstouse, Centre.Name...Centre=="Porto Alegre")$unitsohptouse)

```

```{r}
icahalldatabackup3358 <- icahalldata
icahalldata <- icahalldatabackup3358
```

****************************

converting all biomarkers to the same units

*****************************

now, we can use units to convert all of the centres readings to nmol/l.

```{r}
icahbiomarkerstouse$ohpconversionfactor <- ifelse(icahbiomarkerstouse$unitsohptouse=="nmol/l", 1, NA)
icahbiomarkerstouse$ohpconversionfactor <- ifelse(icahbiomarkerstouse$unitsohptouse=="ng/dl", 0.030261, icahbiomarkerstouse$ohpconversionfactor)
icahbiomarkerstouse$ohpconversionfactor <- ifelse(icahbiomarkerstouse$unitsohptouse=="ng/ml", 3.0261, icahbiomarkerstouse$ohpconversionfactor)

icahbiomarkerstouse$androconversionfactor <- ifelse(icahbiomarkerstouse$unitsandrostenedionetouse=="nmol/l", 1, NA)
icahbiomarkerstouse$androconversionfactor <- ifelse(icahbiomarkerstouse$unitsandrostenedionetouse=="ng/dl", 0.034916, icahbiomarkerstouse$androconversionfactor)
icahbiomarkerstouse$androconversionfactor <- ifelse(icahbiomarkerstouse$unitsandrostenedionetouse=="ng/ml", 3.4916, icahbiomarkerstouse$androconversionfactor)

icahbiomarkerstouse$convertedohpmmoll <- icahbiomarkerstouse$ohp17valuecorrected * icahbiomarkerstouse$ohpconversionfactor
icahbiomarkerstouse$convertedandrostenedionemmoll <- icahbiomarkerstouse$androstenedionevaluecorrected * icahbiomarkerstouse$androconversionfactor

descr(icahbiomarkerstouse$convertedohpmmoll)
descr(icahbiomarkerstouse$convertedandrostenedionemmoll)

ggplot(data=icahbiomarkerstouse, aes(x=agetouse, y=convertedohpmmoll)) + geom_point(aes(colour=Centre.Name...Centre)) +themenolegend
ggplot(data=icahbiomarkerstouse, aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point(aes(colour=Centre.Name...Centre)) +themenolegend

icahalldata <- icahbiomarkerstouse
icahalldatabackup3399 <- icahalldata

```

now with my converted units, it would be good to see values of androstenedione over 50 alongside 17ohp

```{r}
dodgydata <- icahbiomarkerstouse[,c("Register.ID...Record", "ohp17.value","unitsohptouse", "ohp17correctedbologna", "ohp17valuecorrected", "andostenedione.value", "assessment_id","Centre.Name...Centre", "convertedohpmmoll", "convertedandrostenedionemmoll", "visitnumber", "hydrocortisoneperbsa")]
dodgyohp <- dodgydata %>% filter(convertedohpmmoll>500)
dodgyandrostenedione <- dodgydata %>% filter(convertedandrostenedionemmoll>50)
biomarkersover500orover50 <- bind_rows(dodgyohp, dodgyandrostenedione )
```


right - we now have some broadly interpretable biomarker data

********************************************

Number of centres and biomarkers with entries that have not been confirmed 

********************************************

```{r}
freq(icahbiomarkerstouse$unitsohptouse)
freq(icahbiomarkerstouse$unitsandrostenedionetouse)

icahalldatawithoutunitsorcorrectionsforohp <- icahbiomarkerstouse %>% filter(is.na(unitsohptouse))
icahalldatawithoutunitsorcorrectionsforandrostenedione <- icahbiomarkerstouse %>% filter(is.na(unitsandrostenedionetouse))

icahalldatawithoutunitsorcorrectionsforohpbuthasvalue <- 
  icahalldatawithoutunitsorcorrectionsforohp %>% filter(!is.na(ohp17.value))
icahalldatawithoutunitsorcorrectionsforandrostenedionebuthasvalue <- 
  icahalldatawithoutunitsorcorrectionsforandrostenedione %>% filter(!is.na(andostenedione.value))
```

so from those frames, we want to summarise the ohp17.value and andostenedione.value - how many readings from each centre

```{r}
lostohp <- icahalldatawithoutunitsorcorrectionsforohpbuthasvalue %>% group_by(Centre.Name...Centre) %>% summarise(
  npatients = n_distinct(Register.ID...Record),
  nvisits = length(assessment_id),
  firstquartohp17 = quantile(ohp17.value, 0.25, na.rm=T),
  medianohp17 = median(ohp17.value, na.rm=T),
  thirdquartohp17 = quantile(ohp17.value, 0.75, na.rm=T)
)
write.csv(lostohp, "lostohp.csv", row.names=F)

lostandrostenedione <- icahalldatawithoutunitsorcorrectionsforandrostenedionebuthasvalue %>% group_by(Centre.Name...Centre) %>% summarise(
  npatients = n_distinct(Register.ID...Record),
  nvisits = length(assessment_id),
  firstquartohp17 = quantile(andostenedione.value, 0.25, na.rm=T),
  medianohp17 = median(andostenedione.value, na.rm=T),
  thirdquartohp17 = quantile(andostenedione.value, 0.75, na.rm=T)
)
write.csv(lostandrostenedione, "lostandrostenedione.csv", row.names=F)
lostohp
```



***********************************

Number of biomarkers available for analysis

***********************************

I used to make a visit number here, but I don't think that's correct to do, as the visit number has been created before


let's create categories of the 17ohp
```{r}
icahbiomarkerstouse$convertedohp17category <- ifelse(icahbiomarkerstouse$convertedohpmmoll<12, "lessthan12", NA)
icahbiomarkerstouse$convertedohp17category <- ifelse(icahbiomarkerstouse$convertedohpmmoll >=12 & icahbiomarkerstouse$convertedohpmmoll<=36, "inrange12to36", icahbiomarkerstouse$convertedohp17category)
icahbiomarkerstouse$convertedohp17category <- ifelse(icahbiomarkerstouse$convertedohpmmoll>36, "morethan36", icahbiomarkerstouse$convertedohp17category)

```

split the frames into male and female to facilitate separate analysis

```{r}
icahbiomarkerstousemale <- icahbiomarkerstouse %>% filter(Sex.at.birth...Birth=="Male")
icahbiomarkerstousefemale <- icahbiomarkerstouse %>% filter(Sex.at.birth...Birth=="Female")
```

extract the most recent visits
```{r}
mostrecentmale <- icahbiomarkerstousemale %>% group_by(Register.ID...Record) %>% slice_max(agetouse)
nrow(mostrecentmale)
mostrecentfemale  <- icahbiomarkerstousefemale %>% group_by(Register.ID...Record) %>% slice_max(agetouse)
nrow(mostrecentfemale)

mostrecentohp <- icahbiomarkerstouse %>% filter(!is.na(convertedohpmmoll)) %>% group_by(Register.ID...Record) %>% slice_max(agetouse)
mostrecentandrostenedione <- icahbiomarkerstouse %>% filter(!is.na(convertedandrostenedionemmoll)) %>% group_by(Register.ID...Record) %>% slice_max(agetouse)

mostrecentbothbiomarkers <- icahbiomarkerstouse %>% 
  filter(!is.na(convertedohpmmoll) & !is.na(convertedandrostenedionemmoll)) %>% 
  group_by(Register.ID...Record) %>% slice_max(agetouse)
mostrecentbothbiomarkersmale <- mostrecentbothbiomarkers %>% filter(Sex.at.birth...Birth=="Male")
mostrecentbothbiomarkersfemale <- mostrecentbothbiomarkers %>% filter(Sex.at.birth...Birth=="Female")

mostrecenteitherbiomarker <- full_join(mostrecentohp, mostrecentandrostenedione)
mostrecenteitherbiomarker <- mostrecenteitherbiomarker %>%  group_by(Register.ID...Record) %>% slice_max(agetouse)
mostrecenteitherbiomarkermale <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Male")
mostrecenteitherbiomarkerfemale <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Female")

mostrecentohpmale <- icahbiomarkerstousemale %>% filter(!is.na(convertedohpmmoll)) %>% group_by(Register.ID...Record) %>% slice_max(agetouse)
mostrecentohpfemale <- icahbiomarkerstousefemale %>% filter(!is.na(convertedohpmmoll)) %>% group_by(Register.ID...Record) %>% slice_max(agetouse)

mostrecentandrostenedionemale <- icahbiomarkerstousemale %>% filter(!is.na(convertedandrostenedionemmoll)) %>% group_by(Register.ID...Record) %>% slice_max(agetouse)
mostrecentandrostenedionefemale <- icahbiomarkerstousefemale %>% filter(!is.na(convertedandrostenedionemmoll)) %>% group_by(Register.ID...Record) %>% slice_max(agetouse)

mostrecenteitherbiomarkerunder12 <- mostrecenteitherbiomarker %>% filter(agetouse < 12)
mostrecenteitherbiomarker12andover <- mostrecenteitherbiomarker %>% filter(agetouse >= 12)

mostrecentohpunder12   <- mostrecentohp %>% filter(agetouse < 12)
mostrecentohp12andover <- mostrecentohp %>% filter(agetouse >= 12)

mostrecentandrostenedioneunder12   <- mostrecentandrostenedione %>% filter(agetouse < 12)
mostrecentandrostenedione12andover <- mostrecentandrostenedione %>% filter(agetouse >= 12)

mostrecentandrostenedionemaleunder12   <- mostrecentandrostenedionemale %>% filter(agetouse < 12)
mostrecentandrostenedionemale12andover <- mostrecentandrostenedionemale %>% filter(agetouse >= 12)

mostrecentandrostenedionefemaleunder12   <- mostrecentandrostenedionefemale %>% filter(agetouse < 12)
mostrecentandrostenedionefemale12andover <- mostrecentandrostenedionefemale %>% filter(agetouse >= 12)

mostrecentohpmaleunder12   <- mostrecentohpmale %>% filter(agetouse < 12)
mostrecentohpmale12andover <- mostrecentohpmale %>% filter(agetouse >= 12)

mostrecentohpfemaleunder12   <- mostrecentohpfemale %>% filter(agetouse < 12)
mostrecentohpfemale12andover <- mostrecentohpfemale %>% filter(agetouse >= 12)

```

total stats to play with of each centre
```{r}
#freq(mostrecentohpmale$Register.ID...Record)
freqmostrecentohpmale <- as.data.frame(freq(mostrecentohpmale$Centre.Name...Centre))
colnames(freqmostrecentohpmale) <- paste(colnames(freqmostrecentohpmale), "ohpmale",  sep = "_")
freqmostrecentohpmale <- rownames_to_column(freqmostrecentohpmale, "centre")

freqmostrecentohpfemale <- as.data.frame(freq(mostrecentohpfemale$Centre.Name...Centre))
colnames(freqmostrecentohpfemale) <- paste(colnames(freqmostrecentohpfemale), "ohpfemale",  sep = "_")
freqmostrecentohpfemale <- rownames_to_column(freqmostrecentohpfemale, "centre")

freqmostrecentandrostenedionemale <- as.data.frame(freq(mostrecentandrostenedionemale$Centre.Name...Centre))
colnames(freqmostrecentandrostenedionemale) <- paste(colnames(freqmostrecentandrostenedionemale), "androstenedionemale",  sep = "_")
freqmostrecentandrostenedionemale <- rownames_to_column(freqmostrecentandrostenedionemale, "centre")

freqmostrecentandrostenedionefemale <- as.data.frame(freq(mostrecentandrostenedionefemale$Centre.Name...Centre))
colnames(freqmostrecentandrostenedionefemale) <- paste(colnames(freqmostrecentandrostenedionefemale), "androstenedionefemale",  sep = "_")
freqmostrecentandrostenedionefemale <- rownames_to_column(freqmostrecentandrostenedionefemale, "centre")

centrebiomarkerfrequencies <- full_join(freqmostrecentohpmale , freqmostrecentohpfemale, by = "centre")
centrebiomarkerfrequencies <- full_join(centrebiomarkerfrequencies, freqmostrecentandrostenedionemale, by = "centre")
centrebiomarkerfrequencies <- full_join(centrebiomarkerfrequencies, freqmostrecentandrostenedionefemale, by = "centre")
centrebiomarkerfrequencies

```

I just want to add the country to each centre now

```{r}
centrecountries <- icahalldata[,c("Centre.Name...Centre", "Country...Centre")]
centrecountries <- unique(centrecountries)
```

so now I can join the countries to the centre frequencies

```{r}
centrebiomarkerfrequencies <- left_join(centrebiomarkerfrequencies, centrecountries, by=c("centre"="Centre.Name...Centre"))
countrieswithbiomarkers <- as.data.frame(freq(centrebiomarkerfrequencies$Country...Centre))
countrieswithbiomarkers <- rownames_to_column(countrieswithbiomarkers, "country")

write.csv(centrebiomarkerfrequencies, "abstractcentrebiomarkerfrequencies.csv", row.names=F)
write.csv(countrieswithbiomarkers, "abstractcountrieswithbiomarkers.csv", row.names=F)
centrebiomarkerfrequencies
```



so looking at countrieswithbiomarkers and centrebiomarkerfrequencies, in my first iteration (in case any more centres reply), we have 12 countries and 19 centres for which we have biomarkers. 
in my second iteration excluding visits close to diagnosis we have 7 countries and 8 centres which doesn't make sense

we then need to look at a combination of mostrecent androstenedione and most recent ohp17, combine those frames to double check that we report the correct number of patients that have a biomarker



to get the recent biomarkers available, I want to take out the patient number, visit number and biomarker data and join it separately
```{r}
mostrecentohpmaletojoin <- mostrecentohpmale[,c("Register.ID...Record", "assessment_id", "agetouse", "convertedohpmmoll", "convertedohp17category")]
mostrecentohpfemaletojoin <- mostrecentohpfemale[,c("Register.ID...Record", "assessment_id", "agetouse", "convertedohpmmoll", "convertedohp17category")]

mostrecentandrostenedionemaletojoin <- mostrecentandrostenedionemale[,c("Register.ID...Record", "assessment_id", "agetouse", "convertedandrostenedionemmoll")]
mostrecentandrostenedionefemaletojoin <- mostrecentandrostenedionefemale[,c("Register.ID...Record", "assessment_id", "agetouse", "convertedandrostenedionemmoll")]

mostrecentbiomarkersmale <- full_join(mostrecentohpmaletojoin , mostrecentandrostenedionemaletojoin, by = c("Register.ID...Record", "assessment_id", "agetouse"))
  
mostrecentbiomarkersfemale <- full_join(mostrecentohpfemaletojoin , mostrecentandrostenedionefemaletojoin, by = c("Register.ID...Record", "assessment_id", "agetouse"))

#freq(mostrecentbiomarkersmale$Register.ID...Record)
```

Now report the number of patients that have a recent reading for 17ohp and the number that have a recent reading for androstenedione
```{r}
malepatientswithbiomarkers <- as.data.frame(freq(mostrecentbiomarkersmale$Register.ID...Record))
malepatientswithbiomarkers <- rownames_to_column(malepatientswithbiomarkers, "patient")
#malepatientswithbiomarkers <- malepatientswithbiomarkers["Total","Freq"]

femalepatientswithbiomarkers <- as.data.frame(freq(mostrecentbiomarkersfemale$Register.ID...Record))
femalepatientswithbiomarkers <- rownames_to_column(femalepatientswithbiomarkers, "patient")
#femalepatientswithbiomarkers <- femalepatientswithbiomarkers["Total","Freq"]


```

Total number of patients with each of the biomarkers with a recent sample available for analysis: This is using some patients that have two visits, because they have a biomarker measured on two different occasions, so I'm redoing this code
```{r}
#numbermalepatientswithbiomarkers <- malepatientswithbiomarkers %>% summarise(length(patient))
#numbermalepatientswithbiomarkers <- numbermalepatientswithbiomarkers[1,1] - 2

#numberfemalepatientswithbiomarkers <- femalepatientswithbiomarkers %>% summarise(length(patient))
#numberfemalepatientswithbiomarkers <- numberfemalepatientswithbiomarkers[1,1] - 2


#totalpatientswithbiomarkers <- numbermalepatientswithbiomarkers+numberfemalepatientswithbiomarkers


#proportionmale <- numbermalepatientswithbiomarkers / totalpatientswithbiomarkers * 100
#proportionfemale <- numberfemalepatientswithbiomarkers / totalpatientswithbiomarkers * 100
#numbermalepatientswithbiomarkers
#proportionmale
#numberfemalepatientswithbiomarkers
#proportionfemale
#totalpatientswithbiomarkers
```

we want the ages of the patients. This is slightly tricky and annoying as the patient list will be slightly different between the ohp17 and the androstenedione. For the abstract, I think we can save word count by simply reporting the median and IQR ages for the whole cohort of patients that had at least 1 reading of either 17ohp or androstenedione, just need to make sure it goes into an appropriate table in the actual poster or presentation


************

jocl

************
JOURNALmostrecenteitherbiomarker.csv

```{r}
#freq(mostrecenteitherbiomarker$Register.ID...Record)

freq(mostrecenteitherbiomarker$Sex.at.birth...Birth)
write.csv(as.data.frame(freq(mostrecenteitherbiomarker$Sex.at.birth...Birth)), "./JOURNALoutputs/mostrecenteitherbiomarker.csv")

freq(mostrecenteitherbiomarkerunder12$Sex.at.birth...Birth)
write.csv(as.data.frame(freq(mostrecenteitherbiomarkerunder12$Sex.at.birth...Birth)), "./JOURNALoutputs/mostrecenteitherbiomarkerunder12.csv")

freq(mostrecenteitherbiomarker12andover$Sex.at.birth...Birth)
write.csv(as.data.frame(freq(mostrecenteitherbiomarker12andover$Sex.at.birth...Birth)), "./JOURNALoutputs/mostrecenteitherbiomarker12andover.csv")
```
PREVIOUSLY:
This shows us that one patient has been recorded as not assigned, hence we have a theoretical total cohort of 349, but this isn't right as they don't get fed into either male or female analysis. We therefore say our total cohort is the males and the femals. We therefore want ages of the total cohort without not assigned
NOW THE not assigned are filtered out earlier

```{r}
agesoftotalcohort <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Male" | Sex.at.birth...Birth=="Female") %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesoftotalcohortmale <- mostrecenteitherbiomarkermale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesoftotalcohortfemale <- mostrecenteitherbiomarkerfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesofohpcohorttotal <- mostrecenteitherbiomarker %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  n = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesofandrostenedionecohorttotal <- mostrecentandrostenedione %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesofohpcohortmale <- mostrecentohpmale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))


agesofohpcohortfemale <- mostrecentohpfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))


agesofandrostenedionecohortmale <- mostrecentandrostenedionemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))


agesofandrostenedionecohortfemale <- mostrecentandrostenedionefemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesoftotalcohortunder12 <- mostrecenteitherbiomarkerunder12 %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesoftotalcohort12andover <- mostrecenteitherbiomarker12andover %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nage = sum(!is.na(agetouse), na.rm=T),
  firstquartage = round(quantile(agetouse, 0.25, na.rm=T), digits=2),
  medianage = round(median(agetouse, na.rm=T), digits=2),
  thirdquartage = round(quantile(agetouse, 0.75, na.rm=T), digits=2))

agesoftotalcohort$cohort <- "total"
agesoftotalcohortmale$cohort <- "totalmale"
agesoftotalcohortfemale$cohort <- "totalfemale"
agesofohpcohortmale$cohort <- "malewithohp"
agesofohpcohortfemale $cohort <- "femalewithohp"
agesofandrostenedionecohortmale$cohort <- "malewithandrostenedione"
agesofandrostenedionecohortfemale$cohort <- "femalewithandrostenedione"
agesoftotalcohortunder12$cohort <- "under12"
agesoftotalcohort12andover$cohort <- "twelveandover"

agesofpatients <- bind_rows(agesoftotalcohort, agesoftotalcohortmale, agesoftotalcohortfemale,  agesofohpcohortmale , agesofohpcohortfemale, agesofandrostenedionecohortmale, agesofandrostenedionecohortfemale, agesoftotalcohortunder12, agesoftotalcohort12andover)
write.csv(agesofpatients, "abstractagesofpatients.csv", row.names=F)
write.csv(agesofpatients, "./JOURNALoutputs/JOURNALagesofpatients.csv", row.names=F)
agesofpatients
```


***************

reporting the weight of each cohort

*****************

now I can simply just copy that code above that gives us ages for any other descriptive statistic. So in this case let's do it for weight z score


```{r}
weightoftotalcohort <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Male" | Sex.at.birth...Birth=="Female") %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightoftotalcohortmale <- mostrecenteitherbiomarkermale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightoftotalcohortfemale <- mostrecenteitherbiomarkerfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightofohpcohorttotal <- mostrecenteitherbiomarker %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  n = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightofandrostenedionecohorttotal <- mostrecentandrostenedione %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightofohpcohortmale <- mostrecentohpmale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))


weightofohpcohortfemale <- mostrecentohpfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))


weightofandrostenedionecohortmale <- mostrecentandrostenedionemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))


weightofandrostenedionecohortfemale <- mostrecentandrostenedionefemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightoftotalcohortunder12 <- mostrecenteitherbiomarkerunder12 %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightoftotalcohort12andover <- mostrecenteitherbiomarker12andover %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nweight = sum(!is.na(weightanalyserzscore), na.rm=T),
  firstquartage = quantile(weightanalyserzscore, 0.25, na.rm=T),
  medianweight = median(weightanalyserzscore, na.rm=T),
  thirdquartage = quantile(weightanalyserzscore, 0.75, na.rm=T))

weightoftotalcohort$cohort <- "total"
weightoftotalcohortmale$cohort <- "totalmale"
weightoftotalcohortfemale$cohort <- "totalfemale"
weightofohpcohortmale$cohort <- "malewithohp"
weightofohpcohortfemale $cohort <- "femalewithohp"
weightofandrostenedionecohortmale$cohort <- "malewithandrostenedione"
weightofandrostenedionecohortfemale$cohort <- "femalewithandrostenedione"
weightoftotalcohortunder12$cohort <- "under12"
weightoftotalcohort12andover$cohort <- "twelveandover"

weightofpatients <- bind_rows(weightoftotalcohort, weightoftotalcohortmale, weightoftotalcohortfemale,  weightofohpcohortmale , weightofohpcohortfemale, weightofandrostenedionecohortmale, weightofandrostenedionecohortfemale, weightoftotalcohortunder12, weightoftotalcohort12andover)
write.csv(weightofpatients, "abstractweightofpatients.csv", row.names=F)
write.csv(weightofpatients, "./JOURNALoutputs/JOURNALweightofpatients.csv", row.names=F)
weightofpatients
```




***************

reporting the dose of each cohort

*****************

now I can simply just copy that code above that gives us ages for any other descriptive statistic. So in this case let's do it for dose. We want to do this twice, once for the traditional dose that is entered (hydrocortisoneperbsa), and then also for my previoushydrocortisoneequivalentextrapolatedpercurrentbsa



```{r}
hydrocortisoneperbsatotalcohort <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Male" | Sex.at.birth...Birth=="Female") %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsatotalcohortmale <- mostrecenteitherbiomarkermale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsatotalcohortfemale <- mostrecenteitherbiomarkerfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsaohpcohorttotal <- mostrecenteitherbiomarker %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  n = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsaandrostenedionecohorttotal <- mostrecentandrostenedione %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsaohpcohortmale <- mostrecentohpmale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))


hydrocortisoneperbsaohpcohortfemale <- mostrecentohpfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))


hydrocortisoneperbsaandrostenedionecohortmale <- mostrecentandrostenedionemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))


hydrocortisoneperbsaandrostenedionecohortfemale <- mostrecentandrostenedionefemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsatotalcohortunder12 <- mostrecenteitherbiomarkerunder12 %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsatotalcohort12andover <- mostrecenteitherbiomarker12andover %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  ncurrentdosepercurrentbsa = sum(!is.na(hydrocortisoneperbsa), na.rm=T),
  firstquartage = quantile(hydrocortisoneperbsa, 0.25, na.rm=T),
  mediancurrentdosepercurrentbsa = median(hydrocortisoneperbsa, na.rm=T),
  thirdquartage = quantile(hydrocortisoneperbsa, 0.75, na.rm=T))

hydrocortisoneperbsatotalcohort$cohort <- "total"
hydrocortisoneperbsatotalcohortmale$cohort <- "totalmale"
hydrocortisoneperbsatotalcohortfemale$cohort <- "totalfemale"
hydrocortisoneperbsaohpcohortmale$cohort <- "malewithohp"
hydrocortisoneperbsaohpcohortfemale $cohort <- "femalewithohp"
hydrocortisoneperbsaandrostenedionecohortmale$cohort <- "malewithandrostenedione"
hydrocortisoneperbsaandrostenedionecohortfemale$cohort <- "femalewithandrostenedione"
hydrocortisoneperbsatotalcohortunder12$cohort <- "under12"
hydrocortisoneperbsatotalcohort12andover$cohort <- "twelveandover"

hydrocortisoneperbsapatients <- bind_rows(hydrocortisoneperbsatotalcohort, hydrocortisoneperbsatotalcohortmale, hydrocortisoneperbsatotalcohortfemale,  hydrocortisoneperbsaohpcohortmale , hydrocortisoneperbsaohpcohortfemale, hydrocortisoneperbsaandrostenedionecohortmale, hydrocortisoneperbsaandrostenedionecohortfemale, hydrocortisoneperbsatotalcohortunder12, hydrocortisoneperbsatotalcohort12andover)
write.csv(hydrocortisoneperbsapatients, "abstracthydrocortisoneperbsapatients.csv", row.names=F)
write.csv(hydrocortisoneperbsapatients, "./JOURNALoutputs/JOURNALhydrocortisoneperbsapatients.csv", row.names=F)
hydrocortisoneperbsapatients
```

```{r}
previousdoseextrapolatedpercurrentbsatotalcohort <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Male" | Sex.at.birth...Birth=="Female") %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohortmale <- mostrecenteitherbiomarkermale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohortfemale <- mostrecenteitherbiomarkerfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsaohpcohorttotal <- mostrecenteitherbiomarker %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  n = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsaandrostenedionecohorttotal <- mostrecentandrostenedione %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsaohpcohortmale <- mostrecentohpmale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))


previousdoseextrapolatedpercurrentbsaohpcohortfemale <- mostrecentohpfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))


previousdoseextrapolatedpercurrentbsaandrostenedionecohortmale <- mostrecentandrostenedionemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))


previousdoseextrapolatedpercurrentbsaandrostenedionecohortfemale <- mostrecentandrostenedionefemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohortunder12 <- mostrecenteitherbiomarkerunder12 %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohort12andover <- mostrecenteitherbiomarker12andover %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohort$cohort <- "total"
previousdoseextrapolatedpercurrentbsatotalcohortmale$cohort <- "totalmale"
previousdoseextrapolatedpercurrentbsatotalcohortfemale$cohort <- "totalfemale"
previousdoseextrapolatedpercurrentbsaohpcohortmale$cohort <- "malewithohp"
previousdoseextrapolatedpercurrentbsaohpcohortfemale $cohort <- "femalewithohp"
previousdoseextrapolatedpercurrentbsaandrostenedionecohortmale$cohort <- "malewithandrostenedione"
previousdoseextrapolatedpercurrentbsaandrostenedionecohortfemale$cohort <- "femalewithandrostenedione"
previousdoseextrapolatedpercurrentbsatotalcohortunder12$cohort <- "under12"
previousdoseextrapolatedpercurrentbsatotalcohort12andover$cohort <- "twelveandover"

previousdoseextrapolatedpercurrentbsapatients <- bind_rows(previousdoseextrapolatedpercurrentbsatotalcohort, previousdoseextrapolatedpercurrentbsatotalcohortmale, previousdoseextrapolatedpercurrentbsatotalcohortfemale,  previousdoseextrapolatedpercurrentbsaohpcohortmale , previousdoseextrapolatedpercurrentbsaohpcohortfemale, previousdoseextrapolatedpercurrentbsaandrostenedionecohortmale, previousdoseextrapolatedpercurrentbsaandrostenedionecohortfemale, previousdoseextrapolatedpercurrentbsatotalcohortunder12, previousdoseextrapolatedpercurrentbsatotalcohort12andover)
write.csv(previousdoseextrapolatedpercurrentbsapatients, "abstractpreviousdoseextrapolatedpercurrentbsapatients.csv", row.names=F)
write.csv(previousdoseextrapolatedpercurrentbsapatients, "./JOURNALoutputs/JOURNALpreviousdoseextrapolatedpercurrentbsapatients.csv", row.names=F)
previousdoseextrapolatedpercurrentbsapatients
```

the number of patients drops a lot when you use the previous dose per current bsa so we need to inspect it
```{r}
inspect <- mostrecenteitherbiomarker[,c("Register.ID...Record","medicine", "lagmedicine", "Has.treatment.changed.since.last.visit...Current.Medication", "lagmedicineextrapolated","visitnumber", "hydrocortisoneequivalent", "previoushydrocortisoneequivalent", "previoushydrocortisoneequivalentextrapolated", "totaldose", "totaldoseextrapolated", "bsa", "previousdose", "previoustotaldoseextrapolated")]

```

we can also do this for an ideal bsa




```{r}
previousdoseextrapolatedpercurrentbsatotalcohort <- mostrecenteitherbiomarker %>% filter(Sex.at.birth...Birth=="Male" | Sex.at.birth...Birth=="Female") %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohortmale <- mostrecenteitherbiomarkermale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohortfemale <- mostrecenteitherbiomarkerfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsaohpcohorttotal <- mostrecenteitherbiomarker %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  n = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsaandrostenedionecohorttotal <- mostrecentandrostenedione %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsaohpcohortmale <- mostrecentohpmale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))


previousdoseextrapolatedpercurrentbsaohpcohortfemale <- mostrecentohpfemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))


previousdoseextrapolatedpercurrentbsaandrostenedionecohortmale <- mostrecentandrostenedionemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))


previousdoseextrapolatedpercurrentbsaandrostenedionecohortfemale <- mostrecentandrostenedionefemale %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohortunder12 <- mostrecenteitherbiomarkerunder12 %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohort12andover <- mostrecenteitherbiomarker12andover %>% ungroup  %>% summarise(  
  nvisits = length(assessment_id),
  nprevdoseextrap = sum(!is.na(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa), na.rm=T),
  firstquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.25, na.rm=T),
  medianprevdoseextrap = median(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, na.rm=T),
  thirdquartage = quantile(previoushydrocortisoneequivalentextrapolatedpercurrentidealbsa, 0.75, na.rm=T))

previousdoseextrapolatedpercurrentbsatotalcohort$cohort <- "total"
previousdoseextrapolatedpercurrentbsatotalcohortmale$cohort <- "totalmale"
previousdoseextrapolatedpercurrentbsatotalcohortfemale$cohort <- "totalfemale"
previousdoseextrapolatedpercurrentbsaohpcohortmale$cohort <- "malewithohp"
previousdoseextrapolatedpercurrentbsaohpcohortfemale $cohort <- "femalewithohp"
previousdoseextrapolatedpercurrentbsaandrostenedionecohortmale$cohort <- "malewithandrostenedione"
previousdoseextrapolatedpercurrentbsaandrostenedionecohortfemale$cohort <- "femalewithandrostenedione"
previousdoseextrapolatedpercurrentbsatotalcohortunder12$cohort <- "under12"
previousdoseextrapolatedpercurrentbsatotalcohort12andover$cohort <- "twelveandover"

previousdoseextrapolatedpercurrentbsapatients <- bind_rows(previousdoseextrapolatedpercurrentbsatotalcohort, previousdoseextrapolatedpercurrentbsatotalcohortmale, previousdoseextrapolatedpercurrentbsatotalcohortfemale,  previousdoseextrapolatedpercurrentbsaohpcohortmale , previousdoseextrapolatedpercurrentbsaohpcohortfemale, previousdoseextrapolatedpercurrentbsaandrostenedionecohortmale, previousdoseextrapolatedpercurrentbsaandrostenedionecohortfemale, previousdoseextrapolatedpercurrentbsatotalcohortunder12, previousdoseextrapolatedpercurrentbsatotalcohort12andover)
write.csv(previousdoseextrapolatedpercurrentbsapatients, "abstractpreviousdoseextrapolatedpercurrentidealbsapatients.csv", row.names=F)
write.csv(previousdoseextrapolatedpercurrentbsapatients, "./JOURNALoutputs/JOURNALpreviousdoseextrapolatedpercurrentidealbsapatients.csv", row.names=F)
previousdoseextrapolatedpercurrentbsapatients
```



then we want the frequency of patients in each category of 17ohp and the percentage of each of them

```{r}
ohprangecategoriestotal <- freq(mostrecentohp$convertedohp17category)
ohprangecategoriesmale   <- freq(mostrecentohpmaletojoin$convertedohp17category)
ohprangecategoriesfemale <- freq(mostrecentohpfemaletojoin$convertedohp17category)
ohprangecategoriesunder12   <- freq(mostrecentohpunder12$convertedohp17category)
ohprangecategories12andover <- freq(mostrecentohp12andover$convertedohp17category)



ohprangecategoriestotal 
ohprangecategoriesmale
ohprangecategoriesfemale
ohprangecategoriesunder12 
ohprangecategories12andover 

write.csv(ohprangecategoriestotal, "./JOURNALoutputs/JOURNALohprangecategoriestotal.csv")
write.csv(ohprangecategoriesmale, "./JOURNALoutputs/JOURNALohprangecategoriesmale.csv")
write.csv(ohprangecategoriesfemale, "./JOURNALoutputs/JOURNALohprangecategoriesfemale.csv")
write.csv(ohprangecategoriesunder12, "./JOURNALoutputs/JOURNALohprangecategoriesunder12.csv")
write.csv(ohprangecategories12andover, "./JOURNALoutputs/JOURNALohprangecategories12andover.csv")
```



**************************************

summary statistics of corrected and converted biomarkers - the biomarker values we use are convertedohpmmoll and convertedandrostenedionemmoll

**************************************

we want to go by age, and we also want the last 5, 10 and 20 years

there is a bug in some of my old functions that will take more time to correct than is worthwhile

*********************

overall averages by centre

***************************

let's get summary stats and plots by visit year - the year of patient visit year of visit:
this spits out 
malesummarystatsbyyearofvisit
femalesummarystatsbyyearofvisit
combinedsummarybyyearofvisitplotohp
combinedsummarybyyearofvisitplotandrostenedione

```{r}
malesummarystatsbyyearofvisit <-  icahbiomarkerstousemale %>% group_by(yearofvisit) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),

  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
  nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )

femalesummarystatsbyyearofvisit <-  icahbiomarkerstousefemale %>% group_by(yearofvisit) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
    
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
  nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )

combinedsummarybyyearofvisitplotohp <- ggplot(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianohp17)) + 
  geom_line() +
#  geom_point(data=icahcleandatawithaucmale, aes(x=agetouse, y=convertedohpmmoll), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartohp17), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartohp17), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbyyearofvisit, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianohp17), colour="red") +
#  geom_point(data=icahbiomarkerstousefemale, aes(x=agetouse, y=convertedohpmmoll), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartohp17), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartohp17), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbyyearofvisit, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="pink") + 
  labs(title="Median 17-OH Progesterone by year of visit", subtitle="Ribbon's show interquartile range", x="Year of Visit", y= "17-OH Progesterone") +
  themenolegend

combinedsummarybyyearofvisitplotandrostenedione <- ggplot(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianandrostenedione)) + geom_line() +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartandrostenedione), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartandrostenedione), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbyyearofvisit, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianandrostenedione), colour="red") +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartandrostenedione), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartandrostenedione), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbyyearofvisit, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="pink") + 
  labs(title="Median Androstenedione by year of visit", subtitle="Ribbon's show interquartile range", x="Year of Visit", y= "Androstenedione") +
  themenolegend

combinedsummarybyyearofvisitplotheightsds <- ggplot(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianheightsds)) + 
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianheightsds)) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartheightsds), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartheightsds), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbyyearofvisit, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianheightsds), colour="red") +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartheightsds), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartheightsds), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbyyearofvisit, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="pink") + 
  labs(title="Median Height Standard Deviation Score by year of visit", subtitle="Ribbon's show interquartile range", x="Year of Visit", y= "Height Standard Deviation Score") +
  themenolegend
malesummarystatsbyyearofvisit
femalesummarystatsbyyearofvisit
combinedsummarybyyearofvisitplotohp
combinedsummarybyyearofvisitplotandrostenedione
combinedsummarybyyearofvisitplotheightsds

```

let's get summary stats and plots by patient age:

```{r}

malesummarystatsbypatientage <-  icahbiomarkerstousemale %>% group_by(flooragetouse) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
    nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )

femalesummarystatsbypatientage <-  icahbiomarkerstousefemale %>% group_by(flooragetouse) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
    
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
      nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )

#i have plotted the points into the male, but greyed them out as it really changes the scale - you can't limit the scale and not plot all the data, but it defeats the purpose of conveying the median and IQR

combinedsummarybypatientageplotohp <- ggplot(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianohp17)) + 
  geom_line() +
#  geom_point(data=icahcleandatawithaucmale, aes(x=agetouse, y=convertedohpmmoll), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartohp17), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartohp17), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbypatientage, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=medianohp17), colour="red") +
#  geom_point(data=icahbiomarkerstousefemale, aes(x=agetouse, y=convertedohpmmoll), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartohp17), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartohp17), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbypatientage, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="pink") + 
  labs(title="Median 17-OH Progesterone by patient age visit", subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "17-OH Progesterone") +
  themenolegend

combinedsummarybypatientageplotandrostenedione <- ggplot(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianandrostenedione)) + geom_line() +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartandrostenedione), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartandrostenedione), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbypatientage, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=medianandrostenedione), colour="red") +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartandrostenedione), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartandrostenedione), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbypatientage, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="pink") + 
  labs(title="Median Androstenedione by patient age visit", subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "Androstenedione") +
  themenolegend

combinedsummarybypatientageplotheightsds <- ggplot(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianheightsds)) + 
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianheightsds)) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartheightsds), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartheightsds), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbypatientage, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=medianheightsds), colour="red") +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartheightsds), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartheightsds), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbypatientage, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="pink") + 
  labs(title="Median Height Standard Deviation Score by patient age visit", subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "Height Standard Deviation Score") +
  themenolegend
malesummarystatsbypatientage
femalesummarystatsbypatientage
combinedsummarybypatientageplotohp
combinedsummarybypatientageplotandrostenedione
combinedsummarybypatientageplotheightsds


```

We can turn all these commands into a function, and then run that function through a list of each centre:

```{r}
summarisebyageandcentrefunction <- function(data, centretosummarise){

centre <- centretosummarise
datatosummarise <- subset(data, Centre.Name...Centre==centre)

datatosummarisemale <- datatosummarise %>% filter(Sex.at.birth...Birth=="Male")
datatosummarisefemale <- datatosummarise %>% filter(Sex.at.birth...Birth=="Female")

malesummarystatsbypatientage <-  datatosummarisemale %>% group_by(flooragetouse) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
    nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )
write.csv(malesummarystatsbypatientage, file=paste0("malesummarystatsbypatientage" , centre , ".csv"), row.names=F)
#nameofvariabletocreate <- paste0("malesummarystatsbypatientage", centre)
#assign(nameofvariabletocreate, malesummarystatsbypatientage, env=.GlobalEnv)


femalesummarystatsbypatientage <-  datatosummarisefemale %>% group_by(flooragetouse) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
    
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
      nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )
write.csv(femalesummarystatsbypatientage, file=paste0("femalesummarystatsbypatientage" , centre , ".csv"), row.names=F)

#nameofvariabletocreate <- paste0("femalesummarystatsbypatientage", centre)
#assign(nameofvariabletocreate, femalesummarystatsbypatientage, env=.GlobalEnv)
#i have plotted the points into the male, but greyed them out as it really changes the scale - you can't limit the scale and not plot all the data, but it defeats the purpose of conveying the median and IQR

combinedsummarybypatientageplotohp <- ggplot(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianohp17)) + 
  geom_line() +
#  geom_point(data=icahcleandatawithaucmale, aes(x=agetouse, y=convertedohpmmoll), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartohp17), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartohp17), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbypatientage, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=medianohp17), colour="red") +
#  geom_point(data=datatosummarisefemale, aes(x=agetouse, y=convertedohpmmoll), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartohp17), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartohp17), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbypatientage, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="pink") + 
  labs(title=paste0("Median 17-OH Progesterone by patient age visit : ", centre), subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "17-OH Progesterone") +
    xlim(0,20) + ylim(0,300) +
  themenolegend
ggsave(file=paste0("combinedsummarybypatientageplotohp", centre, ".tif"), plot=combinedsummarybypatientageplotohp, device="tiff", width=10, height=5.625 , compression = "lzw")

combinedsummarybypatientageplotandrostenedione <- ggplot(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianandrostenedione)) + geom_line() +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartandrostenedione), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartandrostenedione), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbypatientage, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=medianandrostenedione), colour="red") +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartandrostenedione), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartandrostenedione), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbypatientage, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="pink") + 
  labs(title=paste0("Median Androstenedione by patient age visit : ", centre), subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "Androstenedione") +
    xlim(0,20) + ylim(0,40) +
  themenolegend
ggsave(file=paste0("combinedsummarybypatientageplotandrostenedione", centre, ".tif"), plot=combinedsummarybypatientageplotandrostenedione, device="tiff", width=10, height=5.625 , compression = "lzw")

combinedsummarybypatientageplotheightsds <- ggplot(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianheightsds)) + 
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=medianheightsds)) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartheightsds), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartheightsds), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbypatientage, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=medianheightsds), colour="red") +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=firstquartheightsds), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbypatientage, aes(x=flooragetouse, y=thirdquartheightsds), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbypatientage, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="pink") + 
  labs(title=paste0("Median Height Standard Deviation Score by patient age visit : ", centre), subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "Height Standard Deviation Score") +
  xlim(0,20) + ylim(-7.5,2.5) +
  themenolegend
ggsave(file=paste0("combinedsummarybypatientageplotheightsds", centre, ".tif"), plot=combinedsummarybypatientageplotheightsds, device="tiff", width=10, height=5.625 , compression = "lzw")

#nameofvariabletocreate <- paste0("combinedsummarybypatientageplotohp", centretosummarise)
#assign(nameofvariabletocreate, combinedsummarybypatientageplotohp, env=.GlobalEnv)
#nameofvariabletocreate <- paste0("combinedsummarybypatientageplotandrostenedione", centretosummarise)
#assign(nameofvariabletocreate, combinedsummarybypatientageplotandrostenedione, env=.GlobalEnv)
#nameofvariabletocreate <- paste0("combinedsummarybypatientageplotheightsds", centretosummarise)
#assign(nameofvariabletocreate, combinedsummarybypatientageplotheightsds, env=.GlobalEnv)

}

```

you can create summary stats by each separate centre here:
```{r}
summarisebyageandcentrefunction(data=icahbiomarkerstouse, centretosummarise="Bologna")
summarisebyageandcentrefunction(data=icahbiomarkerstouse, centretosummarise="Barcelona")
summarisebyageandcentrefunction(data=icahbiomarkerstouse, centretosummarise="Utrecht")
```
now lets get a list of centres to run through that function

```{r}
centres <- rownames(freq(icahalldata$Centre.Name...Centre))

listofcentres <- as.list(centres)
listofcentres <- listofcentres[listofcentres != "<NA>"]
listofcentres <- listofcentres[listofcentres != "Total"]
```

now I can run the function through the list

```{r}
listofcentresummaries <- lapply(listofcentres, summarisebyageandcentrefunction, data=icahbiomarkerstouse)
```

could use that function on separate countries etc if you want to. It spits out tif files and csv files. I've greyed out the lines, but those can be use to create variables in the environment if you want.
you get

femalesummarystatsbypatientagecentre.csv
malesummarystatsbypatientagecentre.csv
combinedsummarybypatientageplotheightsdscentre.tif
combinedsummarybypatientageplotandrostenedionecentre.tif
combinedsummarybypatientageplotohpcentre.tif

```{r}
icahalldatabackup4037 <- icahalldata
```


let's create a similar function to do year of visit

```{r}
summarisebyyearandcentrefunction <- function(data, centretosummarise){

centre <- centretosummarise
datatosummarise <- subset(data, Centre.Name...Centre==centre)

datatosummarisemale <- datatosummarise %>% filter(Sex.at.birth...Birth=="Male")
datatosummarisefemale <- datatosummarise %>% filter(Sex.at.birth...Birth=="Female")

malesummarystatsbyyearofvisit <-  datatosummarisemale %>% group_by(yearofvisit) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
  nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )
write.csv(malesummarystatsbyyearofvisit, file=paste0("malesummarystatsbyyearofvisit" , centre , ".csv"), row.names=F)
#nameofvariabletocreate <- paste0("malesummarystatsbyyearofvisit", centre)
#assign(nameofvariabletocreate, malesummarystatsbyyearofvisit, env=.GlobalEnv)


femalesummarystatsbyyearofvisit <-  datatosummarisefemale %>% group_by(yearofvisit) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
    
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  
  nheightsds = sum(!is.na(heightanalyserzscore), na.rm=T),
  firstquartheightsds = quantile(heightanalyserzscore, 0.25, na.rm=T),
  medianheightsds = median(heightanalyserzscore, na.rm=T),
  thirdquartheightsds = quantile(heightanalyserzscore, 0.75, na.rm=T),
  )
write.csv(femalesummarystatsbyyearofvisit, file=paste0("femalesummarystatsbyyearofvisit" , centre , ".csv"), row.names=F)

#nameofvariabletocreate <- paste0("femalesummarystatsbyyearofvisit", centre)
#assign(nameofvariabletocreate, femalesummarystatsbyyearofvisit, env=.GlobalEnv)
#i have plotted the points into the male, but greyed them out as it really changes the scale - you can't limit the scale and not plot all the data, but it defeats the purpose of conveying the median and IQR

combinedsummarybyyearofvisitplotohp <- ggplot(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianohp17)) + 
  geom_line() +
#  geom_point(data=icahcleandatawithaucmale, aes(x=agetouse, y=convertedohpmmoll), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartohp17), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartohp17), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbyyearofvisit, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianohp17), colour="red") +
#  geom_point(data=datatosummarisefemale, aes(x=agetouse, y=convertedohpmmoll), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartohp17), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartohp17), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbyyearofvisit, aes(y=medianohp17, ymin=firstquartohp17, ymax=thirdquartohp17), alpha=0.3, fill="pink") + 
  labs(title=paste0("Median 17-OH Progesterone by patient age visit : ", centre), subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "17-OH Progesterone") +
    xlim(2000,2020) + ylim(0,300) +
  themenolegend
ggsave(file=paste0("combinedsummarybyyearofvisitplotohp", centre, ".tif"), plot=combinedsummarybyyearofvisitplotohp, device="tiff", width=10, height=5.625 , compression = "lzw")

combinedsummarybyyearofvisitplotandrostenedione <- ggplot(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianandrostenedione)) + geom_line() +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartandrostenedione), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartandrostenedione), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbyyearofvisit, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianandrostenedione), colour="red") +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartandrostenedione), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartandrostenedione), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbyyearofvisit, aes(y=medianandrostenedione, ymin=firstquartandrostenedione, ymax=thirdquartandrostenedione), alpha=0.3, fill="pink") + 
  labs(title=paste0("Median Androstenedione by patient age visit : ", centre), subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "Androstenedione") +
    xlim(2000,2020) + ylim(0,40) +
  themenolegend
ggsave(file=paste0("combinedsummarybyyearofvisitplotandrostenedione", centre, ".tif"), plot=combinedsummarybyyearofvisitplotandrostenedione, device="tiff", width=10, height=5.625 , compression = "lzw")

combinedsummarybyyearofvisitplotheightsds <- ggplot(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianheightsds)) + 
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianheightsds)) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartheightsds), colour="blue", alpha=0.3) +
  geom_line(data=malesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartheightsds), colour="blue", alpha=0.3) +
  geom_ribbon(data=malesummarystatsbyyearofvisit, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="blue") + 
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=medianheightsds), colour="red") +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=firstquartheightsds), colour="red", alpha=0.3) +
  geom_line(data=femalesummarystatsbyyearofvisit, aes(x=yearofvisit, y=thirdquartheightsds), colour="red", , alpha=0.3) +
  geom_ribbon(data=femalesummarystatsbyyearofvisit, aes(y=medianheightsds, ymin=firstquartheightsds, ymax=thirdquartheightsds), alpha=0.3, fill="pink") + 
  labs(title=paste0("Median Height Standard Deviation Score by patient age visit : ", centre), subtitle="Ribbon's show interquartile range", x="Patient Age at Visit", y= "Height Standard Deviation Score") +
  xlim(2000,2020) + ylim(-7.5,2.5) +
  themenolegend
ggsave(file=paste0("combinedsummarybyyearofvisitplotheightsds", centre, ".tif"), plot=combinedsummarybyyearofvisitplotheightsds, device="tiff", width=10, height=5.625 , compression = "lzw")

#nameofvariabletocreate <- paste0("combinedsummarybyyearofvisitplotohp", centretosummarise)
#assign(nameofvariabletocreate, combinedsummarybyyearofvisitplotohp, env=.GlobalEnv)
#nameofvariabletocreate <- paste0("combinedsummarybyyearofvisitplotandrostenedione", centretosummarise)
#assign(nameofvariabletocreate, combinedsummarybyyearofvisitplotandrostenedione, env=.GlobalEnv)
#nameofvariabletocreate <- paste0("combinedsummarybyyearofvisitplotheightsds", centretosummarise)
#assign(nameofvariabletocreate, combinedsummarybyyearofvisitplotheightsds, env=.GlobalEnv)

}

```


We can therefore now run this function through the list of centres to produce something for each centre - this takes a little while to do so can be greyed out for purposes of running the whole code
```{r}
#listofyearcentresummaries <- lapply(listofcentres, summarisebyyearandcentrefunction, data=icahbiomarkerstouse)
```

*************************************

Viewing categories of ages as box plots with p value comparisons

*************************************

we want our mean functions and sd functions
```{r}
fun_mean        <- function(x)  {return(data.frame(y=mean(x),label=mean(x,na.rm=T)))}
fun_sd          <- function(x)  {return(data.frame(y=sd(x),label=sd(x,na.rm=T)))}
fun_median      <- function(x)  {return(data.frame(y=median(x),label=mean(x,na.rm=T)))}
fun_1stquartile <- function(x)  {return(data.frame(y=quantile(x, 0.25, na.rm=T),label=sd(x,na.rm=T)))}
fun_3rdquartile <- function(x)  {return(data.frame(y=quantile(x, 0.75, na.rm=T),label=sd(x,na.rm=T)))}
```

we will want to make a function where categories can change if a coauthor says a different category would be better:

```{r}
summarystatscategorytablefunction <- function(data){
#data <- icahbiomarkerstousemale

centre <- "total"
dataname <- deparse(substitute(data))  
data <- data


#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

data$agecategory

data$agecategory <- ifelse(data$agetouse >= agecategory1low & data$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
data$agecategory <- ifelse(data$agetouse >= agecategory2low & data$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory3low & data$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory4low & data$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), data$agecategory)

summarystatsbycategory <-  data %>% group_by(agecategory) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategorytotal <-  data %>% group_by(Sex.at.birth...Birth) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategory <- bind_rows(summarystatsbycategory, summarystatsbycategorytotal)
nameofvariabletocreate <- paste0("summarytable", dataname)
assign(nameofvariabletocreate, summarystatsbycategory, env=.GlobalEnv)
write.csv(summarystatsbycategory, file=paste0(nameofvariabletocreate, ".csv"))

#thencreateaboxplot
datatoplot <- data[,c("agecategory", "assessment_id", "agetouse", "convertedohpmmoll", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]

comparison1 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("b", agecategory2low, "to", agecategory2high)) ))
comparison2 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))

comparison3 <- list(c((paste0("c", agecategory3low, "to", agecategory3high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


comparison4 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))
comparison5 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))

comparison6 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


plot <- ggplot(data=datatoplot, aes(x=agecategory, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 600) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend + ylim(0,800)

ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
}
```


*************************

Creation of summary statistics table

************************



now when you run this function it spits out csv files and tif files
the csv file will be 'summarytable' then the name of the data file you run through it.csv
e.g. summarytablemostrecentohpfemale.csv
then spits out tif files with boxplots such as ohp17mostrecentohp17female.tif
it renders the boxplot also in the console

```{r}
nrow(icahbiomarkerstouse)
summarystatscategorytablefunction(data = icahbiomarkerstousefemale)
summarystatscategorytablefunction(data = icahbiomarkerstousemale)

summarystatscategorytablefunction(data = mostrecentohp)
summarystatscategorytablefunction(data = mostrecentohpmale)
summarystatscategorytablefunction(data = mostrecentohpfemale)

summarystatscategorytablefunction(data = mostrecentandrostenedione)
summarystatscategorytablefunction(data = mostrecentandrostenedionemale)
summarystatscategorytablefunction(data = mostrecentandrostenedionefemale)

#mostrecentohpmale$visitnumber
```

NOTE THAT THAT FUNCTION AUTOMATICALLY splits by sex, as it was written for the abstract. HOwever, for the total table we want to report a complete total, so we want to tweak that function slightly to just give a summary table of the entire cohort

```{r}


summarystatstablefunction <- function(data){
#data <- icahbiomarkerstousemale

centre <- "total"
dataname <- deparse(substitute(data))  
data <- data


#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

data$agecategory <- ifelse(data$agetouse >= agecategory1low & data$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
data$agecategory <- ifelse(data$agetouse >= agecategory2low & data$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory3low & data$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory4low & data$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), data$agecategory)

summarystatsbycategory <-  data %>% group_by(agecategory) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )



summarystatsbycategorytotal <-  data  %>% ungroup() %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategory <- bind_rows(summarystatsbycategory, summarystatsbycategorytotal)
nameofvariabletocreate <- paste0("summarytablebothsexes", dataname)
assign(nameofvariabletocreate, summarystatsbycategory, env=.GlobalEnv)
write.csv(summarystatsbycategory, file=paste0(nameofvariabletocreate, ".csv"))

#thencreateaboxplot
datatoplot <- data[,c("agecategory", "assessment_id", "agetouse", "convertedohpmmoll", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]

comparison1 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("b", agecategory2low, "to", agecategory2high)) ))
comparison2 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))

comparison3 <- list(c((paste0("c", agecategory3low, "to", agecategory3high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


comparison4 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))
comparison5 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))

comparison6 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


plot <- ggplot(data=datatoplot, aes(x=agecategory, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 600) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend + ylim(0,800)

ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
}
```

now we run through with our most recent ohp data and our most recent androstenedione data
```{r}
summarystatstablefunction(mostrecentohp)
summarystatstablefunction(mostrecentandrostenedione)

```













**********************

getting centre results

***************




so that function gives us the total, let's tweak that function to give us the results by centre

```{r}
summarystatscategorytablebycentrefunction <- function(data, centre){
#data <- icahbiomarkerstousemale

centrename <- deparse(substitute(centre))
dataname <- deparse(substitute(data)) 

data <- data

data <- subset(data, Centre.Name...Centre==centre)
#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

data$agecategory

data$agecategory <- ifelse(data$agetouse >= agecategory1low & data$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
data$agecategory <- ifelse(data$agetouse >= agecategory2low & data$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory3low & data$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory4low & data$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), data$agecategory)

summarystatsbycategory <-  data %>% group_by(agecategory) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategorytotal <-  data %>% group_by(Sex.at.birth...Birth) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategory <- bind_rows(summarystatsbycategory, summarystatsbycategorytotal)
nameofvariabletocreate <- paste0("summarytable", dataname)
assign(nameofvariabletocreate, summarystatsbycategory, env=.GlobalEnv)
write.csv(summarystatsbycategory, file=paste0(nameofvariabletocreate, centre, ".csv"))

#thencreateaboxplot
datatoplot <- data[,c("agecategory", "assessment_id", "agetouse", "convertedohpmmoll", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]

comparison1 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("b", agecategory2low, "to", agecategory2high)) ))
comparison2 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))

comparison3 <- list(c((paste0("c", agecategory3low, "to", agecategory3high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


comparison4 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))
comparison5 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))

comparison6 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


plot <- ggplot(data=datatoplot, aes(x=agecategory, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ":",  centre)) + 
  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend + ylim(0,1000)

ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
}
```


```{r}
icahalldatabackup4379 <- icahalldata
nrow(icahalldata)
```

now try that out with a centre. this function spits out csv files that start summarytable and are appended by the name of the centre you run through it and a tif file 


```{r}
summarystatscategorytablebycentrefunction(data=mostrecentohpmale, centre="Bologna")
summarystatscategorytablebycentrefunction(data=mostrecentohpmale, centre="Barcelona")
summarystatscategorytablebycentrefunction(data=mostrecentohpmale, centre="Utrecht-CAH")
summarystatscategorytablebycentrefunction(data=mostrecentohpmale, centre="Sao Paulo")

summarystatscategorytablebycentrefunction(data=mostrecentohpfemale, centre="Bologna")
summarystatscategorytablebycentrefunction(data=mostrecentohpfemale, centre="Barcelona")
summarystatscategorytablebycentrefunction(data=mostrecentohpfemale, centre="Utrecht-CAH")
summarystatscategorytablebycentrefunction(data=mostrecentohpfemale, centre="Sao Paulo")
```

***********************

biomarkers of separate centres for both sexes combined

*********************
in my first draft of the journal writeup, I've opted to display the results from all centres with both sexes together. In this case:

lowest median 17OHp is either aarhus, nijmegen, utrecht
highest median 17OHp is either sao paulo, or stockholm

first, we have to tweak our function that spits out numbers for both sexes again, to be able to acknowledge a speciic centre


```{r}


summarystatstablebycentrefunction <- function(data, centre){
#data <- icahbiomarkerstousemale

centrename <- deparse(substitute(centre))
dataname <- deparse(substitute(data))  
data <- data

data <- subset(data, Centre.Name...Centre==centre)
#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

data$agecategory <- ifelse(data$agetouse >= agecategory1low & data$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
data$agecategory <- ifelse(data$agetouse >= agecategory2low & data$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory3low & data$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), data$agecategory)
data$agecategory <- ifelse(data$agetouse >= agecategory4low & data$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), data$agecategory)

summarystatsbycategory <-  data %>% group_by(agecategory) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )



summarystatsbycategorytotal <-  data  %>% ungroup() %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T),
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategory <- bind_rows(summarystatsbycategory, summarystatsbycategorytotal)
nameofvariabletocreate <- paste0("summarytablebothsexes", dataname, centre)
assign(nameofvariabletocreate, summarystatsbycategory, env=.GlobalEnv)
write.csv(summarystatsbycategory, file=paste0(nameofvariabletocreate, ".csv"))

#thencreateaboxplot
datatoplot <- data[,c("agecategory", "assessment_id", "agetouse", "convertedohpmmoll", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]

comparison1 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("b", agecategory2low, "to", agecategory2high)) ))
comparison2 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))

comparison3 <- list(c((paste0("c", agecategory3low, "to", agecategory3high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


comparison4 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("c", agecategory3low, "to", agecategory3high)) ))
comparison5 <- list(c((paste0("b", agecategory2low, "to", agecategory2high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))

comparison6 <- list(c((paste0("a", agecategory1low, "to", agecategory1high)) , (paste0("d", agecategory4low, "to", agecategory4high)) ))


plot <- ggplot(data=datatoplot, aes(x=agecategory, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 600) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend + ylim(0,800)

ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
}
```

```{r}
summarystatstablebycentrefunction(data=mostrecentohp, centre="Aarhus")
summarystatstablebycentrefunction(data=mostrecentohp, centre="Nijmegen")
summarystatstablebycentrefunction(data=mostrecentohp, centre="Utrecht-CAH")

summarystatstablebycentrefunction(data=mostrecentohp, centre="Stockholm")
summarystatstablebycentrefunction(data=mostrecentohp, centre="Sao Paulo")
```

similarly we need the numbers for the under 12s with androstenedione

judging by the plot, the lowest androstenedione in under 12s is either istanbul, nijmegen sao paulo or utrecht, the highest was bologna

```{r}

summarystatstablebycentrefunction(data=mostrecentandrostenedione, centre="Bologna")

summarystatstablebycentrefunction(data=mostrecentandrostenedione, centre="Nijmegen")
summarystatstablebycentrefunction(data=mostrecentandrostenedione, centre="Istanbul Marmara")
summarystatstablebycentrefunction(data=mostrecentandrostenedione, centre="Istanbul Zeynep Kamil")
summarystatstablebycentrefunction(data=mostrecentandrostenedione, centre="Bologna")
```

*************************************

Viewing categories of years as box plots with p value comparisons

*************************************

we want a function that splits the whole data set by categories to ensure we can use as much data as possible if we want to 
This means that patients can be in different categories, but I think that is justifiable in this instance
this spits out a csv file and a tif file
summarystatsbycategoryfemalepatients and summarystatsbycategorymalepatients csv files
then tif files
ohp17male(df)centre.tif
ohp17female(df)centre.tif
androstenedionemale(df)centre.tif
androstenedionefemale(df)centre.tif
androstenedionemaleover12icahbiomarkerstouseCentre.Name...Centre.tif
androstenedionemaleunder12icahbiomarkerstouseCentre.Name...Centre.tif


so our full file is icahbiomarkerstouse


```{r}
#BE CAREFUL HERE - IF I WANT TO COMPARE MEASUREMENTS FROM DIFFERENT YEARS, SHOULD I KEEP PATIENTS IN MULTIPLE CATEGORIES - I THINK YOU CAN JUSTIFY THAT AS LONG AS YOU ASTERISK IT ON THE PAPER/POSTER
data <- icahbiomarkerstouse

summarystatscategoryyeartablefunction <- function(data){
#data <- icahbiomarkerstousemale

  centre <- "total"
dataname <- deparse(substitute(data))  
data <- data




#note low is greater than or equal to to make sense for ages
yearcategory1low <- 2000
#note high goes to less than
yearcategory1high <- 2005

yearcategory2low <- 2005
yearcategory2high <- 2010
yearcategory3low <- 2010
yearcategory3high <- 2015
yearcategory4low <- 2015
yearcategory4high <- 2020

data$yearcategory <- ifelse(data$yearofvisit >= yearcategory1low & data$yearofvisit < yearcategory1high, paste0("a", yearcategory1low, "to", yearcategory1high), NA)
data$yearcategory <- ifelse(data$yearofvisit >= yearcategory2low & data$yearofvisit < yearcategory2high, paste0("b", yearcategory2low, "to", yearcategory2high), data$yearcategory)
data$yearcategory <- ifelse(data$yearofvisit >= yearcategory3low & data$yearofvisit < yearcategory3high, paste0("c", yearcategory3low, "to", yearcategory3high), data$yearcategory)
data$yearcategory <- ifelse(data$yearofvisit >= yearcategory4low & data$yearofvisit < yearcategory4high, paste0("d", yearcategory4low, "to", yearcategory4high), data$yearcategory)


#now if we paste the register id and year category, we can then slice max down that column, rather than slice maxing down the whole patient column
data$patientpastecategory <- paste0(data$Register.ID...Record, data$yearcategory)

mostrecentohpineachcategory <- data %>% filter(!is.na(convertedohpmmoll)) %>%  group_by(patientpastecategory) %>% slice_max(agetouse)
mostrecentandrostenedioneineachcategory <- data %>% filter(!is.na(convertedandrostenedionemmoll)) %>% group_by(patientpastecategory) %>% slice_max(agetouse)


dataohpmale <- mostrecentohpineachcategory %>% filter(Sex.at.birth...Birth=="Male")
dataohpfemale <- mostrecentohpineachcategory %>% filter(Sex.at.birth...Birth=="Female")
dataandrostenedionemale <- mostrecentandrostenedioneineachcategory %>% filter(Sex.at.birth...Birth=="Male")
dataandrostenedionefemale <- mostrecentandrostenedioneineachcategory %>% filter(Sex.at.birth...Birth=="Female")


summarystatsohpbycategorymale <-  dataohpmale %>% group_by(yearcategory) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T)
  )
  
summarystatsandrostenedionebycategorymale <-  dataandrostenedionemale %>% group_by(yearcategory) %>% summarise(
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )
summarystatsbycategorymale <- full_join(summarystatsohpbycategorymale, summarystatsandrostenedionebycategorymale)

summarystatsandrostenedionebycategorymaleunder12 <-  dataandrostenedionemale %>% filter(agetouse<12) %>% group_by(yearcategory) %>% summarise(
  nandrostenedioneunder12 = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedioneunder12 = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedioneunder12 = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedioneunder12 = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )
summarystatsbycategorymale <- full_join(summarystatsohpbycategorymale, summarystatsandrostenedionebycategorymaleunder12)

summarystatsandrostenedionebycategorymaleover12 <-  dataandrostenedionemale %>% filter(agetouse>12) %>% group_by(yearcategory) %>% summarise(
  nandrostenedioneover12 = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedioneover12 = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedioneover12 = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedioneover12 = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )
summarystatsbycategorymale <- full_join(summarystatsohpbycategorymale, summarystatsandrostenedionebycategorymaleover12)

summarystatsohpbycategorymaletotal <-  dataohpmale %>% group_by(Sex.at.birth...Birth) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T)
)



summarystatsandrostenedionebycategorymaletotal <-  dataandrostenedionemale %>% group_by(Sex.at.birth...Birth) %>% summarise(
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategorymaletotal <- full_join(summarystatsohpbycategorymaletotal, summarystatsandrostenedionebycategorymaletotal)

summarystatsbycategorymalepatients <- bind_rows(summarystatsbycategorymale, summarystatsbycategorymaletotal)
nameofvariabletocreate <- paste0("summarytablebyyearofvisitmale", dataname)
assign(nameofvariabletocreate, summarystatsbycategorymalepatients, env=.GlobalEnv)
write.csv(summarystatsbycategorymalepatients, file=paste0(nameofvariabletocreate, ".csv"))

###########################
#now do the female patients
###########################

summarystatsohpbycategoryfemale <-  dataohpfemale %>% group_by(yearcategory) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T)
  )
  
summarystatsandrostenedionebycategoryfemale <-  dataandrostenedionefemale %>% group_by(yearcategory) %>% summarise(
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )
summarystatsbycategoryfemale <- full_join(summarystatsohpbycategoryfemale, summarystatsandrostenedionebycategoryfemale)

summarystatsandrostenedionebycategoryfemaleunder12 <-  dataandrostenedionefemale %>% filter(agetouse<12) %>% group_by(yearcategory) %>% summarise(
  nandrostenedioneunder12 = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedioneunder12 = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedioneunder12 = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedioneunder12 = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )
summarystatsbycategoryfemale <- full_join(summarystatsbycategoryfemale, summarystatsandrostenedionebycategoryfemaleunder12)

summarystatsandrostenedionebycategoryfemaleover12 <-  dataandrostenedionefemale %>% filter(agetouse>12) %>% group_by(yearcategory) %>% summarise(
  nandrostenedioneover12 = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedioneover12 = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedioneover12 = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedioneover12 = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )
summarystatsbycategoryfemale <- full_join(summarystatsbycategoryfemale, summarystatsandrostenedionebycategoryfemaleover12)


summarystatsohpbycategoryfemaletotal <-  dataohpfemale %>% group_by(Sex.at.birth...Birth) %>% summarise(
  nvisits = length(assessment_id),
  nohp17 = sum(!is.na(convertedohpmmoll), na.rm=T),
  firstquartohp17 = quantile(convertedohpmmoll, 0.25, na.rm=T),
  medianohp17 = median(convertedohpmmoll, na.rm=T),
  thirdquartohp17 = quantile(convertedohpmmoll, 0.75, na.rm=T)
)

summarystatsandrostenedionebycategoryfemaletotal <-  dataandrostenedionefemale %>% group_by(Sex.at.birth...Birth) %>% summarise(
  nandrostenedione = sum(!is.na(convertedandrostenedionemmoll), na.rm=T),
  firstquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.25, na.rm=T),
  medianandrostenedione = median(convertedandrostenedionemmoll, na.rm=T),
  thirdquartandrostenedione = quantile(convertedandrostenedionemmoll, 0.75, na.rm=T),
  )

summarystatsbycategoryfemaletotal <- full_join(summarystatsohpbycategoryfemaletotal, summarystatsandrostenedionebycategoryfemaletotal)

summarystatsbycategoryfemalepatients <- bind_rows(summarystatsbycategoryfemale, summarystatsbycategoryfemaletotal)

nameofvariabletocreate <- paste0("summarytablebyyearofvisitfemale", dataname)
assign(nameofvariabletocreate, summarystatsbycategoryfemalepatients, env=.GlobalEnv)
write.csv(summarystatsbycategoryfemalepatients, file=paste0(nameofvariabletocreate, ".csv"))



#thencreateaboxplot
datatoplot <- dataohpmale[,c("yearcategory", "assessment_id", "agetouse", "convertedohpmmoll", "Sex.at.birth...Birth")]

comparison1 <- list(c((paste0("a", yearcategory1low, "to", yearcategory1high)) , (paste0("b", yearcategory2low, "to", yearcategory2high)) ))
comparison2 <- list(c((paste0("b", yearcategory2low, "to", yearcategory2high)) , (paste0("c", yearcategory3low, "to", yearcategory3high)) ))

comparison3 <- list(c((paste0("c", yearcategory3low, "to", yearcategory3high)) , (paste0("d", yearcategory4low, "to", yearcategory4high)) ))


comparison4 <- list(c((paste0("a", yearcategory1low, "to", yearcategory1high)) , (paste0("c", yearcategory3low, "to", yearcategory3high)) ))
comparison5 <- list(c((paste0("b", yearcategory2low, "to", yearcategory2high)) , (paste0("d", yearcategory4low, "to", yearcategory4high)) ))

comparison6 <- list(c((paste0("a", yearcategory1low, "to", yearcategory1high)) , (paste0("d", yearcategory4low, "to", yearcategory4high)) ))


ohpplot <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend + ylim(0,800)

ggsave(file=paste0("ohp17male", dataname, centre, ".tif"), plot=ohpplot, device="tiff", width=10, height=5.625 , compression = "lzw")

datatoplot <- dataohpmale[,c("yearcategory", "assessment_id", "agetouse", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]
androplot <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 50)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 20) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend #+ ylim(0,800)

ggsave(file=paste0("androstenedionemale", dataname, centre, ".tif"), plot=androplot, device="tiff", width=10, height=5.625 , compression = "lzw")

datatoplot <- dataohpmale[,c("yearcategory", "assessment_id", "agetouse", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]
datatoplot <- datatoplot %>% filter(agetouse < 12)
androplotunder12 <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 50)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 20) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend #+ ylim(0,800)

ggsave(file=paste0("androstenedionemaleunder12", dataname, centre, ".tif"), plot=androplotunder12, device="tiff", width=10, height=5.625 , compression = "lzw")


datatoplot <- dataohpmale[,c("yearcategory", "assessment_id", "agetouse", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]
datatoplot <- datatoplot %>% filter(agetouse > 12)
androplotover12 <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 50)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 20) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend #+ ylim(0,800)


ggsave(file=paste0("androstenedionemaleover12", dataname, centre, ".tif"), plot=androplotover12, device="tiff", width=10, height=5.625 , compression = "lzw")


datatoplot <- dataohpfemale[,c("yearcategory", "assessment_id", "agetouse", "convertedohpmmoll", "Sex.at.birth...Birth")]

comparison1 <- list(c((paste0("a", yearcategory1low, "to", yearcategory1high)) , (paste0("b", yearcategory2low, "to", yearcategory2high)) ))
comparison2 <- list(c((paste0("b", yearcategory2low, "to", yearcategory2high)) , (paste0("c", yearcategory3low, "to", yearcategory3high)) ))

comparison3 <- list(c((paste0("c", yearcategory3low, "to", yearcategory3high)) , (paste0("d", yearcategory4low, "to", yearcategory4high)) ))


comparison4 <- list(c((paste0("a", yearcategory1low, "to", yearcategory1high)) , (paste0("c", yearcategory3low, "to", yearcategory3high)) ))
comparison5 <- list(c((paste0("b", yearcategory2low, "to", yearcategory2high)) , (paste0("d", yearcategory4low, "to", yearcategory4high)) ))

comparison6 <- list(c((paste0("a", yearcategory1low, "to", yearcategory1high)) , (paste0("d", yearcategory4low, "to", yearcategory4high)) ))


ohpplot <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend + ylim(0,800)
ohpplot
ggsave(file=paste0("ohp17female", dataname, centre, ".tif"), plot=ohpplot, device="tiff", width=10, height=5.625 , compression = "lzw")

datatoplot <- dataohpfemale[,c("yearcategory", "assessment_id", "agetouse", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]
androplot <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 50)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 20) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend #+ ylim(0,800)

ggsave(file=paste0("androstenedionefemale", dataname, centre, ".tif"), plot=androplot, device="tiff", width=10, height=5.625 , compression = "lzw")

datatoplot <- dataohpfemale[,c("yearcategory", "assessment_id", "agetouse", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]
datatoplot <- datatoplot %>% filter(agetouse < 12)
androplotunder12 <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 50)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 20) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend #+ ylim(0,800)

ggsave(file=paste0("androstenedionefemaleunder12", dataname, centre, ".tif"), plot=androplotunder12, device="tiff", width=10, height=5.625 , compression = "lzw")


datatoplot <- dataohpfemale[,c("yearcategory", "assessment_id", "agetouse", "convertedandrostenedionemmoll", "Sex.at.birth...Birth")]
datatoplot <- datatoplot %>% filter(agetouse > 12)
androplotover12 <- ggplot(data=datatoplot, aes(x=yearcategory, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +geom_point() +
stat_compare_means(method = 'kruskal.test') + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 80) + 
  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 50)+ 
  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 20) + 
  labs(title=dataname) + stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
  themenolegend #+ ylim(0,800)


ggsave(file=paste0("androstenedionefemaleover12", dataname, centre, ".tif"), plot=androplotover12, device="tiff", width=10, height=5.625 , compression = "lzw")

}


summarystatscategoryyeartablefunction(icahbiomarkerstouse)
```






















*************************************

Assessing concordance between 17ohp readings and androstenedione cocl cocl

************************************

let's plot androstenedione against 17ohp
```{r}
concordanceplotallages <- ggplot(data=mostrecentbiomarkersmale, aes(x=convertedohpmmoll, y=convertedandrostenedionemmoll)) + geom_point(colour="blue") + geom_smooth(method="lm", colour="blue") + stat_regline_equation(label.y=70, colour="blue") +   stat_cor(label.y=60, colour="blue")  + geom_point(data=mostrecentbiomarkersfemale, colour="red") + geom_smooth(data=mostrecentbiomarkersfemale, colour="red", method="lm") + stat_regline_equation(data=mostrecentbiomarkersfemale,label.y=40, colour="red") +   stat_cor(data=mostrecentbiomarkersfemale,label.y=50, colour="red") +themenolegend

lmmale <- lm(data=mostrecentbiomarkersmale, convertedohpmmoll~convertedandrostenedionemmoll)
summary(lmmale)
lmfemale <- lm(data=mostrecentbiomarkersfemale, convertedohpmmoll~convertedandrostenedionemmoll)
summary(lmfemale)
#anova(lmmale, lmfemale)

ggsave(filename=paste("concordanceplotallages.tif"), plot = concordanceplotallages, device="tiff",  width=10, height=5.625, compression = "lzw")

```


so the markers correlate, but that doesn't make sense to report on its own as we know androstenedione varies significantly with age

so you either put age into the equation multiplying by androstenedione, or you categorise and do a simple regression


```{r}
lmmale <- lm(data=mostrecentbiomarkersmale, convertedohpmmoll~convertedandrostenedionemmoll*agetouse)
summary(lmmale)
plot(lmmale)
lmfemale <- lm(data=mostrecentbiomarkersfemale, convertedohpmmoll~convertedandrostenedionemmoll*agetouse)
summary(lmfemale)
plot(lmfemale)

```


```{r}
ggplot(
  data=subset(mostrecentbiomarkersmale, agetouse <12), aes(x=convertedohpmmoll, y=convertedandrostenedionemmoll)) + 
  geom_point(colour="blue") + 
  geom_smooth(method="lm", colour="blue") + 
  stat_regline_equation(colour="blue") +   
  stat_cor(label.y=80, colour="blue")  + 
  geom_point(data=subset(mostrecentbiomarkersmale, agetouse >=12), colour="dark blue") + 
  geom_smooth(data=subset(mostrecentbiomarkersmale, agetouse >=12), method="lm", colour="dark blue") + 
  stat_regline_equation(data=subset(mostrecentbiomarkersmale, agetouse >=12), label.x = 500, colour="dark blue") +   
  stat_cor(data=subset(mostrecentbiomarkersmale, agetouse >=12), label.x = 500, label.y=80, colour="dark blue")  + 

  geom_point(data=subset(mostrecentbiomarkersfemale, agetouse <12), colour="red") + 
  geom_smooth(data=subset(mostrecentbiomarkersfemale, agetouse <12), colour="red", method="lm") + 
  stat_regline_equation(data=subset(mostrecentbiomarkersfemale, agetouse <12), label.y=40, colour="red") +   
  stat_cor(data=subset(mostrecentbiomarkersfemale, agetouse <12), label.y=60, colour="red") +
  geom_point(data=subset(mostrecentbiomarkersfemale, agetouse >=12), colour="dark red") + 
  geom_smooth(data=subset(mostrecentbiomarkersfemale, agetouse >=12), colour="dark red", method="lm") + 
  stat_regline_equation(data=subset(mostrecentbiomarkersfemale, agetouse >=12), label.x = 500, label.y=40, colour="dark red") +   
  stat_cor(data=subset(mostrecentbiomarkersfemale, agetouse >=12), label.x = 500, label.y=60, colour="dark red") 

maleover12model <- lm(data=subset(mostrecentbiomarkersmale, agetouse >=12), convertedohpmmoll~convertedandrostenedionemmoll)
summary(maleover12model)

showmethedata <- subset(mostrecentbiomarkersmale, agetouse >=12)
showmethedata

ggplot(
  data=subset(mostrecentbiomarkersmale, agetouse <12), aes(x=convertedohpmmoll, y=convertedandrostenedionemmoll)) + 

  geom_point(data=subset(mostrecentbiomarkersmale, agetouse >=12), colour="dark blue") + 
  geom_smooth(data=subset(mostrecentbiomarkersmale, agetouse >=12), method="lm", colour="dark blue") + 
  stat_regline_equation(data=subset(mostrecentbiomarkersmale, agetouse >=12), label.x = 200, colour="dark blue") +   
  stat_cor(data=subset(mostrecentbiomarkersmale, agetouse >=12), label.x = 200, label.y=80, colour="dark blue") 
```




















**************************

viewing recent biomarkers by age as regression plots

*************************

we have the following frames to play with
mostrecentandrostenedionemale
mostrecentandrostenedionefemale
mostrecentohpmale
mostrecentohpfemale
mostrecentmale
mostrecentfemale

```{r}
ggplot(data=mostrecentohpmale, aes(x=agetouse, y=convertedohpmmoll)) + geom_point(colour="blue") + geom_smooth(method="lm") + stat_regline_equation(colour="blue") +   stat_cor(label.y=800, colour="blue") 
ggplot(data=mostrecentandrostenedionemale, aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point(colour="blue") + geom_smooth(method="lm",  colour="blue") + stat_regline_equation(colour="blue")+ stat_cor(label.y=40, colour="blue") 

outlier <- mostrecentohpmale %>% filter(convertedohpmmoll>1000)
outlier$ohp17.value

outlierfull <- icahalldata %>% filter(Register.ID...Record==2752)
outlierfull$hydrocortisoneperbsa


```


so androstenedione definitely goes up with age, probably with the exception of the first visit pre diagnosis

let's do the linear model as well to check the estimates

```{r}
ggplot(data=subset(mostrecentohpmale), aes(x=agetouse, y=convertedohpmmoll)) + geom_point(colour="blue") + geom_smooth(method="lm", colour="blue") + stat_regline_equation(colour="blue") +   stat_cor(label.y=800) + labs(title=deparse(substitute((mostrecentohpmale))))
ggplot(data=subset(mostrecentandrostenedionemale), aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point(colour="blue") + geom_smooth(method="lm", colour="blue") + stat_regline_equation(colour="blue")+ stat_cor(label.y=40) + labs(title=deparse(substitute((mostrecentandrostenedionemale))))
ggplot(data=subset(mostrecentohpfemale), aes(x=agetouse, y=convertedohpmmoll)) + geom_point(colour="red") + geom_smooth(method="lm", colour="red") + stat_regline_equation(colour="red") +   stat_cor(label.y=800) + labs(title=deparse(substitute((mostrecentohpfemale))))
ggplot(data=subset(mostrecentandrostenedionefemale), aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point(colour="red") + geom_smooth(method="lm", colour="red") + stat_regline_equation(colour="red")+ stat_cor(label.y=40) + labs(title=deparse(substitute((mostrecentandrostenedionefemale))))
ggplot(data=subset(mostrecentandrostenedionefemale, agetouse<5), aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point(colour="red") + geom_smooth(method="lm", colour="red") + stat_regline_equation(colour="red")+ stat_cor(label.y=40) + labs(title=deparse(substitute((mostrecentandrostenedionefemale))))
ggplot(data=subset(mostrecentandrostenedionefemale, agetouse>12), aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point(colour="red") + geom_smooth(method="lm", colour="red") + stat_regline_equation(colour="red")+ stat_cor(label.y=40) + labs(title=deparse(substitute((mostrecentandrostenedionefemale))))

malelm <- lm(data=subset(mostrecentandrostenedionemale), convertedandrostenedionemmoll ~ agetouse)
summary(malelm)

femalelm <- lm(data=subset(mostrecentandrostenedionefemale, visitnumber!=1),  convertedandrostenedionemmoll ~ agetouse)
summary(femalelm)

histogramfemaleandrostenedione <- ggplot(mostrecentandrostenedionefemale, aes(x=convertedandrostenedionemmoll)) +
  geom_histogram(bins=50, colour="black", fill="azure3")
histogramfemaleandrostenedione
```

interesting - it's not the state of the diagnosis and whether they're on treatment, it's the age of the patient.

You can't throw in a young person with androstenedione

let's subset without under 1s

```{r}

ggplot(data=subset(mostrecentohpmale, agetouse>1), aes(x=agetouse, y=convertedohpmmoll)) + geom_point() + geom_smooth(method=lm) + stat_regline_equation() +   stat_cor(label.y=800) + labs(title="removing patients under 1 years old")
ggplot(data=subset(mostrecentandrostenedionemale, agetouse>1), aes(x=agetouse, y=convertedandrostenedionemmoll)) + geom_point() + geom_smooth(method=lm) + stat_regline_equation()+ stat_cor(label.y=40) + labs(title="removing patients under 1 years old")
```

so without the under 1s, what will multiple change point analysis tell us about a change in mean?

change point analysis on androstenedione male: (package needs updating)
``{r}
options(mc.cores = 3)
#prior <- list(cp_1 = "dunif(2,20)")
mcp <- list(
convertedandrostenedionemmoll ~ 1,
~ 1 
)

fit <- mcp (mcp, data = subset(mostrecentandrostenedionemale, agetouse>1), par_x = "agetouse" )

plotfit <-  plot(fit)
plotfit
summary(fit)
summaryfit <- as.data.frame(summary(fit))
#ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")
fixef <- as.data.frame(mcp::fixef(fit))
write.csv(summaryfit, "summaryfit.csv")
write.csv(fixef, "fixef.csv")

mcp2 <- list(
convertedandrostenedionemmoll ~ 1,
~ 0 + agetouse 
)

fit2 <- mcp (mcp2, data = subset(mostrecentandrostenedionemale, agetouse>1), par_x = "agetouse" )

plotfit2 <-  plot(fit2)
plotfit2
summary(fit2)
summaryfit2 <- as.data.frame(summary(fit2))
#ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")
fixef2 <- as.data.frame(mcp::fixef(fit2))
write.csv(summaryfit2, "summaryfit2.csv")
write.csv(fixef2, "fixef2.csv")

``

change point analysis on androstenedione female:
``{r}
options(mc.cores = 3)
#prior <- list(cp_1 = "dunif(2,20)")
mcp <- list(
convertedandrostenedionemmoll ~ 1,
~ 1 
)

fit <- mcp (mcp, data = subset(mostrecentandrostenedionefemale, agetouse>1), par_x = "agetouse" )

plotfit <-  plot(fit)
plotfit
summary(fit)
summaryfit <- as.data.frame(summary(fit))
#ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")
fixef <- as.data.frame(mcp::fixef(fit))
write.csv(summaryfit, "summaryfit.csv")
write.csv(fixef, "fixef.csv")

mcp2 <- list(
convertedandrostenedionemmoll ~ 1,
~ 0 + agetouse 
)

fit2 <- mcp (mcp2, data = subset(mostrecentandrostenedionefemale, agetouse>1), par_x = "agetouse" )

plotfit2 <-  plot(fit2)
plotfit2
summary(fit2)
summaryfit2 <- as.data.frame(summary(fit2))
#ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")
fixef2 <- as.data.frame(mcp::fixef(fit2))
write.csv(summaryfit2, "summaryfit2.csv")
write.csv(fixef2, "fixef2.csv")

``

``{r}
options(mc.cores = 3)
#prior <- list(cp_1 = "dunif(2,20)")
mcp <- list(
convertedandrostenedionemmoll ~ 1,
~ 1,
~ 1
)

fit <- mcp (mcp, data = mostrecentandrostenedionefemale, par_x = "agetouse" )

plotfit <-  plot(fit)
plotfit
summary(fit)
summaryfit <- as.data.frame(summary(fit))
#ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")
fixef <- as.data.frame(mcp::fixef(fit))
write.csv(summaryfit, "summaryfit.csv")
write.csv(fixef, "fixef.csv")

mcp2 <- list(
convertedandrostenedionemmoll ~ 1,
~ 0 + agetouse 
)

fit2 <- mcp (mcp2, data = mostrecentandrostenedionefemale, par_x = "agetouse" )

plotfit2 <-  plot(fit2)
plotfit2
summary(fit2)
summaryfit2 <- as.data.frame(summary(fit2))
#ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")
fixef2 <- as.data.frame(mcp::fixef(fit2))
write.csv(summaryfit2, "summaryfit2.csv")
write.csv(fixef2, "fixef2.csv")

``




*********************************************

Comparing centres median values cocl cocl 

*********************************************

we now want some code that compares the centres, and then only compares centres with a particular number of readings

we want to take mostrecentandrostenedionefemale etc and plot them as boxplots

The question is, how many readings per centre do you need to be able to make a meaningful comparison between centres?

```{r}


minreadingspercentre <- 10

dataname <- deparse(substitute(mostrecentohpmale))
centre <- "total"

datatoplot <- mostrecentohpmale
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
datatoplotview <- datatoplot[,c("Centre.Name...Centre", "convertedohpmmoll", "convertedandrostenedionemmoll")]
str(datatoplotview)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
# geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
stat_summary(fun.data = fun_median, geom="text", aes( label=paste("median =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-20, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend +    ylim(0,2000)
#plot
ggsave(file=paste0("ohp17male", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot


datatoplot <- mostrecentohpfemale
dataname <- deparse(substitute(mostrecentohpfemale))
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +
  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("ohp17female", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

datatoplot <- mostrecentandrostenedionemale
dataname <- deparse(substitute(mostrecentandrostenedionemale))
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("androstenedioneallmale", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

datatoplot <- mostrecentandrostenedionefemale
dataname <- deparse(substitute(mostrecentandrostenedionefemale))
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
  rotate_x_text(60) +
  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("androstenedioneallfemale", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

datatoplot <- mostrecentandrostenedionemale
dataname <- deparse(substitute(mostrecentandrostenedionemale))
#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory1low & datatoplot$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory2low & datatoplot$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory3low & datatoplot$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory4low & datatoplot$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), datatoplot$agecategory)


frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre) %>% filter(agecategory == "a0to12")
datatoplot$agecat
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre, " age 0-12")) + 
    rotate_x_text(60) +#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("androstenedione0to12male", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

datatoplot <- mostrecentandrostenedionemale
dataname <- deparse(substitute(mostrecentandrostenedionemale))
#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory1low & datatoplot$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory2low & datatoplot$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory3low & datatoplot$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory4low & datatoplot$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), datatoplot$agecategory)


frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre) %>% filter(agecategory == "b12to20")
datatoplot$agecat
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre, " age 12-20")) + 
    rotate_x_text(60) +#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("androstenedione12to20male", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

datatoplot <- mostrecentandrostenedionefemale
dataname <- deparse(substitute(mostrecentandrostenedionefemale))
#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory1low & datatoplot$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory2low & datatoplot$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory3low & datatoplot$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory4low & datatoplot$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), datatoplot$agecategory)


frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre) %>% filter(agecategory == "a0to12")
datatoplot$agecat
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre, " age 0-12")) + 
    rotate_x_text(60) +#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("androstenedione0to12female", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

datatoplot <- mostrecentandrostenedionefemale
dataname <- deparse(substitute(mostrecentandrostenedionefemale))
#note low is greater than or equal to to make sense for ages
agecategory1low <- 0
#note high goes to less than
agecategory1high <- 12

agecategory2low <- 12
agecategory2high <- 20
agecategory3low <- 21
agecategory3high <- 30
agecategory4low <- 31
agecategory4high <- 40

datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory1low & datatoplot$agetouse < agecategory1high, paste0("a", agecategory1low, "to", agecategory1high), NA)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory2low & datatoplot$agetouse < agecategory2high, paste0("b", agecategory2low, "to", agecategory2high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory3low & datatoplot$agetouse < agecategory3high, paste0("c", agecategory3low, "to", agecategory3high), datatoplot$agecategory)
datatoplot$agecategory <- ifelse(datatoplot$agetouse >= agecategory4low & datatoplot$agetouse < agecategory4high, paste0("d", agecategory4low, "to", agecategory4high), datatoplot$agecategory)


frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre) %>% filter(agecategory == " b12to20")
datatoplot$agecat
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedandrostenedionemmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre, " age 12-20")) + 
    rotate_x_text(60) +#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
ggsave(file=paste0("androstenedione12to20female", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

```


so we have a significant difference between centres for female patients but not for male patients. You lose this statistical significance in androstenedione when you separate by age categories, so I'd say that is proof that that is an incorrect finding - it will be due to different patient ages. 

The female 17ohp appears to be a significant finding though


```{r}
minreadingspercentre <- 2
datatoplot <- mostrecentohpfemale
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +
#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
#ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

minreadingspercentre <- 3
datatoplot <- mostrecentohpfemale
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +
#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
#ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot

minreadingspercentre <- 4
datatoplot <- mostrecentohpfemale
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +
#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
#ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
```


```{r}
minreadingspercentre <- 7
datatoplot <- mostrecentohpfemale
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() + 
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +
#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
#ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
```
```{r}
minreadingspercentre <- 9
datatoplot <- mostrecentohpfemale
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
plot <- ggplot(data=datatoplot, aes(x=Centre.Name...Centre, y=convertedohpmmoll)) +
  geom_boxplot() + geom_point() +  geom_point() +geom_point() +
stat_compare_means(method = 'kruskal.test') + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison1, comparison2, comparison3), y_position = 800) + 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison4, comparison5), y_position = 500)+ 
#  geom_signif(test = "wilcox.test",comparisons=c(comparison6), y_position = 200) + 
  labs(title=paste0(dataname, ": minimum readings per centre = ", minreadingspercentre)) + 
    rotate_x_text(60) +
#  stat_summary(fun.data = fun_median, geom="text", vjust=-15, aes( label=paste("Median =",round(..y.., digits=2)))) +
#  stat_summary(fun.data = fun_mean, geom="text", aes( label=paste("mean =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_1stquartile, geom="text", vjust=-20, aes( label=paste("first =",round(..y.., digits=2))))  + 
#  stat_summary(fun.data = fun_3rdquartile, geom="text", vjust=-12, aes( label=paste("third =",round(..y.., digits=2)))) +
 themenolegend #   + ylim(0,1000)
#plot
#ggsave(file=paste0("ohp17", dataname, centre, ".tif"), plot=plot, device="tiff", width=10, height=5.625 , compression = "lzw")
plot
```


Over 10 readings shows a significant difference between centres now that Sao Paulo is in the mix



```{r}
icahalldatabackup5452 <- icahalldata
icahalldata <- icahalldatabackup5452
```



*********************************************

Comparing centres' variances cocl cocl 

*********************************************

We also want to see whether different centres have a greater variance of results than each other. For this, we're not normally distributed, so we want to use Levene's test

Levene’s test: Compare the variances of k samples, where k can be more than two samples. It’s an alternative to the Bartlett’s test that is less sensitive to departures from normality.

let's start with the variance of ohp readings

let's take my code from the journal visualisations
```{r}
minreadingspercentre <- 10

dataname <- deparse(substitute(mostrecentohp))
centre <- "total"

datatoplot <- mostrecentohp
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
datatoplotview <- datatoplot[,c("Centre.Name...Centre", "convertedohpmmoll", "convertedandrostenedionemmoll")]
str(datatoplotview)
freq(datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Belgrade - Endocrinology","Belgrade",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Glasgow RHC","Glasgow",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Utrecht-CAH","Utrecht",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Istanbul Marmara","Istanbul\nMarmara",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Istanbul Zeynep Kamil","Istanbul\nZeynep\nKamil",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="","",datatoplot$Centre.Name...Centre)
```

with this datatoplot file, we can carry out levene's test, without creating a plot

```{r}
library(car)
leveneTest(convertedohpmmoll ~ Centre.Name...Centre, data = datatoplot)
```
there is therefore a difference in variances, with a p value of 0.0001


```{r}
minreadingspercentre <- 10

dataname <- deparse(substitute(mostrecentandrostenedioneunder12))
centre <- "total"

datatoplot <- mostrecentandrostenedioneunder12
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
datatoplotview <- datatoplot[,c("Centre.Name...Centre", "convertedohpmmoll", "convertedandrostenedionemmoll")]
str(datatoplotview)
freq(datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Belgrade - Endocrinology","Belgrade",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Glasgow RHC","Glasgow",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Utrecht-CAH","Utrecht",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Istanbul Marmara","Istanbul\nMarmara",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Istanbul Zeynep Kamil","Istanbul\nZeynep\nKamil",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="","",datatoplot$Centre.Name...Centre)

```

with this datatoplot file, we can carry out levene's test, without creating a plot

```{r}
library(car)
leveneTest(convertedandrostenedionemmoll ~ Centre.Name...Centre, data = datatoplot)
```

there is no difference in variance in between the centres in androstenedione under 12


```{r}
minreadingspercentre <- 10

dataname <- deparse(substitute(mostrecentandrostenedione12andover))
centre <- "total"

datatoplot <- mostrecentandrostenedione12andover
frequencies <- as.data.frame(freq(datatoplot$Centre.Name...Centre))
frequencies <- rownames_to_column(frequencies, "centre")
datatoplot <- left_join(datatoplot, frequencies, by=c("Centre.Name...Centre"="centre"))
datatoplot <- datatoplot %>% filter(Freq > minreadingspercentre)
datatoplotview <- datatoplot[,c("Centre.Name...Centre", "convertedohpmmoll", "convertedandrostenedionemmoll")]
str(datatoplotview)
freq(datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Belgrade - Endocrinology","Belgrade",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Glasgow RHC","Glasgow",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Utrecht-CAH","Utrecht",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Istanbul Marmara","Istanbul\nMarmara",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="Istanbul Zeynep Kamil","Istanbul\nZeynep\nKamil",datatoplot$Centre.Name...Centre)
datatoplot$Centre.Name...Centre <- ifelse(datatoplot$Centre.Name...Centre=="","",datatoplot$Centre.Name...Centre)

```

```{r}
library(car)
leveneTest(convertedandrostenedionemmoll ~ Centre.Name...Centre, data = datatoplot)
```

and again, there is no difference in variance 



















********************************

Viewing the visits with units to inform contacting the centres cocl cocl 

*******************************



now the main frame has the units that we know from that previous extraction in it, where they apply
```{r}
icahalldatawithpreviousunitstoview <- icahalldatawithpreviousunits[,c("assessment_id", "Centre.Name...Centre", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits")]
```

now we can take out bologna data

```{r}
library(dplyr)
icahbologna <- icahalldatawithpreviousunits %>% filter(Centre.Name...Centre == "Bologna")
icahbolognabiomarkers <- icahbologna[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits")]
```

now that I have bologna, I want to separate into 
ohp17 in ng/dL
ohp17 in ng/ml
androstenedione in ng/dl
androstenedione in ng/ml
either of the values without units

```{r}
icahbolognabiomarkersml <- icahbolognabiomarkers %>% filter(ohp17.valueunits=="ng/ml" | andostenedione.valueunits=="ng/ml")
icahbolognabiomarkersdl <- icahbolognabiomarkers %>% filter(ohp17.valueunits=="ng/dl" | andostenedione.valueunits=="ng/dl")
icahbolognabiomarkersohpnounits <- icahbolognabiomarkers %>% filter(is.na(ohp17.valueunits))
icahbolognabiomarkersandrostenedionenounits <- icahbolognabiomarkers %>% filter(is.na(andostenedione.valueunits))
                                                            


```
now we convert our thresholds:

100nmol/L = 33.3 ng/mL = 3333 ng/dL of 17ohp
8nmol/L = 2291.2 ng/L = 2.29 ng/mL = 229 ng/dL of androstenedione

so 17ohp over 33.3ng/mL

```{r}
highohpml <- icahbolognabiomarkersml%>% filter(ohp17.value>33.3)
highandrostenedioneml <- icahbolognabiomarkersml %>% filter(andostenedione.value > 2.29)
highohpdl <- icahbolognabiomarkersdl%>% filter(ohp17.value>3333)
highandrostenedionedl <- icahbolognabiomarkersdl %>% filter(andostenedione.value > 229)

```

looking down the biomarkers with no units - androstenedione is easy to tease apart
17ohp 216 needs clarification
We can then say that any entries of androstenedione of 30 are ng/dL

```{r}
lowohpforclarification <- icahbolognabiomarkersohpnounits %>% filter(ohp17.value<250)
lowohpforclarification <- lowohpforclarification %>% filter (andostenedione.value <30 | is.na(andostenedione.value))
```

now we can ask for clarification on the following all bound together, and made unique

```{r}
bolognaclarification <- rbind(highohpml,highandrostenedioneml,highohpdl,highandrostenedionedl,lowohpforclarification)
bolognaclarification <- unique(bolognaclarification)
```
we can also remove those visits that have readings of zero and zero for both biomarkers

```{r}
bolognaclarificationbothzero <- bolognaclarification %>% filter(ohp17.value ==0 & andostenedione.value ==0 )
bolognaclarificationwithoutdoublezero <- subset(bolognaclarification, !(assessment_id %in% bolognaclarificationbothzero$assessment_id)) 
write.csv(bolognaclarificationwithoutdoublezero, "biomarkerunitsforbolognatoconfirm.csv", row.names=F)
```


```{r}
#icahbolognabiomarkers <- icahbologna[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "ohp17.valueunits", "andostenedione.value", "andostenedione.valueunits")]
#icahbolognabiomarkerswithunits <- left_join(icahbolognabiomarkers, previousextractionwithunitstojoin, by="visitdate") 
#icahbolognabiomarkerswithunits <- icahbolognabiomarkerswithunits %>% filter(Centre=="Bologna")
```

filter those < 120 for 17ohp and ask to check they are in ng/ml

filter those < 10 for ng/dL


```{r}
str(icahbolognabiomarkers)
icahbolognabiomarkerslow17ohp <- icahbolognabiomarkers %>% filter(ohp17.value <= 120)
icahbolognabiomarkershigh17ohp <- icahbolognabiomarkers %>% filter(ohp17.value > 120)
icahbolognabiomarkerslowandrostenedione <- icahbolognabiomarkers %>% filter(andostenedione.value <= 10)
icahbolognabiomarkershighandrostenedione <- icahbolognabiomarkers %>% filter(andostenedione.value > 10)
```

```{r}
library(ggplot2)
ggplot(icahbolognabiomarkers, aes(x=ohp17.value, y=andostenedione.value)) + geom_point() + ylim(0,100) + labs(title="Correlated serum measurements from Bologna")
```

```{r}
icahbolognaunitstoconfirm <- icahbolognabiomarkers %>% filter(ohp17.value <= 4000 & andostenedione.value <30 )
#first pull out those with double zero
icahbolognaunitstoconfirmwithdoublezero <- icahbolognaunitstoconfirm %>% filter(ohp17.value ==0 & andostenedione.value ==0 )
#then remove the visits with double zero
icahbolognaunitstoconfirmwithoutdoublezero <- subset(icahbolognaunitstoconfirm, !(assessment_id %in% icahbolognaunitstoconfirmwithdoublezero$assessment_id))        

icahbolognaunitstoconfirmwithoutdoublezero$assessment_id
icahbolognaunitstoconfirmwithoutdoublezero$Register.ID...Record

```




**************************

Nijmegen

**************************

email has stated they would like clarification about which visits are required to be reviewed


```{r}
icahnijmegen <- icahbiomarkerstouse %>% filter(Centre.Name...Centre == "Nijmegen")
icahnijmegenbiomarkers <- icahnijmegen[,c("Register.ID...Record", "visitnumber", "visitdate", "assessment_id", "ohp17.value", "convertedohpmmoll", "andostenedione.value", "convertedandrostenedionemmoll", "ohp17.valueunits", "andostenedione.valueunits")]
```

they are saying they report nmol/L, so we only want clarification of over the standard thresholds

```{r}
icahnijmegenbiomarkersoverthreshold <- icahnijmegenbiomarkers %>% filter(ohp17.value > 100 | andostenedione.value >8)
icahnijmegenbiomarkersoverthreshold <- icahnijmegenbiomarkersoverthreshold[order(icahnijmegenbiomarkersoverthreshold$andostenedione.value, icahnijmegenbiomarkersoverthreshold$ohp17.value),] 
write.csv(icahnijmegenbiomarkersoverthreshold, "icahnijmegenbiomarkersoverthreshold.csv", row.names = F)
```


**************************

Aarhus

**************************

email has stated they have confidence in figures but mean on a previous calculation from denmark was high

```{r}
library(dplyr)
icahaarhus <- icahalldatawithpreviousunits %>% filter(Centre.Name...Centre == "Aarhus")
icahaarhusbiomarkers <- icahaarhus[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits")]
library(summarytools)
descr(icahaarhusbiomarkers)
```

they are saying they report nmol/L, so we only want clarification of over the standard thresholds

```{r}

icahaarhusbiomarkersoverthreshold <- icahaarhusbiomarkers %>% filter(ohp17.value > 300 | andostenedione.value >20)
icahaarhusbiomarkersoverthreshold <- icahaarhusbiomarkersoverthreshold[order(icahaarhusbiomarkersoverthreshold$andostenedione.value, icahaarhusbiomarkersoverthreshold$ohp17.value),] 
write.csv(icahaarhusbiomarkersoverthreshold, "icahaarhusbiomarkersoverthreshold.csv", row.names = F)

icahaarhusbiomarkersbytient <- icahaarhusbiomarkers %>% filter(Register.ID...Record == 2892)
icahaarhusbiomarkersbytient <- icahalldata %>% filter(Register.ID...Record == 2902)
icahaarhusbiomarkersbytient$andostenedione.value
```


**************************

berlin

**************************

email has stated they have confidence in figures but mean on a previous calculation from denmark was high

```{r}
library(dplyr)
icahberlin <- icahalldatawithpreviousunits %>% filter(Centre.Name...Centre == "Berlin")
icahberlinbiomarkers <- icahberlin[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits")]
library(summarytools)
descr(icahberlinbiomarkers)
```

they are saying they report nmol/L, so we only want clarification of over the standard thresholds

```{r}

icahberlinbiomarkersoverthreshold <- icahberlinbiomarkers %>% filter(ohp17.value > 100 | andostenedione.value >8)
icahberlinbiomarkersoverthreshold <- icahberlinbiomarkersoverthreshold[order(icahberlinbiomarkersoverthreshold$andostenedione.value, icahberlinbiomarkersoverthreshold$ohp17.value),]
icahberlinbiomarkerstoshare <- icahberlinbiomarkers %>% filter(!is.na(ohp17.value))
write.csv(icahberlinbiomarkersoverthreshold, "icahberlinbiomarkersoverthreshold.csv", row.names = F)



write.csv(icahberlinbiomarkerstoshare, "icahberlinbiomarkers.csv", row.names = F)
```


**************************

craiova

**************************

email has stated they have confidence in figures but mean on a previous calculation from denmark was high

```{r}
library(dplyr)
icahcraiova <- icahalldatawithpreviousunits %>% filter(Centre.Name...Centre == "Craiova")
icahcraiovabiomarkers <- icahcraiova[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits")]
library(summarytools)
descr(icahcraiovabiomarkers)
```

they are saying they report nmol/L, so we only want clarification of over the standard thresholds

```{r}

icahcraiovabiomarkersoverthreshold <- icahcraiovabiomarkers %>% filter(ohp17.value > 100 | andostenedione.value >8)
icahcraiovabiomarkersoverthreshold <- icahcraiovabiomarkersoverthreshold[order(icahcraiovabiomarkersoverthreshold$andostenedione.value, icahcraiovabiomarkersoverthreshold$ohp17.value),]
icahcraiovabiomarkerstoshare <- icahcraiovabiomarkers %>% filter(!is.na(ohp17.value))
write.csv(icahcraiovabiomarkersoverthreshold, "icahcraiovabiomarkersoverthreshold.csv", row.names = F)



```



```{r}


icahalldatabackup2669 <- icahalldata
icahalldata <-icahalldatabackup2669


```


**************************

Munich

**************************

don't seem to have gone into my modelling. just to double check they haven't entered any biomarker data

```{r}
library(dplyr)

icahmunich <- icahalldata %>% filter(Centre.Name...Centre == "Munich Technical University")
icahmunichbiomarkers <- icahmunich[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits", "convertedohpmmoll", "ohpconversionfactor", "ohp17valuecorrected")]

library(summarytools)

descr(icahmunichbiomarkers)
descr(icahmunichbiomarkers$ohp17.value)
descr(icahmunichbiomarkers$convertedohpmmoll)
freq(icahmunichbiomarkers$ohpconversionfactor)
descr(icahmunichbiomarkers$ohp17valuecorrected)

```

No - munich does have 17ohp inside the database, it's just in ng/dL and none of them are abnormal

**************************

buenos aeres

**************************

Have had a late response from buenos aeres:

1) What units of 17-OH Progesterone are you entering into the Registry? ng/ml

 2) What units of Androstenedione are you entering into the Registry? ng/dl

 3) Have either of these measurement units changed between January 2000 and January 2021? No

 4) Do you ever enter values for these biomarkers measured in anything other than blood serum (e.g. saliva)? 

We entered values measured only in blood serum.

This needs to be rerun to be included, so the file has been changed to 2021-05-07 to be corrected
 

```{r}
freq(icahalldata$Centre.Name...Centre)
icahbuenos <- icahalldata %>% filter(Centre.Name...Centre == "Buenos Aires")
icahbuenosbiomarkers <- icahbuenos[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits", "convertedohpmmoll", "convertedandrostenedionemmoll", "ohpconversionfactor", "ohp17valuecorrected")]
library(summarytools)

descr(icahbuenosbiomarkers)
descr(icahbuenosbiomarkers$ohp17.value)
descr(icahbuenosbiomarkers$convertedohpmmoll)
descr(icahbuenosbiomarkers$convertedandrostenedionemmoll)
freq(icahbuenosbiomarkers$ohpconversionfactor)
descr(icahbuenosbiomarkers$ohp17valuecorrected)
```


**************************

Istanbul University - do they have any data as sukran has been emailing so much

**************************

```{r}
freq(icahalldata$Centre.Name...Centre)
icahistanbuluniversity <- icahalldata %>% filter(Centre.Name...Centre == "Istanbul University")
icahistanbuluniversitybiomarkers <- icahistanbuluniversity[,c("Register.ID...Record", "visitdate", "assessment_id", "ohp17.value", "andostenedione.value", "ohp17.valueunits", "andostenedione.valueunits", "convertedohpmmoll", "convertedandrostenedionemmoll", "ohpconversionfactor", "ohp17valuecorrected")]
library(summarytools)

descr(icahistanbuluniversitybiomarkers)
descr(icahistanbuluniversitybiomarkers$ohp17.value)
descr(icahistanbuluniversitybiomarkers$andostenedione.value)
descr(icahistanbuluniversitybiomarkers$convertedohpmmoll)
descr(icahistanbuluniversitybiomarkers$convertedandrostenedionemmoll)
freq(icahistanbuluniversitybiomarkers$ohpconversionfactor)
descr(icahistanbuluniversitybiomarkers$ohp17valuecorrected)
```

************************

mann whitney test for ajay

**********************


```{r}
mostrecentohpmale$convertedohpmmoll
mostrecentohpfemale$convertedohpmmoll
wilcox.test(mostrecentohpmale$convertedohpmmoll , mostrecentohpfemale$convertedohpmmoll, paired = F, alternative = "two.sided")
```


************************************

final file

*************************************

Now we have incorporated all centre corrections, we can make that the entire sheet to work with in other files

```{r}
icahalldatabackup5476 <- icahalldata
icahalldata <- icahalldatabackup5476
```

This file now has corrected values all in nmol/l. The file actually has some people removed for being pre diagnosis, so really this file should be rename from icahalldata. It can then be used in multilevel modelling.









```{r}

```


********************

Analysing salt replacement

*********************

We want to get to the stage where we know how many mmol of Na each patient taking salt replacement is on per day. This will require analysis by hand of the Salt.replacement.note...Current.Medication column

Extract the salt replacement data for creation of a spreadsheet

I want a column that tells me there was a note about salt replacement


```{r}
icahalldata$saltreplacementnotepresent <- ifelse(!is.na(icahalldata$Salt.replacement.note...Current.Medication), 1, 0)
icahsalt <- icahalldata[,c("Register.ID...Record","assessment_id", "saltreplacementnotepresent", "Salt.replacement...Current.Medication", "Salt.replacement.note...Current.Medication")]
write.csv(icahsalt, "icahsalt.csv", row.names = F)
```

we can take the following columns and use them in the blood pressure analysis

"fludroentereddose"     "fludrofrequencyperday"   and "fludrocortisoneperbsa"

```{r}
#icahalldata$fludrocortisoneperbsa
```

```{r}
fludrodoseoncedailyforhistogram <- subset(icahalldata, fludrofrequencyperday==1) %>% dplyr::group_by(fludroentereddose) %>%  dplyr::summarise(n=n())
fludrodosetwicedailyforhistogram <- subset(icahalldata, fludrofrequencyperday==2) %>% dplyr::group_by(fludroentereddose) %>%  dplyr::summarise(n=n())
fludrodosethreetimesdailyforhistogram <- subset(icahalldata, fludrofrequencyperday==3) %>% dplyr::group_by(fludroentereddose) %>%  dplyr::summarise(n=n())

histogramoncedaily <- ggplot(data=fludrodoseoncedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of Fludrocortisone Dose per body surface area for patients taking it once a day", 
x="Fludrocortisone Dose per body surface area", 
y="Frequency") + themehist + xlim(0,500) + ylim(0,10)
histogramoncedaily

histogramtwicedaily <- ggplot(data=fludrodosetwicedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of Fludrocortisone Dose per body surface area for patients taking it twice a day", 
x="Fludrocortisone Dose per body surface area", 
y="Frequency") + themehist+ xlim(0,500)+ ylim(0,10)
histogramtwicedaily

histogramoncedaily <- ggplot(data=fludrodoseoncedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of Fludrocortisone Dose per body surface area for patients taking it once a day", 
x="Fludrocortisone Dose per body surface area", 
y="Frequency") + themehist + xlim(0,50) + ylim(0,10)
histogramoncedaily

histogramtwicedaily <- ggplot(data=fludrodosetwicedailyforhistogram, aes(n)) + 
  geom_histogram(bins=200, colour="black"
                 ) + 
  labs(title="Histogram of Fludrocortisone Dose per body surface area for patients taking it twice a day", 
x="Fludrocortisone Dose per body surface area", 
y="Frequency") + themehist+ xlim(0,50)+ ylim(0,10)
histogramtwicedaily

ggsave(filename=paste("histogram.tif"), path="C:/Users/Thinkpad/", plot = histogram, device="tiff",  width=10, height=5.625, compression = "lzw")

icahalldatafludroonceperday <- (subset(icahalldata, fludrofrequencyperday==1))
descr(icahalldatafludroonceperday$fludrocortisoneperbsa)
icahalldatafludrotwiceperday <- (subset(icahalldata, fludrofrequencyperday==2))
descr(icahalldatafludrotwiceperday$fludrocortisoneperbsa)
icahalldatafludrothreetimesperday <- (subset(icahalldata, fludrofrequencyperday==3))
descr(icahalldatafludrothreetimesperday$fludrocortisoneperbsa)
freq(icahalldata$fludrofrequencyperday)
```

In conclusion I think the majority of the twice daily doses are actually total dose. However, I'm sure some of them mean that dose is given twice a day

Will just have to consider excluding anyone who is dosed twice or three times a day from some analysis

```{r}
icahalldatabackup6292 <- icahalldata
icahalldata <- icahalldatabackup6292
```
















************************

analysing previous dose

*************************

we now have previoushydrocortisoneequivalentpercurrentbsa. This now is what we can use to say this is what the patient was taking before they came to clinic, as an equivalent of their current BSA. They have had their biomarkers measured today. 

************************

marking patients treated with anything other than hydrocortisone

*************************

```{r}
icahalldata$medicationotherthanhydrocortisone <- ifelse(icahalldata$medicine=="prednisone" | 
                                                          icahalldata$medicine=="prednisolone" | 
                                                          icahalldata$medicine=="dexamethasone", 1, 0)
icahvisitsotherthanhydrocortisone <- icahalldata %>% filter(medicationotherthanhydrocortisone==1)
nrow(icahvisitsotherthanhydrocortisone)
```

```{r}
nrow(icahalldata)

icahalldatabackup7300 <- icahalldata
```
```{r}
freq(icahalldata$convertedandrostenedionemmoll)
freq(icahalldata$ohp17.value)
descr(icahalldata$Decimal.Age)
look <- icahalldata %>% filter(agetouse<0.3)
freq(look$visitnumber)
freq(look$agetouse)
freq(icahalldata$boneminuschronological)
freq(icahalldata$Bone.age.result..years....Bone.health.and.maturation)
```

********************************************

Redo calculations for resubmission of ESPE abstract

********************************************

Relationship between D4 and age in most recent biomarkers by sex

we can use these frames:

mostrecentandrostenedionemale
mostrecentohpmale

```{r}
nrow(mostrecentandrostenedionemale)

recentmaleandrostenedioneage <- lm(formula = convertedandrostenedionemmoll ~ agetouse, data=mostrecentandrostenedionemale)
summary(recentmaleandrostenedioneage)

recentfemaleandrostenedioneage <- lm(formula = convertedandrostenedionemmoll ~ agetouse, data=mostrecentandrostenedionefemale)
summary(recentfemaleandrostenedioneage)

```

now the patients under and over 12 by sex. I don't report the regression but this is what it would be:

```{r}
recentmaleandrostenedioneage <- lm(formula = convertedandrostenedionemmoll ~ agetouse, data=subset(mostrecentandrostenedionemale, agetouse<12))
summary(recentmaleandrostenedioneage)

recentfemaleandrostenedioneage <- lm(formula = convertedandrostenedionemmoll ~ agetouse, data=subset(mostrecentandrostenedionefemale, agetouse<12))
summary(recentfemaleandrostenedioneage)
```

instead we want summary statistics for those

```{r}
descr(mostrecentandrostenedionemaleunder12$convertedandrostenedionemmoll)
descr(mostrecentandrostenedionemale12andover$convertedandrostenedionemmoll)
descr(mostrecentandrostenedionefemaleunder12$convertedandrostenedionemmoll)
descr(mostrecentandrostenedionefemale12andover$convertedandrostenedionemmoll)
```

then we want the correlation by sex

```{r}
malecorrelation <- lm(data=mostrecentbothbiomarkersmale, convertedohpmmoll ~ convertedandrostenedionemmoll)
summary(malecorrelation)
femalecorrelation <- lm(data=mostrecentbothbiomarkersfemale, convertedohpmmoll ~ convertedandrostenedionemmoll)
summary(femalecorrelation)
```

play with gee

```{r}
install.packages("geepack")
install.packages("MESS")
library(geepack) 
datalistwise <- icahalldata

datalistwise <- datalistwise[!is.na(datalistwise$agetouse),]
datalistwise <- datalistwise[!is.na(datalistwise$heightanalyserzscore),]
datalistwise <- datalistwise[!is.na(datalistwise$previoushydrocortisoneequivalentextrapolatedpercurrentbsa),]

geeModel1<-geeglm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse   , 
                  data=datalistwise, 
                  family=gaussian,
                  id=Register.ID...Record, 
                  corstr="independence")
summary(geeModel1)


```

```{r}
geeModel2<-geeglm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse   , 
                  data=datalistwise, 
                  family=gaussian,
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel2)
geeModel2

library(MESS)
QIC(geeModel1)
QIC(geeModel2)
```


```{r}
#compare this to the linear model

justlinear <- lm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse   , 
                  data=datalistwise)
summary(justlinear)
```

would need to put a parameter in for gamma here:
``{r}
geeModel3<-geeglm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse   , 
                  data=datalistwise, 
                  family=gamma(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel3)

``


```{r}
geeModel4<-geeglm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse + weightanalyserzscore , 
                  data=datalistwise, 
                  family=gaussian(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel4)

```



```{r}

geeModel5<-geeglm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa * agetouse * weightanalyserzscore , 
                  data=datalistwise, 
                  family=gaussian(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel5)
```


```{r}
datalistwiseunder10 <- datalistwise %>% filter(agetouse<10)
geeModel6<-geeglm(heightanalyserzscore ~ 
                  previoushydrocortisoneequivalentextrapolatedpercurrentbsa + 
                    agetouse +
                    I(agetouse^2) , 
                  data=datalistwiseunder10, 
                  family=gaussian(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel6)

datalistwiseunder10$fit <- predict(geeModel6)
ggplot(data=datalistwiseunder10, aes(x=agetouse, y=heightanalyserzscore)) +geom_point() +ylim (-20,10) + geom_line(aes(x=agetouse, y=fit, group=Register.ID...Record, colour=Register.ID...Record))
geeModel6
```

```{r}
datalistwise <- icahalldata

datalistwise <- datalistwise[!is.na(datalistwise$agetouse),]
datalistwise <- datalistwise[!is.na(datalistwise$heightanalyserzscore),]
datalistwise <- datalistwise[!is.na(datalistwise$convertedohpmmoll),]

datalistwiseunder10 <- datalistwise %>% filter(agetouse<10)
geeModel6<-geeglm(heightanalyserzscore ~ 
                  convertedohpmmoll + 
                    agetouse +
                    I(agetouse^2) , 
                  data=datalistwiseunder10, 
                  family=gaussian(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel6)

datalistwiseunder10$fit <- predict(geeModel6)
ggplot(data=datalistwiseunder10, aes(x=agetouse, y=heightanalyserzscore)) +geom_point() +ylim (-20,10) + geom_line(aes(x=agetouse, y=fit, group=Register.ID...Record, colour=Register.ID...Record))

```

```{r}
datalistwise <- icahalldata

datalistwise <- datalistwise[!is.na(datalistwise$agetouse),]
datalistwise <- datalistwise[!is.na(datalistwise$heightanalyserzscore),]
datalistwise <- datalistwise[!is.na(datalistwise$convertedohpmmoll),]
datalistwise <- datalistwise[!is.na(datalistwise$previoushydrocortisoneequivalentpercurrentbsa),]

datalistwiseunder10 <- datalistwise %>% filter(agetouse<10)
geeModel6<-geeglm(heightanalyserzscore ~ 
                  convertedohpmmoll + 
                    previoushydrocortisoneequivalentextrapolatedpercurrentbsa +
                    agetouse +
                    I(agetouse^2) , 
                  data=datalistwiseunder10, 
                  family=gaussian(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel6)
```

```{r}
datalistwise <- icahalldata

datalistwise <- datalistwise[!is.na(datalistwise$agetouse),]
datalistwise <- datalistwise[!is.na(datalistwise$heightanalyserzscore),]
datalistwise <- datalistwise[!is.na(datalistwise$convertedohpmmoll),]
datalistwise <- datalistwise[!is.na(datalistwise$convertedandrostenedionemmoll),]
datalistwise <- datalistwise[!is.na(datalistwise$previoushydrocortisoneequivalentpercurrentbsa),]

datalistwiseunder10 <- datalistwise %>% filter(agetouse<10)
geeModel6<-geeglm(heightanalyserzscore ~ 
                  convertedandrostenedionemmoll +
                    convertedohpmmoll +
                    previoushydrocortisoneequivalentextrapolatedpercurrentbsa +
                    agetouse +
                    I(agetouse^2) +
                    Centre.Name...Centre, 
                  data=datalistwiseunder10, 
                  family=gaussian(),
                  id=Register.ID...Record, 
                  corstr="exchangeable")
summary(geeModel6)
```





How about playing with neural networks

```{r}

```
```{r}
nn <- neuralnet(heightanalyserzscore ~ previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse + weightanalyserzscore,
                data=datalistwiseunder10,
                hidden=2,
                err.fct="sse",
                linear.output=F)
summary(nn)
plot(nn)
datalistwiseunder10$nn <- predict(nn, newdata=datalistwiseunder10)
ggplot(datalistwiseunder10, aes(x=agetouse, y=nn)) + geom_point() + xlim(0,10) + ylim(-1,1)
nn$result.matrix
nn$net.result[[1]]

new.output = compute(nn, covariate=matrix(c(10, 2, 2), byrow=T, ncol=3))
new.output$net.result
```

```{r}
nn <- neuralnet(heightanalyserzscore ~ previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse + weightanalyserzscore,
                data=datalistwiseunder10,
                hidden=2,
                learningrate=0.01,
                algorithm="backprop",
                err.fct="sse",
                linear.output=F)
summary(nn)
plot(nn)
```


```{r}
nn <- neuralnet(heightanalyserzscore ~ previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse + weightanalyserzscore,
                data=datalistwiseunder10,
                hidden=2,
                learningrate=0.1,
                algorithm="backprop",
                err.fct="sse",
                linear.output=F)

summary(nn)
plot(nn)
```


change the learning rate and your loadings change significantly, this is nonsense

```{r}
new.output = compute(nn, covariate=matrix(c(10, 2, 2), byrow=T, ncol=3))
new.output$net.result
```

I don't know what I'm doing with that!

You ccan get a neural net to use everything with a dot

```{r}
nn <- neuralnet(heightanalyserzscore ~ previoushydrocortisoneequivalentextrapolatedpercurrentbsa + agetouse + weightanalyserzscore, datalistwiseunder10, hidden=c(3,3))
```



growth rates package

```{r}
install.packages("growthrates")
library(growthrates)
```

https://cran.r-project.org/web/packages/growthrates/vignettes/Introduction.html

```{r}
library(lattice)
data(bactgrowth)
xyplot(height ~ agetouse|sex+as.factor(Register.ID...Record), data = icahalldata,
       groups = centreanoncode, pch = 16, cex = 0.5)

```


```{r}
library(growthrates)
splitted.data <- multisplit(icahalldata, c("Register.ID...Record", "sex", "centreanoncode"))
dat <- splitted.data[[1]]
fit <- fit_easylinear(dat$agetouse, dat$height)
summary(fit)
coef(fit)
rsquared(fit)
deviance(fit)
plot(fit)
plot(fit, log="y")
fitx <- fit_easylinear(dat$agetouse, dat$height, h = 8, quota = 0.95)
```


```{r}
plot(fit)
lines(fitx, pch = "+", col = "blue")
```

```{r}
p     <- c(y0 = 0.01, mumax = 0.2, K = 0.1)
lower <- c(y0 = 1e-6, mumax = 0,   K = 0)
upper <- c(y0 = 0.05, mumax = 5,   K = 0.5)

fit1 <- fit_growthmodel(FUN = grow_logistic, p = p, dat$agetouse, dat$height,
                        lower = lower, upper = upper)

p     <- c(yi = 0.02, ya = 0.001, kw = 0.1, mumax = 0.2, K = 0.1)
lower <- c(yi = 1e-6, ya = 1e-6, kw = 0,    mumax = 0,   K = 0)
upper <- c(yi = 0.05, ya = 0.05, kw = 10,   mumax = 5,   K = 0.5)

fit2 <- fit_growthmodel(FUN = grow_twostep, p = p, time = dat$agetouse, dat$height,
                        lower = lower, upper = upper)

coef(fit1)
coef(fit2)
```


```{r}
par(mfrow = c(1, 2))
```


```{r}
plot(fit1)
lines(fit2, col = "red")

plot(fit1, log = "y")
lines(fit2, col = "red")
```

the red lines should be overlaid on those - the parameters I have specified are inappropropriate there? because I have simply copy pasted?


k is the asymptote so lets change that:

```{r}
p     <- c(y0 = 50, mumax = 0.2, K = 200)
lower <- c(y0 = 40, mumax = 0,   K = 100)
upper <- c(y0 = 60, mumax = 10,   K = 300)

fit1 <- fit_growthmodel(FUN = grow_logistic, p = p, dat$agetouse, dat$height,
                        lower = lower, upper = upper)

p     <- c(yi = 50, ya = 50, kw = 0.1, mumax = 0.2, K = 200)
lower <- c(yi = 40, ya = 40, kw = 0,    mumax = 0,   K = 100)
upper <- c(yi = 60, ya = 60, kw = 10,   mumax = 10,   K = 300)

fit2 <- fit_growthmodel(FUN = grow_twostep, p = p, time = dat$agetouse, dat$height,
                        lower = lower, upper = upper)

coef(fit1)
coef(fit2)
```


```{r}
par(mfrow = c(1, 2))
```


```{r}
plot(fit1)
lines(fit2, col = "red")

plot(fit1, log = "y")
lines(fit2, col = "red")
```

then the curves appear, so it's all about those parameters that you enter 

let's move on with the code

```{r}
fit3 <- fit_growthmodel(FUN = grow_twostep, p = p, time = dat$agetouse, dat$height,
                        lower = lower, upper = upper, which = c("kw", "mumax", "K"))

summary(fit3)
```

they then fit splines

```{r}
dat <- splitted.data[[2]]
time <- dat$agetouse
y    <- dat$height

## automatic smoothing with cv
res <- fit_spline(time, y)

par(mfrow = c(1, 2))
plot(res, log = "y")
plot(res)
```


now we try to fit across the whole data set. this won't fit splines to people with only a few visits so we have to create a frame with appropriate visit numbers

```{r}
maxpatientvisitnumber <- datatomodel %>% group_by(Register.ID...Record) %>% slice_max(n=1, visitnumber)
patientswithlessthan10visits <- subset(maxpatientvisitnumber, visitnumber<10)
patientswithlessthan10visits <- patientswithlessthan10visits$Register.ID...Record
dataofpatientswith10ormorevisits <- subset(icahalldata, !(Register.ID...Record %in% patientswithlessthan10visits))
```

then it will be able to compute splines
```{r}
datatogrowth <- dataofpatientswith10ormorevisits 
datatogrowth <- datatogrowth[!is.na(datatogrowth$Register.ID...Record),]
datatogrowth <- datatogrowth[!is.na(datatogrowth$agetouse),]
datatogrowth <- datatogrowth[!is.na(datatogrowth$height),]
datatogrowth <- datatogrowth %>% filter (height > 40 & height < 200)
datatogrowth <- datatogrowth %>% filter (Register.ID...Record < 2500)
nrow(datatogrowth)
many_spline_fits <- all_splines(height ~ agetouse | Register.ID...Record,
                                data = datatogrowth)

par(mfrow = c(12, 6))
par(mar = c(2.5, 4, 2, 1))
plot(many_spline_fits)
```

classic example of overfitting there!

Then they fit a baranyi model

p     <- c(y0 = 50, mumax = 0.2, K = 200)
lower <- c(y0 = 40, mumax = 0,   K = 100)
upper <- c(y0 = 60, mumax = 10,   K = 300)

```{r}
## initial parameters and box constraints
p   <- c(y0 = 40,       mumax = 0.2, K = 200, h0 = 1)


lower   <- c(y0 = 30,   mumax = 0, K = 100, h0 = 0)
upper   <- c(y0 = 60,   mumax = 10,    K = 300,   h0 = 10)

## fit growth models to all data using log transformed residuals
many_baranyi1 <- all_growthmodels(
                   height ~ grow_baranyi(agetouse, parms) | Register.ID...Record,
                   data = datatogrowth,
                   p = p, lower = lower, upper = upper,
                   transform = "log", ncores = 2)
```

This is bound to be a problem with my parameters







```{r}
icahalldata <- icahalldatabackup7300

icahalldata$lagagetouse <- lag(icahalldata$agetouse)
icahalldata$lagagetouse <- ifelse(icahalldata$visitnumber==1, NA, icahalldata$lagagetouse)
icahalldata$timebetweenvisits <- icahalldata$agetouse - icahalldata$lagagetouse

head(icahalldata$timebetweenvisits)

icahalldata$lagweightanalyserzscore <- lag(icahalldata$weightanalyserzscore)

icahalldatabackup7300 <- icahalldata
```


```{r}
weightdynamic <- lmer(weightanalyserzscore ~ 
                        lagweightanalyserzscore + 
                        timebetweenvisits *
                       agetouse +  
                      (1 | Register.ID...Record) +
                      (1 | Centre.Name...Centre) ,
                      data= icahalldata, REML=T)
summary(weightdynamic)
plot(weightdynamic)
rsquared(weightdynamic)
icahalldata$fit <- predict(weightdynamic)
```



